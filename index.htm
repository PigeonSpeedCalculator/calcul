<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<title>ELMAKKAOUY FLIGHT AI PRO v2</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<style>
    :root { --primary: #00d4ff; --bg: #0f172a; --card: #1e293b; --text: #f8fafc; }
    body { margin: 0; background: var(--bg); color: var(--text); font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
    #map { height: 450px; width: 100%; border-bottom: 3px solid var(--primary); }
    .container { padding: 20px; max-width: 900px; margin: auto; }
    .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px; }
    .panel { background: var(--card); padding: 20px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.3); }
    input, button { 
        width: 100%; padding: 12px; margin-top: 10px; border-radius: 8px; 
        border: 1px solid #334155; background: #0f172a; color: white; box-sizing: border-box;
    }
    button { background: var(--primary); color: #000; font-weight: bold; cursor: pointer; border: none; transition: 0.3s; }
    button:hover { background: #00b8e6; transform: translateY(-2px); }
    .stats-bar { display: flex; justify-content: space-around; background: var(--card); padding: 15px; border-radius: 12px; margin-top: -30px; position: relative; z-index: 1000; width: 90%; margin-left: auto; margin-right: auto; }
    .stat-item { text-align: center; }
    .stat-item b { display: block; color: var(--primary); font-size: 1.2em; }
    #suggestions { background: var(--card); border: 1px solid var(--primary); position: absolute; z-index: 2000; width: 100%; max-height: 200px; overflow-y: auto; border-radius: 8px; display: none; }
    .sug { padding: 10px; cursor: pointer; border-bottom: 1px solid #334155; }
    .sug:hover { background: var(--primary); color: black; }
    table { width: 100%; margin-top: 20px; border-collapse: collapse; background: var(--card); border-radius: 8px; overflow: hidden; }
    th, td { padding: 12px; text-align: center; border-bottom: 1px solid #334155; }
    th { background: #334155; color: var(--primary); }
    #bird { font-size: 30px; filter: drop-shadow(0 0 5px rgba(0,212,255,0.8)); }
</style>
</head>
<body>

<div id="map"></div>

<div class="stats-bar">
    <div class="stat-item">ğŸ“ Ø§Ù„Ù…Ø³Ø§ÙØ©<b id="dist">0 Km</b></div>
    <div class="stat-item">ğŸš€ Ø§Ù„Ø³Ø±Ø¹Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©<b id="speed">0 m/m</b></div>
    <div class="stat-item">ğŸŒ¬ï¸ Ø§Ù„Ø±ÙŠØ§Ø­<b id="windStat">0 m/m</b></div>
</div>

<div class="container">
    <div class="grid">
        <div class="panel">
            <h3>ğŸ“ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø³Ø¨Ø§Ù‚</h3>
            <label>ÙˆÙ‚Øª Ø§Ù„Ø¥Ø·Ù„Ø§Ù‚:</label>
            <input type="datetime-local" id="startTime">
            <input id="startCoord" placeholder="Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª Ø§Ù„Ø¥Ø·Ù„Ø§Ù‚" value="33.5731,-7.5898">
            <div style="position:relative">
                <input id="city" placeholder="Ø§Ø¨Ø­Ø« Ø¹Ù† Ù…Ø¯ÙŠÙ†Ø© Ø§Ù„ÙˆØµÙˆÙ„..." oninput="searchCity(this.value)">
                <div id="suggestions"></div>
            </div>
            <button onclick="startFlight()">Ù…Ø­Ø§ÙƒØ§Ø© Ø§Ù„Ø·ÙŠØ±Ø§Ù† ğŸ•Šï¸</button>
        </div>

        <div class="panel">
            <h3>ğŸ† ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù…ØªØ³Ø§Ø¨Ù‚ÙŠÙ†</h3>
            <input id="rName" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…ØªØ³Ø§Ø¨Ù‚">
            <input id="rDist" type="number" placeholder="Ø§Ù„Ù…Ø³Ø§ÙØ© Ø§Ù„Ù…Ù‚Ø·ÙˆØ¹Ø© (Km)">
            <label>ÙˆÙ‚Øª Ø§Ù„ÙˆØµÙˆÙ„:</label>
            <input id="rTime" type="time">
            <button onclick="addRacer()" style="background:#22c55e">Ø¥Ø¶Ø§ÙØ© Ù„Ù„ØªØ±ØªÙŠØ¨</button>
        </div>
    </div>

    <div class="panel">
        <h3>ğŸ“Š Ø¬Ø¯ÙˆÙ„ Ø§Ù„ØªØ±ØªÙŠØ¨ ÙˆØ§Ù„Ø³Ø±Ø¹Ø©</h3>
        <table>
            <thead>
                <tr>
                    <th>Ø§Ù„Ø±ØªØ¨Ø©</th>
                    <th>Ø§Ù„Ø§Ø³Ù…</th>
                    <th>Ø§Ù„Ù…Ø³Ø§ÙØ©</th>
                    <th>Ø§Ù„Ø³Ø±Ø¹Ø© (Ù…/Ø¯)</th>
                </tr>
            </thead>
            <tbody id="results"></tbody>
        </table>
    </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
let map = L.map('map').setView([33.5, -7.5], 6);
L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png').addTo(map);

let pigeon, routeLine, anim, endPoint;
const AIR_SPEED = 1100; // Ø³Ø±Ø¹Ø© Ø§Ù„Ø­Ù…Ø§Ù… Ø§Ù„Ù…ØªÙˆØ³Ø·Ø© 1100 Ù…ØªØ± ÙÙŠ Ø§Ù„Ø¯Ù‚ÙŠÙ‚Ø©

// ØªØµØ­ÙŠØ­ Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ù…Ø¯Ù†
async function searchCity(q) {
    const sugBox = document.getElementById('suggestions');
    if(q.length < 3) { sugBox.style.display = 'none'; return; }
    try {
        const r = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${q}&limit=5`);
        const d = await r.json();
        if(d.length > 0) {
            sugBox.style.display = 'block';
            sugBox.innerHTML = d.map(x => `
                <div class="sug" onclick="pickCity(${x.lat},${x.lon},'${x.display_name}')">
                    ${x.display_name}
                </div>`).join('');
        }
    } catch(e) { console.error("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¨Ø­Ø«"); }
}

function pickCity(lat, lon, name) {
    document.getElementById('city').value = name.split(',')[0];
    document.getElementById('suggestions').style.display = 'none';
    endPoint = L.latLng(lat, lon);
}

// Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø³Ø§ÙØ© (Haversine)
function getDist(lat1, lon1, lat2, lon2) {
    const R = 6371000;
    const dLat = (lat2-lat1)*Math.PI/180;
    const dLon = (lon2-lon1)*Math.PI/180;
    const a = Math.sin(dLat/2)**2 + Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*Math.sin(dLon/2)**2;
    return 2 * R * Math.asin(Math.sqrt(a));
}

async function startFlight() {
    if(!endPoint) return alert("Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± Ù…Ø¯ÙŠÙ†Ø© Ø§Ù„ÙˆØµÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹");
    cancelAnimationFrame(anim);
    
    const s = document.getElementById('startCoord').value.split(',');
    const startPoint = L.latLng(+s[0], +s[1]);
    const totalD = getDist(startPoint.lat, startPoint.lng, endPoint.lat, endPoint.lng);
    document.getElementById('dist').innerText = (totalD/1000).toFixed(2) + " Km";

    if(routeLine) map.removeLayer(routeLine);
    routeLine = L.polyline([startPoint, endPoint], {color: '#00d4ff', weight: 2, dashArray: '5, 10'}).addTo(map);
    
    if(pigeon) map.removeLayer(pigeon);
    pigeon = L.marker(startPoint, {
        icon: L.divIcon({html: `<div id="bird">ğŸ•Šï¸</div>`, className: ''})
    }).addTo(map);

    map.fitBounds(routeLine.getBounds(), {padding: [50, 50]});

    // Ø¬Ù„Ø¨ Ø§Ù„Ø±ÙŠØ§Ø­
    const res = await fetch(`https://api.openweathermap.org/data/2.5/weather?lat=${startPoint.lat}&lon=${startPoint.lng}&appid=992e2b79f5e3386bda09d14ff4807f9d`);
    const data = await res.json();
    const wind = { speed: (data.wind.speed || 0) * 60, deg: data.wind.deg || 0 };
    document.getElementById('windStat').innerText = wind.speed.toFixed(0) + " m/m";

    let cur = {lat: startPoint.lat, lng: startPoint.lng};
    let lastTime = performance.now();

    function frame(now) {
        let dt = (now - lastTime) / 60000; // Ø¨Ø§Ù„Ø¯Ù‚Ø§Ø¦Ù‚
        lastTime = now;

        // Ù…Ù†Ø·Ù‚ Ø§Ù„Ø±ÙŠØ§Ø­: Ø§Ù„Ø­Ù…Ø§Ù… ÙŠØªØ£Ø«Ø± Ø¨Ø§Ù„Ø±ÙŠØ§Ø­ ÙˆÙ„ÙƒÙ†Ù‡ ÙŠØµØ­Ø­ Ù…Ø³Ø§Ø±Ù‡
        let angleToTarget = Math.atan2(endPoint.lat - cur.lat, endPoint.lng - cur.lng);
        let windAngle = wind.deg * Math.PI / 180;
        
        // ØªØ£Ø«ÙŠØ± Ø§Ù„Ø±ÙŠØ§Ø­ (Ø§Ù„Ø­Ù…Ø§Ù… ÙŠØ­Ø§ÙˆÙ„ ØªØ¬Ù†Ø¨ Ø§Ù„ØªÙŠØ§Ø±Ø§Øª Ø§Ù„Ù‚ÙˆÙŠØ©)
        let drift = (wind.speed / AIR_SPEED) * 0.2; 
        let moveX = Math.cos(angleToTarget) + Math.cos(windAngle) * drift;
        let moveY = Math.sin(angleToTarget) + Math.sin(windAngle) * drift;
        
        let groundSpeed = AIR_SPEED + (Math.cos(windAngle - angleToTarget) * wind.speed);
        document.getElementById('speed').innerText = groundSpeed.toFixed(0) + " m/m";

        let step = (groundSpeed * dt) / totalD;
        cur.lat += (endPoint.lat - startPoint.lat) * step;
        cur.lng += (endPoint.lng - startPoint.lng) * step;

        pigeon.setLatLng([cur.lat, cur.lng]);

        if(getDist(cur.lat, cur.lng, endPoint.lat, endPoint.lng) < 100) {
            document.getElementById('speed').innerText = "ÙˆØµÙ„ Ø¨Ø³Ù„Ø§Ù… âœ”";
            return;
        }
        anim = requestAnimationFrame(frame);
    }
    anim = requestAnimationFrame(frame);
}

// Ø­Ø³Ø§Ø¨ ØªØ±ØªÙŠØ¨ Ø§Ù„Ù…ØªØ³Ø§Ø¨Ù‚ÙŠÙ†
let racers = [];
function addRacer() {
    const name = document.getElementById('rName').value;
    const dKm = parseFloat(document.getElementById('rDist').value);
    const arrT = document.getElementById('rTime').value;
    const startT = document.getElementById('startTime').value;

    if(!name || !dKm || !arrT || !startT) return alert("Ø£ÙƒÙ…Ù„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (Ø¨Ù…Ø§ ÙÙŠ Ø°Ù„Ùƒ ÙˆÙ‚Øª Ø§Ù„Ø¥Ø·Ù„Ø§Ù‚)");

    let startTime = new Date(startT);
    let arrivalTime = new Date(startT.split('T')[0] + 'T' + arrT);
    
    if (arrivalTime < startTime) arrivalTime.setDate(arrivalTime.getDate() + 1);

    let durationMin = (arrivalTime - startTime) / 60000;
    let speed = (dKm * 1000) / durationMin;

    racers.push({ name, dKm, speed });
    racers.sort((a, b) => b.speed - a.speed);

    document.getElementById('results').innerHTML = racers.map((r, i) => `
        <tr>
            <td>${i+1}</td>
            <td>${r.name}</td>
            <td>${r.dKm} Km</td>
            <td style="color:#00ff88; font-weight:bold">${r.speed.toFixed(2)}</td>
        </tr>
    `).join('');
}
</script>
</body>
</html>

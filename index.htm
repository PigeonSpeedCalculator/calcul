<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8">
<title>REAL FLIGHT ENGINE</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<style>
body{margin:0;background:#0f172a;color:white;font-family:Arial}
#map{height:420px}
.panel{padding:15px;background:#111827}

input,button{
width:100%;padding:10px;margin-top:8px;
background:#0b1220;border:1px solid #1f2937;
color:white;border-radius:6px
}
button{background:#00d4ff;color:black;font-weight:bold}

.stat{margin:6px 0}
.stat b{color:#00ff88}

/* Ø¥Ø²Ø§Ù„Ø© Ø£ÙŠ Ø®Ù„ÙÙŠØ© */
.leaflet-div-icon{
background:transparent!important;
border:none!important;
}

/* Ø¬Ù†Ø§Ø­ÙŠÙ† */
.wing{
display:inline-block;
font-size:28px;
animation:flap 0.35s infinite ease-in-out alternate;
}

@keyframes flap{
from{transform:scaleY(1)}
to{transform:scaleY(0.6)}
}

#birdWrap{
display:flex;
align-items:center;
justify-content:center;
}
</style>
</head>

<body>

<div id="map"></div>

<div class="panel">
<input type="datetime-local" id="startTime">
<input id="startCoord" value="33.421265,-7.812173">
<input id="city" value="kenitra">
<button onclick="startFlight()">Ø¨Ø¯Ø¡ Ø§Ù„ØªØªØ¨Ø¹ ğŸ•Šï¸</button>

<hr>

<div class="stat">Ø§Ù„Ù…Ø³Ø§ÙØ©: <b id="dist">--</b> Km</div>
<div class="stat">Ø§Ù„Ø³Ø±Ø¹Ø©: <b id="speed">--</b> m/min</div>
<div class="stat">Ø§Ù„Ø±ÙŠØ§Ø­: <b id="wind">--</b> m/min</div>
</div>

<script>

let map = L.map('map').setView([33.4,-7.8],7);
L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png').addTo(map);

let pigeon, routeLine, timer;
let startPoint, endPoint;
let totalDistance=0;

const AIR_SPEED=1200;

function rad(x){return x*Math.PI/180}
function deg(x){return x*180/Math.PI}

function haversine(a,b,c,d){
const R=6371000;
const dLat=rad(c-a);
const dLon=rad(d-b);
const x=Math.sin(dLat/2)**2+
Math.cos(rad(a))*Math.cos(rad(c))*Math.sin(dLon/2)**2;
return 2*R*Math.asin(Math.sqrt(x));
}

function bearing(a,b,c,d){
const y=Math.sin(rad(d-b))*Math.cos(rad(c));
const x=Math.cos(rad(a))*Math.sin(rad(c))-
Math.sin(rad(a))*Math.cos(rad(c))*Math.cos(rad(d-b));
return (deg(Math.atan2(y,x))+360)%360;
}

async function getCoords(name){
const r=await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${name}&limit=1`);
const d=await r.json();
if(!d.length){alert("Ø§Ù„Ù…Ø¯ÙŠÙ†Ø© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©");return null;}
return [parseFloat(d[0].lat),parseFloat(d[0].lon)];
}

async function getWind(lat,lon){
try{
const r=await fetch(`https://api.openweathermap.org/data/2.5/weather?lat=${lat}&lon=${lon}&appid=992e2b79f5e3386bda09d14ff4807f9d`);
const d=await r.json();
return{
speed:(d.wind?.speed||0)*60,
deg:d.wind?.deg||0
};
}catch{
return{speed:0,deg:0};
}
}

async function startFlight(){

if(timer) clearInterval(timer);
if(!startTime.value) return alert("Ø­Ø¯Ø¯ ÙˆÙ‚Øª Ø§Ù„Ø§Ù†Ø·Ù„Ø§Ù‚");

const s=startCoord.value.split(',');
startPoint=L.latLng(+s[0],+s[1]);

const coords=await getCoords(city.value);
if(!coords) return;

endPoint=L.latLng(coords[0],coords[1]);

totalDistance=haversine(startPoint.lat,startPoint.lng,endPoint.lat,endPoint.lng);
dist.innerText=(totalDistance/1000).toFixed(3);

if(routeLine) map.removeLayer(routeLine);
routeLine=L.polyline([startPoint,endPoint],{color:'#00ffff'}).addTo(map);

if(pigeon) map.removeLayer(pigeon);

pigeon=L.marker(startPoint,{
icon:L.divIcon({
html:`<div id="birdWrap">ğŸ•Šï¸</div>`,
iconSize:[30,30]
})
}).addTo(map);

const wind=await getWind(startPoint.lat,startPoint.lng);
document.getElementById("wind").innerText=wind.speed.toFixed(1);

const routeBearing=bearing(startPoint.lat,startPoint.lng,endPoint.lat,endPoint.lng);

const startMoment=new Date(startTime.value).getTime();

timer=setInterval(()=>{

const elapsed=(Date.now()-startMoment)/60000;
if(elapsed<0) return;

const rel=rad(wind.deg-routeBearing);

const windX=wind.speed*Math.cos(rel);
const windY=wind.speed*Math.sin(rel);

const groundSpeed=Math.sqrt((AIR_SPEED+windX)**2+windY**2);
document.getElementById("speed").innerText=groundSpeed.toFixed(1);

const traveled=groundSpeed*elapsed;
const p=traveled/totalDistance;

if(p>=1){
pigeon.setLatLng(endPoint);
clearInterval(timer);
document.getElementById("speed").innerText="ÙˆØµÙ„ âœ”";
return;
}

const lat=startPoint.lat+(endPoint.lat-startPoint.lat)*p;
const lng=startPoint.lng+(endPoint.lng-startPoint.lng)*p;

pigeon.setLatLng([lat,lng]);

/* ØªØ¯ÙˆÙŠØ± Ø¨Ø§ØªØ¬Ø§Ù‡ Ø§Ù„Ù…Ø³Ø§Ø± */
const wrap=document.getElementById("birdWrap");
if(wrap){
wrap.style.transform=`rotate(${routeBearing}deg)`;
}

},50);

}

</script>

</body>
</html>

<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8">
<title>Professional Pigeon Race Simulator</title>

<link rel="stylesheet"
href="https://unpkg.com/leaflet/dist/leaflet.css"/>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<style>
body{
    margin:0;
    background:#0b1220;
    color:#e0e6ff;
    font-family:tahoma;
}
#map{height:65vh;}
.panel{
    padding:12px;
    background:#111a2f;
    display:grid;
    grid-template-columns:repeat(3,1fr);
    gap:10px;
}
input,button{
    padding:6px;
    background:#1c2745;
    color:white;
    border:none;
}
button{
    background:#0ea5e9;
    cursor:pointer;
}
.stats{
    padding:12px;
    background:#0f172a;
}
</style>
</head>

<body>

<div id="map"></div>

<div class="panel">
<input id="startLat" placeholder="Lat">
<input id="startLng" placeholder="Lng">
<input id="destCity" placeholder="مدينة الوصول">

<input type="datetime-local" id="startTime">

<button onclick="startRace()">بدء السباق</button>
</div>

<div class="stats" id="stats"></div>

<script>

//================= MAP =================//

const map = L.map('map').setView([33.5,-7.6],7);

L.tileLayer(
'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png'
).addTo(map);

//================= CONSTANTS =================//

const R = 6371000;
const MASS = 0.4;
const Cd = 0.9;
const AREA = 0.05;
const BASE_THRUST = 6;

let pigeons = [];
let weather = {speed:0,deg:0,humidity:50};

let raceData=null;

//================= UTILS =================//

const toRad = d=>d*Math.PI/180;
const toDeg = r=>r*180/Math.PI;

function haversine(a,b){
    const φ1=toRad(a.lat), φ2=toRad(b.lat);
    const Δφ=φ2-φ1;
    const Δλ=toRad(b.lng-a.lng);

    const h =
        Math.sin(Δφ/2)**2 +
        Math.cos(φ1)*Math.cos(φ2)*
        Math.sin(Δλ/2)**2;

    return 2*R*Math.asin(Math.sqrt(h));
}

function bearing(a,b){
    const φ1=toRad(a.lat);
    const φ2=toRad(b.lat);
    const Δλ=toRad(b.lng-a.lng);

    const y=Math.sin(Δλ)*Math.cos(φ2);
    const x=Math.cos(φ1)*Math.sin(φ2)-
            Math.sin(φ1)*Math.cos(φ2)*Math.cos(Δλ);

    return (toDeg(Math.atan2(y,x))+360)%360;
}

function move(lat,lng,brg,dist){
    const δ=dist/R;
    const θ=toRad(brg);

    const φ1=toRad(lat);
    const λ1=toRad(lng);

    const φ2=Math.asin(
        Math.sin(φ1)*Math.cos(δ)+
        Math.cos(φ1)*Math.sin(δ)*Math.cos(θ)
    );

    const λ2=λ1+Math.atan2(
        Math.sin(θ)*Math.sin(δ)*Math.cos(φ1),
        Math.cos(δ)-Math.sin(φ1)*Math.sin(φ2)
    );

    return {lat:toDeg(φ2),lng:toDeg(λ2)};
}

//================= WEATHER =================//

async function loadWeather(lat,lng){

const key="YOUR_API_KEY";

const r = await fetch(
`https://api.openweathermap.org/data/2.5/weather?lat=${lat}&lon=${lng}&appid=${key}&units=metric`
);

const d = await r.json();

weather.speed = d.wind.speed;
weather.deg = d.wind.deg;
weather.humidity = d.main.humidity;
}

//================= PIGEON CLASS =================//

class Pigeon{

constructor(start,end){

this.pos={...start};
this.end=end;
this.vel=18;
this.energy=100;
this.marker=L.circleMarker(
[start.lat,start.lng],
{radius:6,color:'cyan'}
).addTo(map);

this.trail=L.polyline(
[[start.lat,start.lng]],
{color:'yellow'}
).addTo(map);

}

update(dt){

const dist=haversine(this.pos,this.end);
if(dist<20) return false;

const brg=bearing(this.pos,this.end);

const airDensity=
1.225*(1-weather.humidity/200);

const drag=
0.5*airDensity*Cd*AREA*
(this.vel*this.vel);

const accel=
(BASE_THRUST-drag)/MASS;

this.vel+=accel*dt;

if(this.vel<10) this.vel=10;
if(this.vel>28) this.vel=28;

const windEffect=
weather.speed*Math.cos(
toRad(weather.deg-brg)
);

const groundSpeed=
this.vel+windEffect;

const step=
groundSpeed*dt;

this.pos=
move(this.pos.lat,this.pos.lng,
brg,step);

this.marker.setLatLng(
[this.pos.lat,this.pos.lng]
);

this.trail.addLatLng(
[this.pos.lat,this.pos.lng]
);

this.energy-=0.01*dt;

return true;
}

}

//================= RACE =================//

async function startRace(){

const lat=parseFloat(
document.getElementById("startLat").value);

const lng=parseFloat(
document.getElementById("startLng").value);

const city=
document.getElementById("destCity").value;

const startTime=
new Date(
document.getElementById("startTime").value
).getTime();

if(!lat||!lng||!city) return;

const geo=
await fetch(
`https://nominatim.openstreetmap.org/search?format=json&q=${city}`
);

const res=await geo.json();

const end={
lat:parseFloat(res[0].lat),
lng:parseFloat(res[0].lon)
};

await loadWeather(lat,lng);

raceData={
start:{lat,lng},
end,
startTime
};

localStorage.setItem(
"raceData",
JSON.stringify(raceData)
);

pigeons=[
new Pigeon(raceData.start,raceData.end)
];

requestAnimationFrame(loop);
}

//================= LOOP =================//

let last=performance.now();

function loop(now){

const dt=(now-last)/1000;
last=now;

if(!raceData){
requestAnimationFrame(loop);
return;
}

const elapsed=
(Date.now()-raceData.startTime)/1000;

if(elapsed<0){
requestAnimationFrame(loop);
return;
}

let active=false;

for(let p of pigeons){
if(p.update(dt)) active=true;
}

updateStats();

if(active) requestAnimationFrame(loop);
}

//================= STATS =================//

function updateStats(){

const p=pigeons[0];

const remain=
(haversine(p.pos,p.end)/1000)
.toFixed(2);

document.getElementById("stats")
.innerHTML=
`
المسافة المتبقية: ${remain} Km<br>
السرعة الأرضية: ${p.vel.toFixed(2)} m/s<br>
طاقة متبقية: ${p.energy.toFixed(1)} %<br>
الرياح: ${weather.speed} m/s<br>
اتجاه الرياح: ${weather.deg}°<br>
الرطوبة: ${weather.humidity} %
`;
}

//================= RESTORE =================//

window.onload=()=>{

const saved=
localStorage.getItem("raceData");

if(saved){
raceData=JSON.parse(saved);
pigeons=[
new Pigeon(raceData.start,
raceData.end)
];
requestAnimationFrame(loop);
}
};

</script>
</body>
</html>

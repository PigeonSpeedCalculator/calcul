<!DOCTYPE html>
<html lang="en" dir="ltr" id="html-tag">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Pigeon Speed Expert - BY ELMAKKAOUY</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    
    <style>
        :root { --primary: #2563eb; --success: #16a34a; --bg: #f8fafc; --card: #ffffff; }
        body { margin: 0; background: var(--bg); font-family: sans-serif; }
        .app-header { position: sticky; top: 0; z-index: 1000; background: var(--card); padding: 12px; border-bottom: 3px solid var(--primary); box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .header-top { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .container { max-width: 500px; margin: 0 auto; padding: 15px; }
        .card { background: var(--card); border-radius: 15px; padding: 15px; margin-bottom: 15px; border: 1px solid #ddd; }
        
        /* ÿ™ÿµŸÖŸäŸÖ ÿ≠ŸÇŸàŸÑ ÿßŸÑŸàŸÇÿ™ ÿßŸÑŸäÿØŸàŸä */
        .time-manual-group { display: flex; gap: 5px; align-items: center; direction: ltr; }
        .time-manual-group input { text-align: center; padding: 10px 5px; font-weight: bold; width: 60px; border: 1px solid #cbd5e0; border-radius: 8px; }
        .date-input { flex-grow: 1; min-width: 120px; }
        
        input[type="text"], input[type="number"], input[type="date"] { padding: 12px; border: 1px solid #cbd5e0; border-radius: 8px; box-sizing: border-box; font-size: 15px; width: 100%; }
        
        .racer-card { border-left: 5px solid var(--primary); position: relative; }
        .btn-add-p { width: 100%; background: #eff6ff; color: var(--primary); border: 2px dashed var(--primary); padding: 10px; border-radius: 10px; font-weight: bold; margin-top: 10px; }
        .btn-calc { background: var(--success); color: #fff; border: none; padding: 10px 20px; border-radius: 25px; font-weight: bold; }
        .res-table { background: #fff; border-radius: 15px; border: 1px solid #ddd; margin-top: 20px; overflow: hidden; }
        .res-row { display: flex; justify-content: space-between; padding: 15px; border-bottom: 1px solid #eee; }
        .copyright { text-align: center; padding: 15px; color: #ccc; font-weight: bold; letter-spacing: 3px; font-size: 12px; }
    </style>
</head>
<body>

<header class="app-header">
    <div class="header-top">
        <div style="font-weight: bold; color: var(--primary);">ELMAKKAOUY PRO</div>
        <select onchange="changeLang(this.value)" style="padding: 5px; border-radius: 5px;">
            <option value="en">EN</option>
            <option value="ar">AR</option>
        </select>
        <button class="btn-calc" onclick="calculate()">Calculate üèÜ</button>
    </div>
    <input type="text" id="searchBox" onkeyup="filter()" placeholder="Search...">
</header>

<div class="container">
    <div class="card">
        <label style="font-size: 12px; font-weight: bold;">üìÑ Upload PDF</label>
        <input type="file" id="pdfInput" accept=".pdf" style="margin-bottom: 10px;">
        
        <label style="font-size: 12px; font-weight: bold;">üèÅ Release Date & Time</label>
        <div class="time-manual-group" id="releaseTimeGroup">
            <input type="date" class="date-val" id="relDate">
            <input type="number" class="hh" placeholder="HH" value="00" min="0" max="23"> :
            <input type="number" class="mm" placeholder="MM" value="00" min="0" max="59"> :
            <input type="number" class="ss" placeholder="SS" value="00" min="0" max="59">
        </div>
        
        <button class="btn-add-p" style="background: var(--primary); color: white; border: none;" onclick="addManual()">+ Add Manual Racer</button>
    </div>

    <div id="racersList"></div>

    <div id="resultArea" style="display:none;">
        <div id="capture" class="res-table">
            <div style="background: var(--primary); color: #fff; text-align: center; padding: 10px;">Official Results</div>
            <div id="rankings"></div>
            <div class="copyright">BY ELMAKKAOUY</div>
        </div>
        <button onclick="saveImg()" style="width: 100%; padding: 15px; background: #333; color: #fff; border: none; border-radius: 10px; margin-top: 10px; font-weight: bold;">Save as Image üì∏</button>
    </div>
</div>

<script>
    let racers = [];

    // ÿ∂ÿ®ÿ∑ ÿßŸÑÿ™ÿßÿ±ŸäÿÆ ÿßŸÑÿ™ŸÑŸÇÿßÿ¶Ÿä ÿßŸÑŸäŸàŸÖ
    window.onload = () => {
        document.getElementById('relDate').value = new Date().toISOString().split('T')[0];
    };

    function addManual() {
        racers.unshift({ name: "", dist: "", manual: true });
        render();
    }

    function render() {
        const container = document.getElementById('racersList');
        const today = new Date().toISOString().split('T')[0];
        container.innerHTML = racers.map((r, i) => `
            <div class="card racer-card" data-search="${r.name.toLowerCase()}">
                <div style="margin-bottom:10px;">
                    ${r.manual ? 
                        `<input type="text" placeholder="Racer Name" oninput="racers[${i}].name=this.value" style="margin-bottom:5px;">
                         <input type="number" placeholder="Distance Km" oninput="racers[${i}].dist=this.value">` 
                        : `<b>${r.name}</b> <b style="float:right; color:var(--primary)">${r.dist} Km</b>`}
                </div>
                <div id="times-${i}">
                    <div class="time-manual-group" style="margin-bottom:5px;">
                        <input type="date" class="date-in-${i}" value="${today}">
                        <input type="number" class="hh-${i}" placeholder="HH" value="00"> :
                        <input type="number" class="mm-${i}" placeholder="MM" value="00"> :
                        <input type="number" class="ss-${i}" placeholder="SS" value="00">
                    </div>
                </div>
                <button class="btn-add-p" onclick="addPigeon(${i})">+ Extra Pigeon</button>
            </div>
        `).join('');
    }

    function addPigeon(i) {
        const div = document.createElement('div');
        div.className = 'time-manual-group';
        div.style.marginTop = "5px";
        div.innerHTML = `
            <input type="date" class="date-in-${i}" value="${new Date().toISOString().split('T')[0]}">
            <input type="number" class="hh-${i}" value="00"> :
            <input type="number" class="mm-${i}" value="00"> :
            <input type="number" class="ss-${i}" value="00">
            <button onclick="this.parentElement.remove()" style="border:none; background:none; color:red;">√ó</button>
        `;
        document.getElementById(`times-${i}`).appendChild(div);
    }

    function calculate() {
        const relD = document.getElementById('relDate').value;
        const relH = document.getElementById('releaseTimeGroup').querySelector('.hh').value;
        const relM = document.getElementById('releaseTimeGroup').querySelector('.mm').value;
        const relS = document.getElementById('releaseTimeGroup').querySelector('.ss').value;
        
        const release = new Date(`${relD}T${pad(relH)}:${pad(relM)}:${pad(relS)}`);
        let results = [];

        racers.forEach((r, i) => {
            const dates = document.querySelectorAll(`.date-in-${i}`);
            const hhs = document.querySelectorAll(`.hh-${i}`);
            const mms = document.querySelectorAll(`.mm-${i}`);
            const sss = document.querySelectorAll(`.ss-${i}`);

            dates.forEach((d, idx) => {
                const arrival = new Date(`${d.value}T${pad(hhs[idx].value)}:${pad(mms[idx].value)}:${pad(sss[idx].value)}`);
                let diff = (arrival - release) / 1000;
                if (diff > 0) {
                    diff -= getDeadTime(release, arrival);
                    let speed = (parseFloat(r.dist) * 1000) / (diff / 60);
                    results.push({ name: r.name, dist: r.dist, speed, time: `${pad(hhs[idx].value)}:${pad(mms[idx].value)}:${pad(sss[idx].value)}` });
                }
            });
        });

        results.sort((a, b) => b.speed - a.speed);
        showResults(results);
    }

    function pad(n) { return String(n).padStart(2, '0'); }

    function getDeadTime(s, e) {
        let total = 0;
        let cur = new Date(s); cur.setHours(0,0,0,0);
        while (cur <= e) {
            let nS = new Date(cur); nS.setHours(20, 30, 0); // ÿßŸÑŸàŸÇÿ™ ÿßŸÑŸÖŸäÿ™ Ÿäÿ®ÿØÿ£ 20:30
            let mE = new Date(cur); mE.setDate(mE.getDate()+1); mE.setHours(6, 0, 0); // ŸäŸÜÿ™ŸáŸä 06:00
            let oS = new Date(Math.max(s, nS));
            let oE = new Date(Math.min(e, mE));
            if (oS < oE) total += (oE - oS) / 1000;
            cur.setDate(cur.getDate()+1);
        }
        return total;
    }

    function showResults(data) {
        const container = document.getElementById('rankings');
        container.innerHTML = data.map((r, i) => `
            <div class="res-row">
                <div><b>${i+1}. ${r.name}</b><br><small>${r.dist} Km | ${r.time}</small></div>
                <div style="text-align:right"><b style="color:var(--success);">${r.speed.toFixed(3)}</b><br><small>m/min</small></div>
            </div>
        `).join('');
        document.getElementById('resultArea').style.display = 'block';
    }

    // PDF Import
    document.getElementById('pdfInput').onchange = async (e) => {
        const file = e.target.files[0];
        const reader = new FileReader();
        reader.onload = async function() {
            const pdf = await pdfjsLib.getDocument(new Uint8Array(this.result)).promise;
            let list = [];
            for (let i = 1; i <= pdf.numPages; i++) {
                const page = await pdf.getPage(i);
                const text = await page.getTextContent();
                let lines = {};
                text.items.forEach(it => {
                    let y = Math.round(it.transform[5]);
                    if (!lines[y]) lines[y] = [];
                    lines[y].push(it);
                });
                Object.keys(lines).sort((a,b)=>b-a).forEach(y => {
                    let row = lines[y].sort((a,b)=>a.transform[4]-b.transform[4]).map(it => it.str.trim()).filter(s => s !== "");
                    let d = row.find(v => /^\d+\.\d{3}$/.test(v));
                    let n = row.find(v => v.length > 3 && isNaN(v));
                    if (d && n) list.push({ name: n, dist: parseFloat(d), manual: false });
                });
            }
            racers = list; render();
        };
        reader.readAsArrayBuffer(file);
    };

    function saveImg() {
        html2canvas(document.getElementById('capture')).then(canvas => {
            const a = document.createElement('a');
            a.download = 'Results.png';
            a.href = canvas.toDataURL();
            a.click();
        });
    }

    function filter() {
        let q = document.getElementById('searchBox').value.toLowerCase();
        document.querySelectorAll('.racer-card').forEach(c => {
            c.style.display = c.dataset.search.includes(q) ? 'block' : 'none';
        });
    }
</script>
</body>
</html>

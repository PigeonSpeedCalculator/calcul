<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8">
<title>ELMAKKAOUY RACE PRO</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<style>
body{margin:0;background:#0b0f19;color:#fff;font-family:Arial}
#map{height:380px}
.panel{padding:15px;background:#161b2a}
input,button{
width:100%;padding:10px;margin-top:8px;
background:#0b0f19;border:1px solid #2d3343;
color:#fff;border-radius:6px
}
button{background:#00d4ff;color:#000;font-weight:bold;cursor:pointer}
.stat{margin:6px 0;font-size:14px}
.stat b{color:#00ff88}
.card{
background:#0b0f19;padding:8px;margin-top:6px;
border-left:3px solid #00d4ff;border-radius:6px
}
table{width:100%;border-collapse:collapse;margin-top:12px}
th,td{padding:8px;text-align:center}
th{background:#0b0f19}
td{border-bottom:1px solid #2d3343}
</style>
</head>

<body>

<div id="map"></div>

<div class="panel">

<div class="stat">â° ØªÙˆÙ‚ÙŠØª Ø§Ù„Ø§Ù†Ø·Ù„Ø§Ù‚ Ø§Ù„Ø±Ø³Ù…ÙŠ</div>
<input type="datetime-local" id="startTime">

<div class="stat">ğŸ“ Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª Ø§Ù„Ø§Ù†Ø·Ù„Ø§Ù‚</div>
<input id="startCoord" value="33.2722,-8.3732">

<div class="stat">ğŸ Ù…Ø¯ÙŠÙ†Ø© Ø§Ù„ÙˆØµÙˆÙ„</div>
<input id="city" placeholder="Ù…Ø«Ø§Ù„: Casablanca">

<div class="stat">ğŸ“ Ø§Ù„Ù…Ø³Ø§ÙØ© (Km)</div>
<input id="distanceKm" readonly>

<button onclick="startRace()">Ø¨Ø¯Ø¡ Ø§Ù„ØªØªØ¨Ø¹ ğŸ•Šï¸</button>

<hr>

<div class="stat">ğŸ•Šï¸ Ø§Ù„Ø³Ø±Ø¹Ø© Ø§Ù„Ù„Ø­Ø¸ÙŠØ©: <b id="liveSpeed">-- m/min</b></div>
<div class="stat">â±ï¸ Ø§Ù„Ø²Ù…Ù† Ø§Ù„Ù…Ù†Ù‚Ø¶ÙŠ: <b id="elapsed">-- min</b></div>

<hr>

<h3>Ø¥Ø¶Ø§ÙØ© Ù…ØªØ³Ø§Ø¨Ù‚</h3>
<input id="name" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…ØªØ³Ø§Ø¨Ù‚">
<input id="arrival" type="datetime-local">
<button onclick="addRacer()">Ø¥Ø¶Ø§ÙØ©</button>

<div id="list"></div>

<button onclick="calculate()">ğŸ† Ø­Ø³Ø§Ø¨ Ø§Ù„Ù†ØªØ§Ø¦Ø¬</button>
<div id="results"></div>

</div>

<script>
/* ================= MAP ================= */
let map = L.map('map').setView([33.2722,-8.3732],7);
L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png').addTo(map);

let startMarker = L.marker([33.2722,-8.3732]).addTo(map);
let pigeon, destPoint;
let totalDistanceMeters = 0;
let startTimestamp = 0;
let racers = [];

/* ================= START ================= */
async function startRace(){

const s = startCoord.value.split(',');
startMarker.setLatLng([+s[0],+s[1]]);

const geo = await fetch(
`https://nominatim.openstreetmap.org/search?format=json&q=${city.value}&limit=1`
);
const g = await geo.json();
destPoint = L.latLng(+g[0].lat,+g[0].lon);

totalDistanceMeters = map.distance(startMarker.getLatLng(),destPoint);
distanceKm.value = (totalDistanceMeters/1000).toFixed(3);

L.polyline([startMarker.getLatLng(),destPoint],
{color:'#00d4ff',dashArray:'6,6'}).addTo(map);

map.fitBounds([startMarker.getLatLng(),destPoint],{padding:[40,40]});

if(pigeon) map.removeLayer(pigeon);

/* Ø­Ù…Ø§Ù…Ø© ØªØ±ÙØ±Ù */
pigeon = L.marker(startMarker.getLatLng(),{
icon:L.divIcon({
html:"<div id='bird'>ğŸ•Šï¸</div>",
iconSize:[40,40],
className:''
})
}).addTo(map);

/* ØªØ£Ø«ÙŠØ± Ø±ÙØ±ÙØ© */
setInterval(()=>{
const b=document.getElementById("bird");
if(b) b.style.transform=
`translateY(${Math.sin(Date.now()/100)*4}px)`;
},60);

startTimestamp = new Date(startTime.value).getTime();

animatePigeon();
}

/* ================= TRACKING ================= */
function animatePigeon(){
let traveled = 0;
let last = performance.now();

function step(now){
const dt = (now-last)/60000; // Ø¨Ø§Ù„Ø¯Ù‚Ø§Ø¦Ù‚
last = now;

/* Ø³Ø±Ø¹Ø© Ø§ÙØªØ±Ø§Ø¶ÙŠØ© ÙˆØ§Ù‚Ø¹ÙŠØ© 1100 m/min */
const realisticSpeed = 1100;

traveled += realisticSpeed * dt;

let p = traveled / totalDistanceMeters;
if(p>=1){
pigeon.setLatLng(destPoint);
liveSpeed.innerText="ÙˆØµÙ„ âœ”";
return;
}

pigeon.setLatLng([
startMarker.getLatLng().lat +
(destPoint.lat-startMarker.getLatLng().lat)*p,
startMarker.getLatLng().lng +
(destPoint.lng-startMarker.getLatLng().lng)*p
]);

const elapsedMin = (Date.now()-startTimestamp)/60000;
elapsed.innerText = elapsedMin.toFixed(2);

const currentSpeed = traveled / elapsedMin;
liveSpeed.innerText = currentSpeed.toFixed(1)+" m/min";

requestAnimationFrame(step);
}
requestAnimationFrame(step);
}

/* ================= RACERS ================= */
function addRacer(){
racers.push({
name:name.value,
arrival:new Date(arrival.value)
});
list.innerHTML = racers.map(r=>
`<div class="card">${r.name} â€“ ${r.arrival.toLocaleTimeString()}</div>`
).join('');
name.value='';
}

/* ================= CALCULATE ================= */
function calculate(){

const start = new Date(startTime.value);
const distanceM = totalDistanceMeters;

const res = racers.map(r=>{
const minutes = (r.arrival - start)/60000;
const speed = distanceM / minutes;
return {...r,minutes,speed};
}).sort((a,b)=>b.speed-a.speed);

results.innerHTML = `
<table>
<thead>
<tr>
<th>#</th>
<th>Ø§Ù„Ø§Ø³Ù…</th>
<th>Ø§Ù„Ø²Ù…Ù† (Ø¯)</th>
<th>Ø§Ù„Ø³Ø±Ø¹Ø© (Ù…/Ø¯)</th>
</tr>
</thead>
<tbody>
${res.map((r,i)=>`
<tr>
<td>${i+1}</td>
<td>${r.name}</td>
<td>${r.minutes.toFixed(2)}</td>
<td style="color:#10b981">${r.speed.toFixed(1)}</td>
</tr>
`).join('')}
</tbody>
</table>`;
}
</script>

</body>
</html>

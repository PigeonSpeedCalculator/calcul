<!DOCTYPE html>
<html lang="ar">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ELMAKKAOUY RADAR PRO</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <style>
        :root { --primary: #00d4ff; --bg: #050a14; --card: #0f172a; --accent: #10b981; }
        body { margin: 0; background: var(--bg); color: white; font-family: 'Segoe UI', sans-serif; overflow-x: hidden; }
        
        /* Nav Tabs */
        .tabs { display: flex; background: #111827; border-bottom: 2px solid #1e293b; position: sticky; top: 0; z-index: 2000; }
        .tab { flex: 1; padding: 15px; text-align: center; cursor: pointer; font-weight: bold; color: #64748b; transition: 0.3s; }
        .tab.active { color: var(--primary); border-bottom: 3px solid var(--primary); background: rgba(0, 212, 255, 0.05); }

        .content { display: none; padding: 20px; min-height: 90vh; }
        .content.active { display: block; }

        /* Simulation Section */
        #map { height: 450px; border-radius: 20px; border: 1px solid var(--primary); margin-bottom: 20px; }
        .weather-panel { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-bottom: 20px; }
        .w-box { background: var(--card); padding: 15px; border-radius: 12px; text-align: center; border: 1px solid #1e293b; }
        .w-box small { display: block; color: #94a3b8; font-size: 10px; }
        .w-box b { color: var(--primary); font-size: 1.2rem; }

        /* Calculator Section */
        .entry-form { background: var(--card); padding: 20px; border-radius: 15px; border: 1px solid var(--primary); margin-bottom: 20px; }
        .input-row { display: grid; grid-template-columns: 2fr 1fr 1.5fr auto; gap: 10px; margin-top: 10px; }
        input { background: #050a14; border: 1px solid #334155; color: white; padding: 10px; border-radius: 8px; outline: none; }
        
        .btn { padding: 12px 20px; border-radius: 8px; border: none; font-weight: bold; cursor: pointer; transition: 0.2s; }
        .btn-main { background: var(--primary); color: #000; }
        .btn-calc { background: var(--accent); color: white; width: 100%; font-size: 1.1rem; }

        /* Results */
        #resultsImg { background: white; color: black; border-radius: 15px; padding: 0; overflow: hidden; display: none; margin-top: 20px; }
        .res-table { width: 100%; border-collapse: collapse; }
        .res-table th { background: #0f172a; color: white; padding: 15px; }
        .res-table td { padding: 12px; border-bottom: 1px solid #eee; text-align: center; }

        /* Suggestions */
        .suggest-list { background: #1e293b; position: absolute; z-index: 1000; width: 100%; border-radius: 8px; }
        .suggest-item { padding: 10px; cursor: pointer; border-bottom: 1px solid #334155; }
        .suggest-item:hover { background: var(--primary); color: #000; }
    </style>
</head>
<body>

    <div class="tabs">
        <div class="tab active" onclick="showPage('radar')">ğŸ“¡ Ø±Ø§Ø¯Ø§Ø± Ø§Ù„ØªØªØ¨Ø¹ ÙˆØ§Ù„Ù…Ø­Ø§ÙƒØ§Ø©</div>
        <div class="tab" onclick="showPage('calc')">â±ï¸ ØºØ±ÙØ© Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª ÙˆØ§Ù„Ù†ØªØ§Ø¦Ø¬</div>
    </div>

    <div id="radar" class="content active">
        <div id="map"></div>
        
        <div class="weather-panel">
            <div class="w-box"><small>Ø§Ù„Ø±ÙŠØ§Ø­</small><b id="ws">--</b></div>
            <div class="w-box"><small>Ø§Ù„Ø§ØªØ¬Ø§Ù‡</small><b id="wd">--</b></div>
            <div class="w-box"><small>Ø§Ù„Ø­Ø±Ø§Ø±Ø©</small><b id="wt">--</b></div>
        </div>

        <div class="entry-form">
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                <div style="position:relative;">
                    <label style="font-size:11px;">ğŸ Ù…Ø¯ÙŠÙ†Ø© Ø§Ù„ÙˆØµÙˆÙ„ (Ø¨Ø­Ø« Ø°ÙƒÙŠ)</label>
                    <input type="text" id="citySearch" placeholder="Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©..." oninput="getCity(this.value)" style="width:100%">
                    <div id="cityList" class="suggest-list"></div>
                </div>
                <div>
                    <label style="font-size:11px;">ğŸ“ Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª Ø§Ù„Ø§Ù†Ø·Ù„Ø§Ù‚</label>
                    <input type="text" id="startCoord" value="33.2722, -8.3732" onchange="loadWeather()">
                </div>
            </div>
            <button class="btn btn-main" style="width:100%; margin-top:15px;" onclick="startSimulation()">Ø¨Ø¯Ø¡ Ù…Ø­Ø§ÙƒØ§Ø© Ø§Ù„Ø·ÙŠØ±Ø§Ù† Ø§Ù„ÙˆØ§Ù‚Ø¹ÙŠ ğŸ•Šï¸</button>
        </div>
    </div>

    <div id="calc" class="content">
        <div class="entry-form">
            <h4 style="margin:0 0 10px 0; color:var(--primary)">Ø¥Ø¶Ø§ÙØ© Ù…ØªØ³Ø§Ø¨Ù‚ Ø¬Ø¯ÙŠØ¯</h4>
            <div class="input-row">
                <input type="text" id="pName" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…ØªØ³Ø§Ø¨Ù‚">
                <input type="number" id="pDist" placeholder="Ø§Ù„Ù…Ø³Ø§ÙØ© Km">
                <div style="display:flex; gap:5px; align-items:center;">
                    <input type="number" id="pH" value="12" style="width:50px">:
                    <input type="number" id="pM" value="00" style="width:50px">:
                    <input type="number" id="pS" value="00" style="width:50px">
                </div>
                <button class="btn btn-main" onclick="addRacer()">Ø£Ø¶Ù +</button>
            </div>
        </div>

        <div id="racerContainer"></div>

        <button class="btn btn-calc" onclick="showResults()">ğŸ† Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ù„Ø§Ø¦Ø­Ø© Ø§Ù„ØªØ±ØªÙŠØ¨</button>

        <div id="resultsImg">
            <div style="background:#0f172a; color:#00d4ff; padding:20px; text-align:center;">
                <h2 style="margin:0;">ELMAKKAOUY RADAR PRO</h2>
                <small>Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø³Ø¨Ø§Ù‚ Ø§Ù„Ø±Ø³Ù…ÙŠØ©</small>
            </div>
            <table class="res-table" id="resTable">
                <thead>
                    <tr>
                        <th>Ø§Ù„Ø±ØªØ¨Ø©</th>
                        <th>Ø§Ù„Ù…ØªØ³Ø§Ø¨Ù‚</th>
                        <th>Ø§Ù„Ù…Ø³Ø§ÙØ©</th>
                        <th>Ø§Ù„ÙˆØµÙˆÙ„</th>
                        <th>Ø§Ù„Ø³Ø±Ø¹Ø© (Ù…/Ø¯)</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
        <button class="btn" style="width:100%; background:#475569; color:white; margin-top:10px;" onclick="saveImg()">ğŸ“¸ Ø­ÙØ¸ Ø§Ù„Ù†ØªÙŠØ¬Ø© ÙƒØµÙˆØ±Ø©</button>
    </div>

<script>
    let map, startMarker, pigeon, path;
    let racers = [];
    let destination = null;

    // Navigation
    function showPage(id) {
        document.querySelectorAll('.content').forEach(p => p.classList.remove('active'));
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        event.currentTarget.classList.add('active');
        if(id === 'radar') setTimeout(() => map.invalidateSize(), 200);
    }

    // Map Init
    window.onload = () => {
        map = L.map('map', { zoomControl: false }).setView([33.2722, -8.3732], 7);
        L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png').addTo(map);
        startMarker = L.marker([33.2722, -8.3732]).addTo(map);
        loadWeather();
    };

    // Weather & Cities
    async function loadWeather() {
        const c = document.getElementById('startCoord').value.split(',');
        const res = await fetch(`https://api.openweathermap.org/data/2.5/weather?lat=${c[0].trim()}&lon=${c[1].trim()}&appid=992e2b79f5e3386bda09d14ff4807f9d&units=metric`);
        const d = await res.json();
        document.getElementById('ws').innerText = (d.wind.speed * 3.6).toFixed(1) + " km/h";
        document.getElementById('wt').innerText = d.main.temp + "Â°C";
        const dirs = ['Ø´Ù…Ø§Ù„','Ø´Ù…Ø§Ù„ Ø´Ø±Ù‚ÙŠ','Ø´Ø±Ù‚','Ø¬Ù†ÙˆØ¨ Ø´Ø±Ù‚ÙŠ','Ø¬Ù†ÙˆØ¨','Ø¬Ù†ÙˆØ¨ ØºØ±Ø¨ÙŠ','ØºØ±Ø¨','Ø´Ù…Ø§Ù„ ØºØ±Ø¨ÙŠ'];
        document.getElementById('wd').innerText = dirs[Math.round(d.wind.deg/45)%8];
    }

    async function getCity(v) {
        if(v.length < 3) return;
        const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${v}&limit=5`);
        const data = await res.json();
        const list = document.getElementById('cityList');
        list.innerHTML = data.map(d => `<div class="suggest-item" onclick="selectCity(${d.lat}, ${d.lon}, '${d.display_name}')">${d.display_name.split(',')[0]}</div>`).join('');
    }

    function selectCity(lat, lon, name) {
        destination = [lat, lon];
        document.getElementById('citySearch').value = name.split(',')[0];
        document.getElementById('cityList').innerHTML = '';
        
        const dist = (map.distance(startMarker.getLatLng(), destination)/1000).toFixed(3);
        document.getElementById('pDist').value = dist; // ØªØ¹Ø¨Ø¦Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ© Ù„ØµÙØ­Ø© Ø§Ù„Ø­Ø³Ø§Ø¨
        
        if(path) map.removeLayer(path);
        path = L.polyline([startMarker.getLatLng(), destination], {color: var(--primary), weight: 2, dashArray: '5, 10'}).addTo(map);
        map.fitBounds(path.getBounds(), {padding:[50,50]});
    }

    // Simulation
    function startSimulation() {
        if(!destination) return alert("Ø§Ø®ØªØ± Ù…Ø¯ÙŠÙ†Ø© Ø§Ù„ÙˆØµÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹");
        if(pigeon) map.removeLayer(pigeon);
        
        pigeon = L.marker(startMarker.getLatLng(), {
            icon: L.divIcon({ html: 'ğŸ•Šï¸', className: '', iconSize: [25, 25] })
        }).addTo(map);

        let pos = 0;
        const start = startMarker.getLatLng();
        const interval = setInterval(() => {
            pos += 0.01;
            if(pos >= 1) { clearInterval(interval); return; }
            let lat = start.lat + (destination[0] - start.lat) * pos;
            let lng = start.lng + (destination[1] - start.lng) * pos;
            pigeon.setLatLng([lat, lng]);
        }, 50);
    }

    // Calculator
    function addRacer() {
        const name = document.getElementById('pName').value;
        const dist = document.getElementById('pDist').value;
        const h = document.getElementById('pH').value;
        const m = document.getElementById('pM').value;
        const s = document.getElementById('pS').value;

        if(!name || !dist) return alert("Ø§ÙƒÙ…Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª");
        racers.push({ name, dist, h, m, s });
        updateRacerList();
        document.getElementById('pName').value = '';
    }

    function updateRacerList() {
        document.getElementById('racerContainer').innerHTML = racers.map((r, i) => `
            <div class="input-row" style="background:var(--card); padding:10px; border-radius:10px; margin-bottom:5px;">
                <b>${r.name}</b>
                <span style="color:var(--primary)">${r.dist} Km</span>
                <span>${r.h}:${r.m}:${r.s}</span>
                <button onclick="racers.splice(${i},1); updateRacerList()" style="color:red; background:none; border:none; cursor:pointer;">âœ–</button>
            </div>
        `).join('');
    }

    function showResults() {
        let startT = new Date();
        startT.setHours(7,0,0); // Ø§ÙØªØ±Ø§Ø¶ ÙˆÙ‚Øª Ø§Ù„Ø§Ù†Ø·Ù„Ø§Ù‚ 7 ØµØ¨Ø§Ø­Ø§Ù‹

        let results = racers.map(r => {
            let arrival = new Date(startT);
            arrival.setHours(r.h, r.m, r.s);
            let diff = (arrival - startT) / 60000;
            let speed = (parseFloat(r.dist) * 1000) / diff;
            return { ...r, speed };
        }).sort((a,b) => b.speed - a.speed);

        const tbody = document.querySelector('#resTable tbody');
        tbody.innerHTML = results.map((r, i) => `
            <tr>
                <td>${i+1}</td>
                <td><b>${r.name}</b></td>
                <td>${r.dist} Km</td>
                <td>${r.h}:${r.m}:${r.s}</td>
                <td style="color:#10b981; font-weight:bold;">${r.speed.toFixed(3)}</td>
            </tr>
        `).join('');
        document.getElementById('resultsImg').style.display = 'block';
    }

    function saveImg() {
        html2canvas(document.getElementById('resultsImg')).then(canvas => {
            const a = document.createElement('a');
            a.download = 'RADAR_RESULTS.png';
            a.href = canvas.toDataURL();
            a.click();
        });
    }
</script>
</body>
</html>

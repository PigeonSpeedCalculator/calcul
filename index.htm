<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù†Ø¸Ø§Ù… Ø§Ù„Ù…ÙƒØ§ÙˆÙŠ Ù„Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø³Ø¨Ø§Ù‚</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <style>
        :root { --primary: #3b82f6; --bg: #0b0f19; --card: #161b2a; }
        body { margin: 0; background: var(--bg); color: white; font-family: 'Segoe UI', sans-serif; text-align: right; }
        .header { background: var(--card); padding: 15px; border-bottom: 2px solid var(--primary); display: flex; justify-content: space-between; }
        .container { max-width: 700px; margin: 0 auto; padding: 15px; }
        
        #map { height: 300px; width: 100%; border-radius: 20px; border: 1px solid #2d3748; margin-bottom: 20px; }

        .card { background: var(--card); border-radius: 20px; padding: 20px; border: 1px solid #2d3748; margin-bottom: 15px; }
        label { font-size: 12px; color: #718096; display: block; margin-bottom: 5px; }
        input, textarea { background: #0b0f19; border: 1px solid #334155; color: white; padding: 12px; border-radius: 10px; width: 100%; box-sizing: border-box; margin-bottom: 10px; }
        
        textarea { height: 120px; font-size: 13px; text-align: right; resize: none; }
        
        .btn-extract { background: #f59e0b; color: black; border: none; padding: 15px; border-radius: 12px; width: 100%; font-weight: bold; cursor: pointer; font-size: 16px; }
        .btn-extract:hover { background: #d97706; }

        /* Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù†ØªØ§Ø¦Ø¬ */
        .racer-list { margin-top: 20px; }
        .racer-row { background: #1e293b; padding: 12px 15px; border-radius: 12px; margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center; border-right: 4px solid var(--primary); }
        .racer-info b { color: #fff; font-size: 15px; }
        .racer-info span { color: #94a3b8; font-size: 12px; display: block; }
        .racer-dist { background: rgba(59, 130, 246, 0.2); color: var(--primary); padding: 5px 10px; border-radius: 8px; font-weight: bold; font-size: 14px; }
        
        .empty-msg { text-align: center; color: #718096; padding: 20px; }
    </style>
</head>
<body>

<header class="header">
    <div style="font-weight: 900;">ELMAKKAOUY <span style="color:var(--primary)">DATA SYSTEM</span></div>
    <div id="liveClock" style="font-family: monospace;">00:00:00</div>
</header>

<div class="container">
    <div id="map"></div>

    <div class="card">
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
            <div>
                <label>ğŸ“ Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª Ø§Ù„Ø¥Ø·Ù„Ø§Ù‚</label>
                <input type="text" id="latStart" value="33.2722, -8.3732">
            </div>
            <div>
                <label>ğŸ™ï¸ Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª Ø§Ù„Ø³Ù†Ø·Ø±Ø§Ù„</label>
                <input type="text" id="latEnd" value="33.5731, -7.5898">
            </div>
        </div>

        <label>ğŸ“‹ Ø§Ù†Ø³Ø® Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ù…Ù† Ø§Ù„Ù…Ù„Ù ÙˆØ§Ù„ØµÙ‚Ù‡Ø§ Ù‡Ù†Ø§:</label>
        <textarea id="rawInput" placeholder="Ù…Ø«Ø§Ù„:
Ø§Ù„Ø¨Ø·Ù„ Ø£Ø­Ù…Ø¯ 216.65
Ø§Ù„Ø¨Ø·Ù„ ÙŠØ§Ø³ÙŠÙ† 190.40"></textarea>

        <button class="btn-extract" onclick="extractData()">ğŸ“¥ Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ù†ØªØ§Ø¦Ø¬ ÙˆØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆØ§Ù‚Ø¹</button>
    </div>

    <div id="racerList" class="racer-list">
        <div class="empty-msg">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ø­Ø§Ù„ÙŠØ§Ù‹. Ù‚Ù… Ø¨Ù„ØµÙ‚ Ø§Ù„Ù†ØªØ§Ø¦Ø¬ ÙˆØ§Ø¶ØºØ· Ø§Ø³ØªØ®Ø±Ø§Ø¬.</div>
    </div>
</div>

<script>
    let map, markers = [];

    // ØªØ´ØºÙŠÙ„ Ø§Ù„Ø®Ø±ÙŠØ·Ø©
    function initMap() {
        map = L.map('map', { zoomControl: false }).setView([33.4, -8], 8);
        L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png').addTo(map);
    }

    function extractData() {
        const input = document.getElementById('rawInput').value;
        const start = document.getElementById('latStart').value.split(',').map(Number);
        const end = document.getElementById('latEnd').value.split(',').map(Number);
        const listContainer = document.getElementById('racerList');

        if (!input.trim()) {
            alert("Ø§Ù„Ø±Ø¬Ø§Ø¡ Ù„ØµÙ‚ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø£ÙˆÙ„Ø§Ù‹");
            return;
        }

        // ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©
        markers.forEach(m => map.removeLayer(m));
        markers = [];
        listContainer.innerHTML = "";

        // ØªÙ‚Ø³ÙŠÙ… Ø§Ù„Ù†Øµ Ø¥Ù„Ù‰ Ø£Ø³Ø·Ø±
        const lines = input.split('\n');
        let found = false;

        lines.forEach((line) => {
            // Ù…Ù†Ø·Ù‚ Ø§Ù„Ø§Ø³ØªØ®Ø±Ø§Ø¬: Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ø³Ù… (Ù†ØµÙˆØµ) Ù…ØªØ¨ÙˆØ¹ Ø¨Ø±Ù‚Ù… (Ø§Ù„Ù…Ø³Ø§ÙØ©)
            // Regex: ÙŠØ¨Ø­Ø« Ø¹Ù† Ø£Ø±Ù‚Ø§Ù… Ø§Ù„Ù…Ø³Ø§ÙØ§Øª Ù…Ø«Ù„ 216.65 Ø£Ùˆ 190
            const distMatch = line.match(/(\d{2,3}\.\d{1,3})|(\d{2,3})/);
            
            if (distMatch) {
                const distance = parseFloat(distMatch[0]);
                // Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ø§Ø³Ù…: ÙƒÙ„ Ù…Ø§ Ù‡Ùˆ Ù‚Ø¨Ù„ Ø§Ù„Ø±Ù‚Ù…
                const name = line.split(distMatch[0])[0].trim() || "Ù…ØªØ³Ø§Ø¨Ù‚ Ù…Ø¬Ù‡ÙˆÙ„";
                
                found = true;

                // 1. Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¬ØºØ±Ø§ÙÙŠ Ù„Ù„Ù…ØªØ³Ø§Ø¨Ù‚
                const totalDist = L.latLng(start).distanceTo(L.latLng(end)) / 1000;
                const ratio = Math.min(distance / totalDist, 1);
                const pos = [
                    start[0] + (end[0] - start[0]) * ratio,
                    start[1] + (end[1] - start[1]) * ratio
                ];

                // 2. Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø­Ù…Ø§Ù…Ø© Ù„Ù„Ø®Ø±ÙŠØ·Ø©
                const m = L.marker(pos, {
                    icon: L.divIcon({ html: 'ğŸ•Šï¸', className: 'p-icon', iconSize: [25, 25] })
                }).addTo(map).bindPopup(`<b>${name}</b><br>Ø§Ù„Ù…Ø³Ø§ÙØ©: ${distance} ÙƒÙ…`);
                markers.push(m);

                // 3. Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…ØªØ³Ø§Ø¨Ù‚ Ù„Ù„Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø³ÙÙ„ÙŠ
                const row = document.createElement('div');
                row.className = 'racer-row';
                row.innerHTML = `
                    <div class="racer-info">
                        <b>${name}</b>
                        <span>Ø§Ù„Ù…Ø³Ø§ÙØ© Ø§Ù„Ù…Ø¹ØªÙ…Ø¯Ø©: ${distance} ÙƒÙ…</span>
                    </div>
                    <div class="racer-dist">${distance} KM</div>
                `;
                listContainer.appendChild(row);
            }
        });

        if (!found) {
            listContainer.innerHTML = "<div class='empty-msg'>ØªØ¹Ø°Ø± Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ù…Ø³Ø§ÙØ§Øª ÙÙŠ Ø§Ù„Ù†Øµ. ØªØ£ÙƒØ¯ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø£Ø±Ù‚Ø§Ù… Ø§Ù„Ù…Ø³Ø§ÙØ§Øª.</div>";
        } else if (markers.length > 0) {
            const group = new L.featureGroup(markers);
            map.fitBounds(group.getBounds(), {padding: [40, 40]});
        }
    }

    setInterval(() => {
        document.getElementById('liveClock').innerText = new Date().toTimeString().split(' ')[0];
    }, 1000);

    initMap();
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ELMAKKAOUY | Metric Radar V1</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>

    <style>
        :root { --primary: #3b82f6; --bg: #0b0f19; --card: #161b2a; }
        body { margin: 0; background: var(--bg); color: white; font-family: sans-serif; text-align: left; }
        .header { background: var(--card); padding: 15px; border-bottom: 2px solid var(--primary); display: flex; justify-content: space-between; }
        .container { max-width: 1000px; margin: 0 auto; padding: 10px; }
        #map { height: 380px; width: 100%; border-radius: 20px; border: 1px solid #2d3748; margin-bottom: 15px; }
        .card { background: var(--card); border-radius: 20px; padding: 20px; border: 1px solid #2d3748; margin-bottom: 15px; }
        .input-group { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px; }
        input { background: #0b0f19; color: white; border: 1px solid #334155; padding: 10px; border-radius: 8px; width: 100%; box-sizing: border-box; text-align: center; }
        .btn-upload { background: var(--primary); color: white; padding: 15px; border-radius: 12px; width: 100%; border: none; font-weight: bold; cursor: pointer; font-size: 16px; }
        .stats { display: flex; gap: 10px; margin-bottom: 15px; }
        .stat-box { background: #1e293b; padding: 10px; border-radius: 10px; flex: 1; text-align: center; border: 1px solid #334155; }
        .racer-table { width: 100%; border-collapse: collapse; font-size: 13px; margin-top: 10px; }
        .racer-table th { background: #1e293b; padding: 12px; text-align: left; border-bottom: 2px solid var(--primary); }
        .racer-table td { padding: 12px; border-bottom: 1px solid #2d3748; }
        .pigeon-marker { font-size: 24px; text-shadow: 0 0 10px white; }
    </style>
</head>
<body>

<header class="header">
    <div style="font-weight: bold; font-size: 1.2rem;">ELMAKKAOUY <span style="color:var(--primary)">METRIC RADAR</span></div>
    <div id="clock" style="font-family: monospace;">00:00:00</div>
</header>

<div class="container">
    <div id="map"></div>

    <div class="stats">
        <div class="stat-box">Pigeons: <b id="count">0</b></div>
        <div class="stat-box">Status: <b id="status" style="color:#f59e0b;">Ready</b></div>
    </div>

    <div class="card">
        <div class="input-group">
            <div><label style="font-size:10px; color:#718096;">RELEASE COORD</label><input type="text" id="startCoord" value="33.2722, -8.3732"></div>
            <div><label style="font-size:10px; color:#718096;">HOME COORD</label><input type="text" id="endCoord" value="33.5731, -7.5898"></div>
        </div>
        <button class="btn-upload" onclick="document.getElementById('pdfInput').click()">ğŸ“ UPLOAD RACE PDF</button>
        <input type="file" id="pdfInput" hidden accept=".pdf" onchange="processPDF(event)">
    </div>

    <table class="racer-table" id="racerTable">
        <thead>
            <tr>
                <th>#</th>
                <th>Competitor Name</th>
                <th>Distance (m)</th>
                <th>KM</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>
</div>

<script>
    let map, markers = [];
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.worker.min.js';

    function initMap() {
        map = L.map('map', { zoomControl: false }).setView([33.4, -8], 8);
        L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png').addTo(map);
    }

    async function processPDF(event) {
        const file = event.target.files[0];
        if (!file) return;

        document.getElementById('status').innerText = "Processing...";
        const reader = new FileReader();
        reader.onload = async function() {
            const typedArray = new Uint8Array(this.result);
            const pdf = await pdfjsLib.getDocument(typedArray).promise;
            let fullRawText = "";

            for (let i = 1; i <= pdf.numPages; i++) {
                const page = await pdf.getPage(i);
                const content = await page.getTextContent();
                fullRawText += content.items.map(s => s.str).join(' ') + "\n";
            }
            extractMetricData(fullRawText);
        };
        reader.readAsArrayBuffer(file);
    }

    function extractMetricData(text) {
        const start = document.getElementById('startCoord').value.split(',').map(Number);
        const end = document.getElementById('endCoord').value.split(',').map(Number);
        const tbody = document.querySelector('#racerTable tbody');
        
        tbody.innerHTML = "";
        markers.forEach(m => map.removeLayer(m));
        markers = [];

        // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ø£Ø±Ù‚Ø§Ù… Ø§Ù„ÙƒØ¨ÙŠØ±Ø© (Ø§Ù„Ù…Ø³Ø§ÙØ§Øª Ø¨Ø§Ù„Ø£Ù…ØªØ§Ø± Ù…Ø«Ù„ 216650 Ø£Ùˆ 34003)
        // Regex: ÙŠØ¨Ø­Ø« Ø¹Ù† Ø£Ø±Ù‚Ø§Ù… Ù…ÙƒÙˆÙ†Ø© Ù…Ù† 5 Ø¥Ù„Ù‰ 7 Ø®Ø§Ù†Ø§Øª Ù…ØªØªØ§Ù„ÙŠØ©
        const metricRegex = /\b(\d{5,7})\b/g;
        const matches = [...text.matchAll(metricRegex)];
        
        let validCount = 0;
        matches.forEach((match, index) => {
            const rawDistance = parseInt(match[0]);
            
            // ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ù…Ø³Ø§ÙØ© Ù…Ù† Ø£Ù…ØªØ§Ø± Ø¥Ù„Ù‰ ÙƒÙŠÙ„ÙˆÙ…ØªØ±Ø§Øª (Ù‚Ø³Ù…Ø© Ø¹Ù„Ù‰ 1000)
            const distInKm = rawDistance / 1000;

            // Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ø§Ø³Ù…: Ù†Ø£Ø®Ø° Ø§Ù„Ù†Øµ Ø§Ù„Ø°ÙŠ ÙŠØ³Ø¨Ù‚ Ù‡Ø°Ø§ Ø§Ù„Ø±Ù‚Ù… Ø¨Ù…Ø³Ø§ÙØ© Ù…Ø¹ÙŠÙ†Ø©
            const pos = match.index;
            const snippet = text.substring(pos - 40, pos).trim();
            const name = snippet.split('\n').pop().replace(/[0-9]/g, '').trim() || "Racer " + (index + 1);

            if (distInKm > 1) { // ØªØ¬Ø§Ù‡Ù„ Ø§Ù„Ø£Ø±Ù‚Ø§Ù… Ø§Ù„ØµØºÙŠØ±Ø© Ø§Ù„ØªÙŠ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø£Ù† ØªÙƒÙˆÙ† Ù…Ø³Ø§ÙØ© Ø³Ø¨Ø§Ù‚
                validCount++;
                
                // Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…ÙˆÙ‚Ø¹
                const totalFlightDist = L.latLng(start).distanceTo(L.latLng(end)) / 1000;
                const ratio = Math.min(distInKm / totalFlightDist, 1);
                const lat = start[0] + (end[0] - start[0]) * ratio;
                const lng = start[1] + (end[1] - start[1]) * ratio;

                // Ø®Ø±ÙŠØ·Ø©
                const m = L.marker([lat, lng], {
                    icon: L.divIcon({ html: 'ğŸ•Šï¸', className: 'pigeon-marker', iconSize: [25, 25] })
                }).addTo(map).bindPopup(`${name}: ${distInKm} KM`);
                markers.push(m);

                // Ø¬Ø¯ÙˆÙ„
                tbody.innerHTML += `<tr>
                    <td>${validCount}</td>
                    <td><b>${name}</b></td>
                    <td>${rawDistance}</td>
                    <td style="color:#3b82f6; font-weight:bold;">${distInKm.toFixed(3)} KM</td>
                </tr>`;
            }
        });

        document.getElementById('count').innerText = validCount;
        document.getElementById('status').innerText = "Completed";
        if(markers.length > 0) {
            map.fitBounds(new L.featureGroup(markers).getBounds(), {padding:[40,40]});
        }
    }

    setInterval(() => {
        document.getElementById('clock').innerText = new Date().toTimeString().split(' ')[0];
    }, 1000);

    initMap();
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø±Ø§Ø¯Ø§Ø± Ø§Ù„Ù…ÙƒØ§ÙˆÙŠ - Ù…Ø³ØªØ®Ø±Ø¬ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø°ÙƒÙŠ</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <style>
        :root { --primary: #3b82f6; --bg: #0b0f19; --card: #161b2a; }
        body { margin: 0; background: var(--bg); color: white; font-family: sans-serif; text-align: right; }
        .header { background: var(--card); padding: 15px; border-bottom: 2px solid var(--primary); display: flex; justify-content: space-between; }
        .container { max-width: 700px; margin: 0 auto; padding: 10px; }
        #map { height: 300px; width: 100%; border-radius: 20px; border: 1px solid #2d3748; margin-bottom: 15px; }
        .card { background: var(--card); border-radius: 20px; padding: 15px; border: 1px solid #2d3748; margin-bottom: 15px; }
        .btn-upload { background: #f59e0b; color: black; padding: 15px; border-radius: 12px; width: 100%; border: none; font-weight: bold; cursor: pointer; }
        input { background: #0b0f19; color: white; border: 1px solid #2d3748; padding: 10px; width: 100%; box-sizing: border-box; border-radius: 8px; text-align: center; margin-top: 5px; }
        .racer-card { background: #1e293b; padding: 12px; margin-top: 8px; border-radius: 10px; border-right: 4px solid var(--primary); display: flex; justify-content: space-between; }
        .speed-val { color: #22c55e; font-weight: bold; }
    </style>
</head>
<body>

<header class="header">
    <div style="font-weight: bold;">ELMAKKAOUY <span style="color:var(--primary)">RADAR V3</span></div>
    <div id="clock">00:00:00</div>
</header>

<div class="container">
    <div id="map"></div>

    <div class="card">
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
            <div><label>ğŸ“ Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© (Lat, Lng)</label><input type="text" id="startP" value="33.2722, -8.3732"></div>
            <div><label>ğŸ™ï¸ Ø§Ù„Ø³Ù†Ø·Ø±Ø§Ù„ (Goal)</label><input type="text" id="endP" value="33.5731, -7.5898"></div>
        </div>
        <label style="margin-top:10px; display:block;">â° ÙˆÙ‚Øª Ø§Ù„Ø¥Ø·Ù„Ø§Ù‚ Ø§Ù„Ø±Ø³Ù…ÙŠ</label>
        <input type="datetime-local" id="startTime">
        
        <p style="font-size: 11px; color: #718096; margin-top: 10px;">Ù‚Ù… Ø¨Ø±ÙØ¹ Ù…Ù„Ù Ù†ØµÙŠ ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø³Ø§ÙØ§Øª Ø£Ùˆ Ø§Ù„Ø£Ø³Ù…Ø§Ø¡:</p>
        <button class="btn-upload" onclick="document.getElementById('fileIn').click()">ğŸ“ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ù„Ù ÙˆØ§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ù…ØªØ³Ø§Ø¨Ù‚ÙŠÙ†</button>
        <input type="file" id="fileIn" hidden accept=".txt,.csv" onchange="readPigeonFile(event)">
    </div>

    <div id="displayList"></div>
</div>

<script>
    let map, markers = [];

    function initMap() {
        map = L.map('map', { zoomControl: false }).setView([33.4, -8], 8);
        L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png').addTo(map);
        document.getElementById('startTime').value = new Date().toISOString().slice(0, 16);
    }

    // ÙˆØ¸ÙŠÙØ© Ù‚Ø±Ø§Ø¡Ø© ÙˆØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù…Ù„Ù
    function readPigeonFile(event) {
        const file = event.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = function(e) {
            const content = e.target.result;
            parseData(content);
        };
        reader.readAsText(file);
    }

    function parseData(text) {
        const start = document.getElementById('startP').value.split(',').map(Number);
        const end = document.getElementById('endP').value.split(',').map(Number);
        const relTime = new Date(document.getElementById('startTime').value);
        
        // ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø®Ø±ÙŠØ·Ø©
        markers.forEach(m => map.removeLayer(m));
        markers = [];
        
        const lines = text.split('\n');
        let html = "";

        lines.forEach((line, index) => {
            // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø£Ø±Ù‚Ø§Ù… Ø§Ù„Ù…Ø³Ø§ÙØ§Øª (Ø£Ø±Ù‚Ø§Ù… ØªØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ ÙØ§ØµÙ„Ø© Ø¹Ø´Ø±ÙŠØ©)
            const distMatch = line.match(/(\d+\.\d+)/);
            if (distMatch) {
                const distance = parseFloat(distMatch[0]);
                const name = "Ù…ØªØ³Ø§Ø¨Ù‚ " + (index + 1);

                // Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø³Ø§ÙØ©
                const totalDist = L.latLng(start).distanceTo(L.latLng(end)) / 1000;
                const ratio = Math.min(distance / totalDist, 1);
                const pos = [
                    start[0] + (end[0] - start[0]) * ratio,
                    start[1] + (end[1] - start[1]) * ratio
                ];

                // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø§Ø±ÙƒØ±
                const m = L.marker(pos, {
                    icon: L.divIcon({ html: 'ğŸ•Šï¸', className: 'p-icon', iconSize:[20,20] })
                }).addTo(map).bindPopup(name);
                markers.push(m);

                html += `
                    <div class="racer-card">
                        <div><b>${name}</b><br><small>Ø§Ù„Ù…Ø³Ø§ÙØ© Ø§Ù„Ù…Ø³ØªØ®Ø±Ø¬Ø©: ${distance} ÙƒÙ…</small></div>
                        <div class="speed-val">Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø±ÙŠØ·Ø© ğŸ“</div>
                    </div>
                `;
            }
        });

        document.getElementById('displayList').innerHTML = html || "<p style='text-align:center;'>Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ù…Ø³Ø§ÙØ§Øª ÙÙŠ Ø§Ù„Ù…Ù„Ù. ØªØ£ÙƒØ¯ Ø£Ù† Ø§Ù„Ù…Ù„Ù ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø£Ø±Ù‚Ø§Ù… Ù…Ø«Ù„ 216.65</p>";
        
        if(markers.length > 0) {
            const group = new L.featureGroup(markers);
            map.fitBounds(group.getBounds(), {padding: [40, 40]});
        }
    }

    setInterval(() => {
        document.getElementById('clock').innerText = new Date().toTimeString().split(' ')[0];
    }, 1000);

    initMap();
</script>
</body>
</html>

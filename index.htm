<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ELMAKKAOUY REAL-FLIGHT V3</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <style>
        :root { --primary: #00d4ff; --bg: #020617; --card: #1e293b; --text: #f8fafc; }
        body { margin: 0; background: var(--bg); color: var(--text); font-family: 'Segoe UI', sans-serif; overflow-x: hidden; }
        #map { height: 50vh; width: 100%; border-bottom: 2px solid var(--primary); }
        .stats-bar { 
            display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; 
            background: rgba(15, 23, 42, 0.9); padding: 15px; margin: -20px 10px 10px; 
            border-radius: 15px; position: relative; z-index: 1000; border: 1px solid var(--primary);
            backdrop-filter: blur(10px);
        }
        .stat-item { text-align: center; border-bottom: 1px solid #334155; padding-bottom: 5px; }
        .stat-item b { display: block; color: var(--primary); font-size: 1.2em; }
        .stat-item span { font-size: 0.75em; color: #94a3b8; font-weight: bold; }
        .panel { padding: 15px; background: var(--card); border-radius: 12px; margin: 10px; border: 1px solid #334155; box-shadow: 0 4px 6px rgba(0,0,0,0.3); }
        h3 { margin-top: 0; color: var(--primary); font-size: 1.1em; border-right: 3px solid var(--primary); padding-right: 10px; }
        input, button { width: 100%; padding: 12px; margin-top: 8px; border-radius: 8px; border: 1px solid #475569; background: #0f172a; color: white; font-size: 15px; box-sizing: border-box; }
        button { background: var(--primary); color: #000; font-weight: bold; border: none; cursor: pointer; transition: 0.3s; }
        button:active { transform: scale(0.98); }
        table { width: 100%; margin-top: 10px; border-collapse: collapse; font-size: 0.8em; }
        th, td { padding: 10px; border-bottom: 1px solid #334155; text-align: center; }
        #bird-icon { font-size: 30px; filter: drop-shadow(0 0 8px #fff); transition: transform 0.5s ease; }
    </style>
</head>
<body>

<div id="map"></div>

<div class="stats-bar">
    <div class="stat-item"><span>ğŸ•Šï¸ Ø§Ù„Ø³Ø±Ø¹Ø© Ø§Ù„Ù„Ø­Ø¸ÙŠØ©</span><b id="st-birdspeed">0 m/min</b></div>
    <div class="stat-item"><span>ğŸ•’ Ø§Ù„ÙˆØµÙˆÙ„ Ø§Ù„Ù…ØªÙˆÙ‚Ø¹</span><b id="st-eta" style="color:#fbbf24">--:--:--</b></div>
    <div class="stat-item"><span>ğŸ“ Ø§Ù„Ù…Ø³Ø§ÙØ© Ø§Ù„Ù…ØªØ¨Ù‚ÙŠØ©</span><b id="st-rem-dist">0 Km</b></div>
    <div class="stat-item"><span>ğŸŒ¬ï¸ ØªØ£Ø«ÙŠØ± Ø§Ù„Ø±ÙŠØ§Ø­</span><b id="st-wind">0 km/h</b></div>
</div>

<div class="panel">
    <h3>ğŸ“ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø±Ø­Ù„Ø©</h3>
    <input id="startCoords" placeholder="Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª Ø§Ù„Ø¥Ø·Ù„Ø§Ù‚ (Ù…Ø«Ù„Ø§Ù‹: 33.57, -7.58)">
    <input id="endInput" placeholder="Ø¨Ø­Ø« Ø¹Ù† Ù…Ø¯ÙŠÙ†Ø© Ø§Ù„ÙˆØµÙˆÙ„..." oninput="searchLoc(this.value)">
    <div id="sugEnd" style="background:#1e293b; border:1px solid #00d4ff; display:none; position:absolute; z-index:2000; width:85%; max-height:150px; overflow-y:auto; border-radius:8px;"></div>
    <input type="datetime-local" id="startTime">
    <button onclick="startFlight()">ØªØ´ØºÙŠÙ„ Ø§Ù„Ù…Ø­Ø§ÙƒØ§Ø© Ø§Ù„ÙˆØ§Ù‚Ø¹ÙŠØ© ğŸš€</button>
</div>

<div class="panel">
    <h3>ğŸ“Š Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ù…ØªØ³Ø§Ø¨Ù‚ÙŠÙ†</h3>
    <div style="display: flex; gap: 5px;">
        <input id="rName" placeholder="Ø§Ù„Ø§Ø³Ù…">
        <input id="rDist" type="number" placeholder="Km" step="0.001">
        <input id="rTime" type="time" step="1">
    </div>
    <button onclick="recordRacer()" style="background:#22c55e; color:white">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù†ØªÙŠØ¬Ø©</button>
    <table id="leaderboardTable">
        <thead><tr><th>#</th><th>Ø§Ù„Ø§Ø³Ù…</th><th>Km</th><th>Ù…/Ø¯</th></tr></thead>
        <tbody id="leaderboard"></tbody>
    </table>
    <button onclick="clearCache()" style="background:#ef4444; color:white; margin-top:15px; font-size:11px; padding:5px;">Ø¥Ø¹Ø§Ø¯Ø© Ø¶Ø¨Ø· Ø§Ù„Ù†Ø¸Ø§Ù… ÙƒØ§Ù…Ù„Ø§Ù‹</button>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
// Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ø§Ù„Ù‡Ø¬ÙŠÙ†Ø©
let map = L.map('map', {zoomControl: false}).setView([33.5, -7.5], 7);
L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}').addTo(map);
L.tileLayer('https://{s}.basemaps.cartocdn.com/light_only_labels/{z}/{x}/{y}{r}.png').addTo(map);

let pigeon, trail, points = [], startPt, endPt, racers = [];
let weather = { windKm: 0, deg: 0 };
const BASE_SPEED_KMH = 72; // Ø§Ù„Ø³Ø±Ø¹Ø© Ø§Ù„Ø·Ø¨ÙŠØ¹ÙŠØ© Ù„Ù„Ø­Ù…Ø§Ù… Ø§Ù„Ø²Ø§Ø¬Ù„

// Ù†Ø¸Ø§Ù… Ø§Ù„Ø­ÙØ¸ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ
window.onload = () => {
    const saved = JSON.parse(localStorage.getItem('flight_v3'));
    if (saved) {
        document.getElementById('startCoords').value = saved.startCoords || '';
        document.getElementById('endInput').value = saved.endName || '';
        document.getElementById('startTime').value = saved.startTime || '';
        endPt = saved.endPt;
        weather = saved.weather || { windKm: 0, deg: 0 };
        racers = saved.racers || [];
        updateLeaderboard();
        if (saved.startTime && endPt) startFlight();
    }
};

async function searchLoc(q) {
    if(q.length < 3) return;
    try {
        const r = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${q}&limit=5`);
        const d = await r.json();
        const box = document.getElementById('sugEnd');
        box.style.display = 'block';
        box.innerHTML = d.map(x => `<div style="padding:12px; border-bottom:1px solid #334155; cursor:pointer;" onclick="selectEnd(${x.lat}, ${x.lon}, '${x.display_name}')">${x.display_name}</div>`).join('');
    } catch(e) {}
}

function selectEnd(lat, lon, name) {
    endPt = {lat: parseFloat(lat), lng: parseFloat(lon)};
    document.getElementById('endInput').value = name.split(',')[0];
    document.getElementById('sugEnd').style.display = 'none';
    getWeather(lat, lon);
}

async function getWeather(lat, lon) {
    // Ù…Ø­Ø§ÙˆÙ„Ø© Ø¬Ù„Ø¨ Ø§Ù„Ø·Ù‚Ø³ØŒ Ù…Ø¹ Ù‚ÙŠÙ… Ø§ÙØªØ±Ø§Ø¶ÙŠØ© Ø°ÙƒÙŠØ© Ù„Ù„Ù…ØºØ±Ø¨ ÙÙŠ Ø­Ø§Ù„ ÙØ´Ù„ Ø§Ù„Ù€ API
    try {
        const r = await fetch(`https://api.openweathermap.org/data/2.5/weather?lat=${lat}&lon=${lon}&appid=992e2b79f5e3386bda09d14ff4807f9d`);
        const d = await r.json();
        weather = { windKm: d.wind.speed * 3.6, deg: d.wind.deg };
    } catch(e) {
        weather = { windKm: 15, deg: 300 }; // Ø±ÙŠØ§Ø­ Ø´Ù…Ø§Ù„ÙŠØ© ØºØ±Ø¨ÙŠØ© Ø§ÙØªØ±Ø§Ø¶ÙŠØ© (Chergui)
    }
    document.getElementById('st-wind').innerText = weather.windKm.toFixed(1) + " km/h";
    saveData();
}

function saveData() {
    const data = {
        startCoords: document.getElementById('startCoords').value,
        endName: document.getElementById('endInput').value,
        startTime: document.getElementById('startTime').value,
        endPt, weather, racers
    };
    localStorage.setItem('flight_v3', JSON.stringify(data));
}

function startFlight() {
    const sc = document.getElementById('startCoords').value.split(',');
    if(sc.length < 2 || !endPt) return;
    startPt = {lat: parseFloat(sc[0]), lng: parseFloat(sc[1])};
    
    if(pigeon) map.removeLayer(pigeon);
    if(trail) map.removeLayer(trail);
    
    pigeon = L.marker(startPt, {icon: L.divIcon({html: '<div id="bird-icon">ğŸ•Šï¸</div>', className: ''})}).addTo(map);
    trail = L.polyline([], {color: '#00d4ff', weight: 4, opacity: 0.7}).addTo(map);
    
    map.fitBounds([startPt, endPt], {padding: [50, 50]});
    requestAnimationFrame(updateFrame);
}

function updateFrame() {
    const startVal = document.getElementById('startTime').value;
    if(!startVal || !endPt) return;
    
    const now = new Date();
    const startT = new Date(startVal);
    const elapsedH = (now - startT) / 3600000;
    
    if(elapsedH < 0) {
        document.getElementById('st-eta').innerText = "ÙÙŠ Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ø¥Ø·Ù„Ø§Ù‚";
        requestAnimationFrame(updateFrame);
        return;
    }

    const totalDist = map.distance(startPt, endPt) / 1000;
    const bearing = (Math.atan2(endPt.lng - startPt.lng, endPt.lat - startPt.lat) * 180 / Math.PI);
    
    // Ù…Ø­Ø§ÙƒØ§Ø© ÙÙŠØ²ÙŠØ§Ø¡ Ø§Ù„Ø·ÙŠØ±Ø§Ù† (Ø§Ù„Ø±ÙŠØ§Ø­ ÙˆØ§Ù„Ø±Ø·ÙˆØ¨Ø©)
    const rad = (weather.deg - bearing) * Math.PI / 180;
    const windEffect = Math.cos(rad) * weather.windKm;
    
    // Ø³Ø±Ø¹Ø© Ø§Ù„Ø­Ù…Ø§Ù…Ø© (ØªØªØ±Ø§ÙˆØ­ Ø¨ÙŠÙ† 900 Ùˆ 1800 Ù…/Ø¯)
    const currentKmh = BASE_SPEED_KMH + (windEffect * 1.5); 
    const currentMmin = (currentKmh * 1000) / 60;
    
    let progress = (elapsedH * currentKmh) / totalDist;
    if(progress > 1) progress = 1;

    // Ø¹Ø§Ù…Ù„ Ø§Ù„Ø±Ø·ÙˆØ¨Ø© ÙˆØ§Ù„ØªØ¹Ø±Ø¬ Ø§Ù„Ø·Ø¨ÙŠØ¹ÙŠ
    // Ø§Ù„Ø­Ù…Ø§Ù… ÙŠÙ…ÙŠÙ„ Ù„Ù„ØªØ¹Ø±Ø¬ Ø¨Ø­Ø«Ø§Ù‹ Ø¹Ù† Ø§Ù„Ø±Ø·ÙˆØ¨Ø© Ø§Ù„Ù…Ø¹ØªØ¯Ù„Ø© (ØªØ°Ø¨Ø°Ø¨ Ø¬ÙŠØ¨ÙŠ Ù…Ø¹Ù‚Ø¯)
    const humidityWobble = Math.sin(progress * 30) * 0.005 * (1 + (weather.windKm / 50));
    const curLat = startPt.lat + (endPt.lat - startPt.lat) * progress + humidityWobble;
    const curLng = startPt.lng + (endPt.lng - startPt.lng) * progress + (Math.cos(progress * 20) * 0.003);

    const pos = [curLat, curLng];
    pigeon.setLatLng(pos);
    points.push(pos);
    trail.setLatLngs(points);
    
    // ØªØ¯ÙˆÙŠØ± Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø§Ù„Ø­Ù…Ø§Ù…Ø© Ø¨Ø§ØªØ¬Ø§Ù‡ Ø§Ù„Ø·ÙŠØ±Ø§Ù†
    document.getElementById('bird-icon').style.transform = `rotate(${bearing}deg)`;

    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª
    document.getElementById('st-birdspeed').innerText = currentMmin.toFixed(2) + " m/min";
    const remK = totalDist * (1 - progress);
    document.getElementById('st-rem-dist').innerText = remK.toFixed(2) + " Km";

    if(progress < 1) {
        const remH = remK / currentKmh;
        const etaDate = new Date(now.getTime() + remH * 3600000);
        document.getElementById('st-eta').innerText = etaDate.getHours().toString().padStart(2,'0') + ":" + 
                                                     etaDate.getMinutes().toString().padStart(2,'0') + ":" + 
                                                     etaDate.getSeconds().toString().padStart(2,'0');
        requestAnimationFrame(updateFrame);
    } else {
        document.getElementById('st-eta').innerText = "ØªÙ… Ø§Ù„ÙˆØµÙˆÙ„";
    }
}

function recordRacer() {
    const name = document.getElementById('rName').value;
    const dist = parseFloat(document.getElementById('rDist').value);
    const timeVal = document.getElementById('rTime').value;
    const startVal = document.getElementById('startTime').value;

    if(!name || !dist || !timeVal || !startVal) return alert("Ø§Ù…Ù„Ø£ ÙƒØ§ÙØ© Ø§Ù„Ø­Ù‚ÙˆÙ„");

    const start = new Date(startVal);
    const [h, m, s] = timeVal.split(':');
    const end = new Date(startVal.split('T')[0] + `T${h}:${m}:${s || '00'}`);
    
    const diffMin = (end - start) / 60000;
    const speed = (dist * 1000) / diffMin;

    racers.push({ name, dist, speed });
    racers.sort((a,b) => b.speed - a.speed);
    saveData();
    updateLeaderboard();
}

function updateLeaderboard() {
    document.getElementById('leaderboard').innerHTML = racers.map((r, i) => `
        <tr><td>${i+1}</td><td>${r.name}</td><td>${r.dist}</td><td style="color:var(--primary); font-weight:bold">${r.speed.toFixed(3)}</td></tr>
    `).join('');
}

function clearCache() {
    if(confirm("Ø³ÙŠØªÙ… Ø­Ø°Ù ÙƒØ§ÙØ© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙˆØ§Ù„Ù†ØªØ§Ø¦Ø¬ØŒ Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ØŸ")) {
        localStorage.removeItem('flight_v3');
        location.reload();
    }
}
</script>
</body>
</html>

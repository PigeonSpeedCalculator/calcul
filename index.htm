<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8">
<title>ELMAKKAOUY REAL FLIGHT</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<style>
body{margin:0;background:#0b0f19;color:#fff;font-family:Arial}
#map{height:380px}
.panel{padding:15px;background:#161b2a}
input,button{
width:100%;padding:10px;margin-top:8px;
background:#0b0f19;border:1px solid #2d3343;
color:#fff;border-radius:6px
}
button{background:#00d4ff;color:#000;font-weight:bold;cursor:pointer}
.stat{margin:6px 0;font-size:14px}
.stat b{color:#00ff88}
</style>
</head>

<body>

<div id="map"></div>

<div class="panel">

<input type="datetime-local" id="startTime">
<input id="startCoord" value="33.2722,-8.3732">
<input id="city" placeholder="Ø§ÙƒØªØ¨ Ù…Ø¯ÙŠÙ†Ø© Ø§Ù„ÙˆØµÙˆÙ„">
<button onclick="startRace()">Ø¨Ø¯Ø¡ Ø§Ù„ØªØªØ¨Ø¹ ğŸ•Šï¸</button>

<hr>

<div class="stat">ğŸ“ Ø§Ù„Ù…Ø³Ø§ÙØ©: <b id="dist">-- Km</b></div>
<div class="stat">ğŸŒ¬ï¸ Ø§Ù„Ø±ÙŠØ§Ø­: <b id="wind">-- m/min</b></div>
<div class="stat">ğŸŒ¡ï¸ Ø§Ù„Ø­Ø±Ø§Ø±Ø©: <b id="temp">-- Â°C</b></div>
<div class="stat">ğŸš€ Ø§Ù„Ø³Ø±Ø¹Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©: <b id="speed">-- m/min</b></div>

</div>

<script>
let map = L.map('map').setView([33.2722,-8.3732],7);
L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png').addTo(map);

let startMarker = L.marker([33.2722,-8.3732]).addTo(map);
let pigeon, destPoint;
let totalDistance = 0;
let windSpeed = 0;
let windDeg = 0;
let temperature = 20;

const AIR_SPEED = 1200; // m/min Ø³Ø¨Ø§Ù‚ Ø§Ø­ØªØ±Ø§ÙÙŠ

function rad(d){return d*Math.PI/180}

function bearing(a,b,c,d){
const y=Math.sin(rad(d-b))*Math.cos(rad(c));
const x=Math.cos(rad(a))*Math.sin(rad(c))-
Math.sin(rad(a))*Math.cos(rad(c))*Math.cos(rad(d-b));
return (Math.atan2(y,x)*180/Math.PI+360)%360;
}

/* ================= Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ù…Ø¯ÙŠÙ†Ø© ================= */
async function getCityCoords(name){
const res = await fetch(
`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(name)}&limit=1&accept-language=ar`
);
const data = await res.json();
if(!data.length){
alert("Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©");
return null;
}
return [parseFloat(data[0].lat),parseFloat(data[0].lon)];
}

/* ================= Ø§Ù„Ø·Ù‚Ø³ ================= */
async function loadWeather(lat,lon){
const r = await fetch(
`https://api.openweathermap.org/data/2.5/weather?lat=${lat}&lon=${lon}&appid=992e2b79f5e3386bda09d14ff4807f9d&units=metric`
);
const d = await r.json();

windSpeed = d.wind.speed * 60; // m/min
windDeg = d.wind.deg;
temperature = d.main.temp;

wind.innerText = windSpeed.toFixed(1);
temp.innerText = temperature;
}

/* ================= Ø¨Ø¯Ø¡ Ø§Ù„Ø³Ø¨Ø§Ù‚ ================= */
async function startRace(){

const s = startCoord.value.split(',');
startMarker.setLatLng([+s[0],+s[1]]);

const coords = await getCityCoords(city.value);
if(!coords) return;

destPoint = L.latLng(coords[0],coords[1]);

await loadWeather(s[0],s[1]);

totalDistance = map.distance(startMarker.getLatLng(),destPoint);
dist.innerText = (totalDistance/1000).toFixed(3);

if(pigeon) map.removeLayer(pigeon);

pigeon = L.marker(startMarker.getLatLng(),{
icon:L.divIcon({
html:"<div id='bird'>ğŸ•Šï¸</div>",
iconSize:[40,40]
})
}).addTo(map);

setInterval(()=>{
const b=document.getElementById("bird");
if(b) b.style.transform=
`translateY(${Math.sin(Date.now()/120)*4}px)`;
},60);

animateFlight();
}

/* ================= Ù…Ø­Ø§ÙƒØ§Ø© ÙˆØ§Ù‚Ø¹ÙŠØ© ================= */
function animateFlight(){
let traveled = 0;
let last = performance.now();

const start = startMarker.getLatLng();
const end = destPoint;
const routeBearing = bearing(start.lat,start.lng,end.lat,end.lng);

function step(now){
const dt = (now-last)/60000;
last = now;

/* ØªØ£Ø«ÙŠØ± Ø§Ù„Ø­Ø±Ø§Ø±Ø© */
let tempFactor = 1 - ((temperature-20)*0.005);

/* Ø²Ø§ÙˆÙŠØ© Ø§Ù„Ø±ÙŠØ§Ø­ */
const rel = rad(windDeg - routeBearing);
const windEffect = windSpeed * Math.cos(rel);

/* Ø§Ù„Ø³Ø±Ø¹Ø© Ø§Ù„Ø£Ø±Ø¶ÙŠØ© */
let groundSpeed = (AIR_SPEED * tempFactor) + windEffect;
groundSpeed = Math.max(600,groundSpeed);

speed.innerText = groundSpeed.toFixed(1);

traveled += groundSpeed * dt;

let p = traveled / totalDistance;
if(p>=1){
pigeon.setLatLng(end);
speed.innerText="ÙˆØµÙ„ âœ”";
return;
}

pigeon.setLatLng([
start.lat+(end.lat-start.lat)*p,
start.lng+(end.lng-start.lng)*p
]);

requestAnimationFrame(step);
}
requestAnimationFrame(step);
}
</script>

</body>
</html>

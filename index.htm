<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù†Ø¸Ø§Ù… Ø§Ù„Ù…ÙƒØ§ÙˆÙŠ Ø§Ù„Ù…ØªÙƒØ§Ù…Ù„ Ù„Ø³Ø¨Ø§Ù‚ Ø§Ù„Ø­Ù…Ø§Ù…</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>

    <style>
        :root { --primary: #3b82f6; --bg: #0b0f19; --card: #161b2a; }
        body { margin: 0; background: var(--bg); color: white; font-family: 'Segoe UI', sans-serif; text-align: right; }
        
        .header { background: var(--card); padding: 15px; border-bottom: 2px solid var(--primary); display: flex; justify-content: space-between; align-items: center; }
        .container { max-width: 800px; margin: 0 auto; padding: 15px; }
        
        #map { height: 300px; width: 100%; border-radius: 20px; margin-bottom: 20px; border: 1px solid #2d3748; }

        .stats-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-bottom: 20px; }
        .stat-box { background: var(--card); padding: 15px; border-radius: 15px; text-align: center; border: 1px solid #2d3748; }
        .stat-box b { display: block; color: var(--primary); font-size: 1.3rem; }

        .card { background: var(--card); border-radius: 20px; padding: 20px; margin-bottom: 15px; border: 1px solid #2d3748; }
        input { background: #0b0f19; border: 1px solid #2d3748; color: white; padding: 12px; border-radius: 10px; width: 100%; box-sizing: border-box; margin-bottom: 10px; text-align: center; }

        /* Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØªØ­ÙƒÙ… */
        .btn-group { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px; }
        .btn { padding: 12px; border-radius: 10px; border: none; font-weight: bold; cursor: pointer; transition: 0.3s; }
        .btn-upload { background: #f59e0b; color: #000; }
        .btn-radar { background: var(--primary); color: white; }

        /* Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…ØªØ³Ø§Ø¨Ù‚ÙŠÙ† */
        .racer-item { background: #1a202c; padding: 15px; border-radius: 15px; margin-bottom: 10px; border-right: 4px solid var(--primary); display: flex; justify-content: space-between; align-items: center; }
        .racer-info { flex-grow: 1; }
        .speed-tag { background: rgba(34, 197, 94, 0.2); color: #22c55e; padding: 5px 10px; border-radius: 8px; font-weight: bold; }
        
        .pigeon-icon { font-size: 28px; filter: drop-shadow(0 0 5px white); }
        .hidden { display: none; }
    </style>
</head>
<body>

<header class="header">
    <div style="font-weight: 800;">ELMAKKAOUY <span style="color:var(--primary)">CENTRAL PRO</span></div>
    <div id="liveTime" style="font-family: monospace;">21:55:00</div>
</header>

<div class="container">
    <div id="map"></div>

    <div class="stats-grid">
        <div class="stat-box"><b id="s-count">0</b><span>Ù…ØªØ³Ø§Ø¨Ù‚</span></div>
        <div class="stat-box"><b id="s-wind">--</b><span>Ø§Ù„Ø±ÙŠØ§Ø­ ÙƒÙ…/Ø³</span></div>
        <div class="stat-box"><b id="s-best">--</b><span>Ø£ÙØ¶Ù„ Ø³Ø±Ø¹Ø©</span></div>
    </div>

    <div class="card">
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
            <div>
                <label>ğŸ“ Ù†Ù‚Ø·Ø© Ø§Ù„Ø¥Ø·Ù„Ø§Ù‚ (Lat, Lng)</label>
                <input type="text" id="relCoord" value="33.2722, -8.3732">
            </div>
            <div>
                <label>ğŸ™ï¸ Ù†Ù‚Ø·Ø© Ø§Ù„Ø³Ù†Ø·Ø±Ø§Ù„ (Ø§Ù„Ù‡Ø¯Ù)</label>
                <input type="text" id="homeCoord" value="33.5731, -7.5898">
            </div>
        </div>
        <label>â° ÙˆÙ‚Øª Ø§Ù„Ø¥Ø·Ù„Ø§Ù‚ Ø§Ù„Ø±Ø³Ù…ÙŠ</label>
        <input type="datetime-local" id="relTime">

        <div class="btn-group">
            <button class="btn btn-upload" onclick="document.getElementById('fileInput').click()">ğŸ“ Ø¥Ø¯Ø±Ø§Ø¬ Ù…Ù„Ù Ø§Ù„Ù†ØªØ§Ø¦Ø¬</button>
            <button class="btn btn-radar" onclick="startRadar()">ğŸ“¡ ØªØ´ØºÙŠÙ„ Ø§Ù„Ø±Ø§Ø¯Ø§Ø± Ø§Ù„Ø­ÙŠ</button>
        </div>
        <input type="file" id="fileInput" class="hidden" accept=".pdf,.txt" onchange="handleFileUpload(event)">
    </div>

    <div id="racersList">
        </div>
</div>

<script>
    let map, pigeonMarker, pathLine, simInterval;
    let racers = [];
    const API_KEY = '992e2b79f5e3386bda09d14ff4807f9d';

    // 1. Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø®Ø±ÙŠØ·Ø©
    function initMap() {
        map = L.map('map', { zoomControl: false }).setView([33.4, -8], 7);
        L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png').addTo(map);
        document.getElementById('relTime').value = new Date().toISOString().slice(0, 16);
        updateWeather();
    }

    // 2. Ù…Ø¹Ø§Ù„Ø¬Ø© Ø±ÙØ¹ Ø§Ù„Ù…Ù„Ù ÙˆØ§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
    async function handleFileUpload(event) {
        const file = event.target.files[0];
        if (!file) return;

        // Ù…Ø­Ø§ÙƒØ§Ø© Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (ÙÙŠ Ø§Ù„ÙˆØ§Ù‚Ø¹ Ù†Ø³ØªØ®Ø¯Ù… PDF.js Ù„Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„)
        alert("Ø¬Ø§Ø±ÙŠ ØªØ­Ù„ÙŠÙ„ Ù…Ù„Ù: " + file.name);
        
        // Ø¨ÙŠØ§Ù†Ø§Øª ØªØ¬Ø±ÙŠØ¨ÙŠØ© ØªØ­Ø§ÙƒÙŠ Ù…Ø§ ÙŠØªÙ… Ø§Ø³ØªØ®Ø±Ø§Ø¬Ù‡ Ù…Ù† Ø§Ù„Ù…Ù„Ù
        racers = [
            { name: "Ù…ØªØ³Ø§Ø¨Ù‚ 1", dist: 216.65, arrival: "2026-02-09T13:20:00" },
            { name: "Ù…ØªØ³Ø§Ø¨Ù‚ 2", dist: 190.80, arrival: "2026-02-09T13:45:00" },
            { name: "Ù…ØªØ³Ø§Ø¨Ù‚ 3", dist: 207.00, arrival: "2026-02-09T14:10:00" }
        ];
        
        renderRacers();
    }

    // 3. Ø¹Ø±Ø¶ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…ØªØ³Ø§Ø¨Ù‚ÙŠÙ† ÙˆØ­Ø³Ø§Ø¨ Ø§Ù„Ø³Ø±Ø¹Ø§Øª
    function renderRacers() {
        const list = document.getElementById('racersList');
        const releaseTime = new Date(document.getElementById('relTime').value);
        let bestSpeed = 0;

        list.innerHTML = racers.map((r, i) => {
            const duration = (new Date(r.arrival) - releaseTime) / (1000 * 60); // Ø¨Ø§Ù„Ø¯Ù‚Ø§Ø¦Ù‚
            const speed = duration > 0 ? (r.dist * 1000 / duration).toFixed(2) : 0;
            if (parseFloat(speed) > bestSpeed) bestSpeed = parseFloat(speed);

            return `
                <div class="racer-item">
                    <div class="racer-info">
                        <strong>${r.name}</strong><br>
                        <small>Ø§Ù„Ù…Ø³Ø§ÙØ©: ${r.dist} ÙƒÙ… | Ø§Ù„ÙˆØµÙˆÙ„: ${r.arrival.split('T')[1]}</small>
                    </div>
                    <div class="speed-tag">${speed} m/m</div>
                </div>
            `;
        }).join('');

        document.getElementById('s-count').innerText = racers.length;
        document.getElementById('s-best').innerText = bestSpeed + " m/m";
    }

    // 4. ØªØ´ØºÙŠÙ„ Ø§Ù„Ø±Ø§Ø¯Ø§Ø±
    async function startRadar() {
        if(simInterval) clearInterval(simInterval);
        const [sLat, sLng] = document.getElementById('relCoord').value.split(',').map(n => parseFloat(n));
        const [eLat, eLng] = document.getElementById('homeCoord').value.split(',').map(n => parseFloat(n));
        const release = new Date(document.getElementById('relTime').value);

        if(pigeonMarker) map.removeLayer(pigeonMarker);
        if(pathLine) map.removeLayer(pathLine);

        pathLine = L.polyline([[sLat, sLng], [eLat, eLng]], {color: '#3b82f6', weight: 3, dashArray: '10, 10'}).addTo(map);
        pigeonMarker = L.marker([sLat, sLng], {
            icon: L.divIcon({ html: 'ğŸ•Šï¸', className: 'pigeon-icon' })
        }).addTo(map);

        map.fitBounds(pathLine.getBounds(), {padding: [50, 50]});

        simInterval = setInterval(() => {
            const now = new Date();
            const elapsedHours = (now - release) / (1000 * 60 * 60);
            if(elapsedHours < 0) return;

            const totalDist = L.latLng(sLat, sLng).distanceTo(L.latLng(eLat, eLng)) / 1000;
            const progress = Math.min((elapsedHours * 70) / totalDist, 1); // Ø³Ø±Ø¹Ø© 70 ÙƒÙ…/Ø³
            
            const curLat = sLat + (eLat - sLat) * progress;
            const curLng = sLng + (eLng - sLng) * progress;
            pigeonMarker.setLatLng([curLat, curLng]);

            if(progress >= 1) clearInterval(simInterval);
        }, 1000);
    }

    async function updateWeather() {
        const [lat, lng] = document.getElementById('relCoord').value.split(',');
        try {
            const res = await fetch(`https://api.openweathermap.org/data/2.5/weather?lat=${lat.trim()}&lon=${lng.trim()}&appid=${API_KEY}&units=metric`);
            const data = await res.json();
            document.getElementById('s-wind').innerText = (data.wind.speed * 3.6).toFixed(1);
        } catch(e) {}
    }

    setInterval(() => {
        document.getElementById('liveTime').innerText = new Date().toTimeString().split(' ')[0];
    }, 1000);

    initMap();
</script>
</body>
</html>

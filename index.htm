<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8">
<title>ELMAKKAOUY PIGEON RACE PRO</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<style>
body{margin:0;background:#0b0f19;color:#fff;font-family:Arial}
#map{height:380px}
.panel{padding:15px;background:#161b2a}
input,button{
width:100%;padding:10px;margin-top:8px;
background:#0b0f19;border:1px solid #2d3343;
color:#fff;border-radius:6px
}
button{background:#00d4ff;color:#000;font-weight:bold;cursor:pointer}
.stat{font-size:14px;margin:5px 0}
.stat b{color:#00d4ff}
.card{
background:#0b0f19;padding:8px;border-radius:6px;
margin-top:5px;border-left:3px solid #00d4ff
}
table{width:100%;border-collapse:collapse;margin-top:10px}
th,td{padding:8px;text-align:center}
th{background:#0b0f19}
td{border-bottom:1px solid #2d3343}
</style>
</head>

<body>

<div id="map"></div>

<div class="panel">
<div class="stat">â° ØªÙˆÙ‚ÙŠØª Ø§Ù„Ø§Ù†Ø·Ù„Ø§Ù‚ Ø§Ù„Ø±Ø³Ù…ÙŠ</div>
<input type="datetime-local" id="startTime">

<div class="stat">ğŸ“ Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª Ø§Ù„Ø§Ù†Ø·Ù„Ø§Ù‚</div>
<input id="startCoord" value="33.2722,-8.3732">

<div class="stat">ğŸ Ù…Ø¯ÙŠÙ†Ø© Ø§Ù„ÙˆØµÙˆÙ„</div>
<input id="city" placeholder="Ù…Ø«Ø§Ù„: Casablanca">

<button onclick="startRace()">Ø¨Ø¯Ø¡ Ø§Ù„Ø³Ø¨Ø§Ù‚ ğŸ•Šï¸</button>

<hr>

<h3>Ø¥Ø¶Ø§ÙØ© Ù…ØªØ³Ø§Ø¨Ù‚</h3>
<input id="name" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…ØªØ³Ø§Ø¨Ù‚">
<input id="arrival" type="datetime-local">
<button onclick="addRacer()">Ø¥Ø¶Ø§ÙØ©</button>

<div id="list"></div>

<button onclick="calculate()">ğŸ† Ø­Ø³Ø§Ø¨ Ø§Ù„Ù†ØªØ§Ø¦Ø¬ ÙˆØ§Ù„ØªØ±ØªÙŠØ¨</button>

<div id="results"></div>
</div>

<script>
/* ================= MAP ================= */
let map = L.map('map').setView([33.2722,-8.3732],7);
L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png')
.addTo(map);

let startMarker = L.marker([33.2722,-8.3732]).addTo(map);
let pigeon, destPoint, distanceMeters;

/* ================= DATA ================= */
let racers = [];

/* ================= START RACE ================= */
async function startRace(){
const s = startCoord.value.split(',');
startMarker.setLatLng([+s[0],+s[1]]);

const geo = await fetch(
`https://nominatim.openstreetmap.org/search?format=json&q=${city.value}&limit=1`
);
const g = await geo.json();
destPoint = L.latLng(+g[0].lat,+g[0].lon);

distanceMeters = map.distance(startMarker.getLatLng(),destPoint);

L.polyline([startMarker.getLatLng(),destPoint],
{color:'#00d4ff',dashArray:'6,6'}).addTo(map);

map.fitBounds([startMarker.getLatLng(),destPoint],{padding:[40,40]});

/* Ø­Ù…Ø§Ù…Ø© */
if(pigeon) map.removeLayer(pigeon);
pigeon = L.marker(startMarker.getLatLng(),
{icon:L.divIcon({html:'ğŸ•Šï¸',iconSize:[30,30]})}).addTo(map);

animatePigeon();
}

/* ================= PIGEON TRACK ================= */
function animatePigeon(){
let p = 0;
function step(){
p += 0.002;
if(p>=1){pigeon.setLatLng(destPoint);return;}
pigeon.setLatLng([
startMarker.getLatLng().lat +
(destPoint.lat-startMarker.getLatLng().lat)*p,
startMarker.getLatLng().lng +
(destPoint.lng-startMarker.getLatLng().lng)*p
]);
requestAnimationFrame(step);
}
step();
}

/* ================= ADD RACER ================= */
function addRacer(){
racers.push({
name:name.value,
arrival:new Date(arrival.value)
});
list.innerHTML = racers.map(r=>`
<div class="card">${r.name} â€“ ÙˆØµÙˆÙ„: ${r.arrival.toLocaleTimeString()}</div>
`).join('');
name.value='';
}

/* ================= CALCULATE ================= */
function calculate(){
const start = new Date(startTime.value);

const res = racers.map(r=>{
const timeSec = (r.arrival - start)/1000;
const speed = distanceMeters / timeSec;
return {...r,timeSec,speed};
}).sort((a,b)=>b.speed-a.speed);

results.innerHTML = `
<table>
<thead>
<tr>
<th>#</th>
<th>Ø§Ù„Ø§Ø³Ù…</th>
<th>Ø§Ù„Ø²Ù…Ù† (Ø«)</th>
<th>Ø§Ù„Ø³Ø±Ø¹Ø© (Ù…/Ø«)</th>
</tr>
</thead>
<tbody>
${res.map((r,i)=>`
<tr>
<td>${i+1}</td>
<td>${r.name}</td>
<td>${r.timeSec.toFixed(2)}</td>
<td style="color:#10b981">${r.speed.toFixed(3)}</td>
</tr>
`).join('')}
</tbody>
</table>`;
}
</script>

</body>
</html>

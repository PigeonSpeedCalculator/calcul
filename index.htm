<!DOCTYPE html>
<html lang="ar">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ELMAKKAOUY RADAR PRO 2026</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <style>
        :root { --primary: #00d4ff; --bg: #050a14; --card: #111827; --accent: #10b981; }
        body { margin: 0; background: var(--bg); color: white; font-family: 'Segoe UI', Tahoma, sans-serif; overflow: hidden; }
        
        /* Navigation Tabs */
        .nav-tabs { display: flex; background: #111827; border-bottom: 2px solid #1e293b; position: sticky; top: 0; z-index: 2000; }
        .tab-link { flex: 1; padding: 15px; text-align: center; cursor: pointer; font-weight: bold; color: #94a3b8; transition: 0.3s; border-bottom: 3px solid transparent; }
        .tab-link.active { color: var(--primary); border-bottom-color: var(--primary); background: rgba(0, 212, 255, 0.05); }

        .page { display: none; height: calc(100vh - 55px); overflow-y: auto; padding: 20px; box-sizing: border-box; }
        .page.active { display: block; }

        /* Dashboard Styles */
        .grid-layout { display: grid; grid-template-columns: 1fr 350px; gap: 20px; }
        @media (max-width: 850px) { .grid-layout { grid-template-columns: 1fr; } }

        #map { height: 450px; border-radius: 15px; border: 1px solid var(--primary); box-shadow: 0 0 20px rgba(0,212,255,0.1); }
        
        .control-panel { background: var(--card); padding: 20px; border-radius: 15px; border: 1px solid #1e293b; }
        .input-group { margin-bottom: 15px; position: relative; }
        label { display: block; font-size: 11px; color: var(--primary); margin-bottom: 5px; font-weight: bold; }
        input { background: #050a14; border: 1px solid #334155; color: white; padding: 12px; border-radius: 8px; width: 100%; box-sizing: border-box; }

        .weather-info { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin-top: 20px; }
        .w-item { background: #1e293b; padding: 10px; border-radius: 10px; text-align: center; border: 1px solid #334155; }
        .w-item small { display: block; font-size: 10px; color: #94a3b8; }
        .w-item b { color: var(--primary); font-size: 1.1rem; }

        /* Calculator Styles */
        .racer-entry { background: var(--card); padding: 20px; border-radius: 15px; margin-bottom: 20px; border: 1px solid var(--primary); }
        .racer-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 15px; }
        .racer-card { background: #1e293b; padding: 15px; border-radius: 12px; border-left: 4px solid var(--primary); }
        
        .time-inputs { display: flex; gap: 10px; align-items: center; margin-top: 10px; }
        .time-inputs input { text-align: center; font-size: 1.1rem; font-weight: bold; }

        .btn { background: var(--primary); color: #000; border: none; padding: 12px 25px; border-radius: 8px; font-weight: bold; cursor: pointer; transition: 0.3s; }
        .btn-calc { background: var(--accent); color: white; width: 100%; font-size: 1.2rem; margin-top: 20px; }

        /* Results Display */
        #captureArea { background: white; color: black; border-radius: 15px; overflow: hidden; display: none; margin-top: 30px; }
        .res-table { width: 100%; border-collapse: collapse; }
        .res-table th { background: #0f172a; color: white; padding: 15px; }
        .res-table td { padding: 12px; border-bottom: 1px solid #eee; text-align: center; font-weight: 500; }

        .suggestions { background: #1e293b; position: absolute; width: 100%; z-index: 1000; border-radius: 8px; max-height: 200px; overflow-y: auto; box-shadow: 0 10px 20px rgba(0,0,0,0.5); }
        .s-item { padding: 10px; cursor: pointer; border-bottom: 1px solid #334155; }
        .s-item:hover { background: var(--primary); color: #000; }
    </style>
</head>
<body>

    <nav class="nav-tabs">
        <div class="tab-link active" onclick="openTab(event, 'radarPage')">ğŸ“¡ Ø§Ù„Ø±Ø§Ø¯Ø§Ø± ÙˆØ§Ù„ØªØªØ¨Ø¹</div>
        <div class="tab-link" onclick="openTab(event, 'calcPage')">â±ï¸ Ø­Ø³Ø§Ø¨ Ø§Ù„Ø³Ø±Ø¹Ø© ÙˆØ§Ù„Ù†ØªØ§Ø¦Ø¬</div>
    </nav>

    <div id="radarPage" class="page active">
        <div class="grid-layout">
            <div class="main-map">
                <div id="map"></div>
                <div class="weather-info">
                    <div class="w-item"><small>Ø§Ù„Ø±ÙŠØ§Ø­</small><b id="ws">--</b></div>
                    <div class="w-item"><small>Ø§Ù„Ø§ØªØ¬Ø§Ù‡</small><b id="wd">--</b></div>
                    <div class="w-item"><small>Ø§Ù„Ø­Ø±Ø§Ø±Ø©</small><b id="wt">--</b></div>
                </div>
            </div>

            <div class="control-panel">
                <h3 style="margin-top:0; color:var(--primary)">Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø³Ø¨Ø§Ù‚</h3>
                <div class="input-group">
                    <label>ğŸ“ Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª Ø§Ù„Ø§Ù†Ø·Ù„Ø§Ù‚</label>
                    <input type="text" id="startPos" value="33.2722, -8.3732" onchange="updateRadar()">
                </div>
                <div class="input-group">
                    <label>ğŸ Ù…Ø¯ÙŠÙ†Ø© Ø§Ù„ÙˆØµÙˆÙ„ (Ø¨Ø­Ø« Ø°ÙƒÙŠ)</label>
                    <input type="text" id="citySearch" placeholder="Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„Ù…Ø¯ÙŠÙ†Ø© Ù‡Ù†Ø§..." oninput="smartSearch(this.value)">
                    <div id="suggestBox" class="suggestions"></div>
                </div>
                <div class="input-group">
                    <label>â° ÙˆÙ‚Øª Ø§Ù„Ø§Ù†Ø·Ù„Ø§Ù‚</label>
                    <input type="datetime-local" id="startTime">
                </div>
                <div style="background: rgba(0,212,255,0.1); padding: 15px; border-radius: 10px; text-align: center;">
                    <small>Ø§Ù„Ù…Ø³Ø§ÙØ© Ø§Ù„ØªÙ‚Ø±ÙŠØ¨ÙŠØ©</small>
                    <div id="liveDist" style="font-size: 1.5rem; font-weight: bold; color: var(--primary);">0.000 Km</div>
                </div>
            </div>
        </div>
    </div>

    <div id="calcPage" class="page">
        <div class="racer-entry">
            <div style="display: flex; gap: 10px;">
                <input type="text" id="racerName" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…ØªØ³Ø§Ø¨Ù‚ (Ù…Ø«Ø§Ù„: Ø¹Ø§Ø¦Ù„Ø© Ø§Ù„Ù…ÙƒØ§ÙˆÙŠ)">
                <button class="btn" onclick="addRacerToList()">Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…ØªØ³Ø§Ø¨Ù‚ +</button>
            </div>
        </div>

        <div id="racersList" class="racer-list">
            </div>

        <button class="btn btn-calc" onclick="calculateFinalResults()">ğŸ† Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©</button>

        <div id="captureArea">
            <div style="background:#0f172a; color:#00d4ff; padding:20px; text-align:center;">
                <h2 style="margin:0;">ELMAKKAOUY RADAR - OFFICIAL</h2>
                <div id="raceSummary" style="font-size:12px; margin-top:5px;"></div>
            </div>
            <table class="res-table" id="resTable">
                <thead>
                    <tr>
                        <th>Ø§Ù„Ø±ØªØ¨Ø©</th>
                        <th>Ø§Ù„Ø§Ø³Ù…</th>
                        <th>Ø§Ù„Ù…Ø³Ø§ÙØ©</th>
                        <th>Ø§Ù„ÙˆØµÙˆÙ„</th>
                        <th>Ø§Ù„Ø³Ø±Ø¹Ø© (Ù…/Ø¯)</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
        <button class="btn" style="width:100%; margin-top:10px; background:#475569; color:white;" onclick="downloadImage()">ğŸ“¸ Ø­ÙØ¸ Ø§Ù„Ù†ØªÙŠØ¬Ø© ÙƒØµÙˆØ±Ø©</button>
    </div>

<script>
    let map, startMarker, racers = [];
    let destCoord = null;

    // 1. Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØªØ¨ÙˆÙŠØ¨Ø§Øª
    function openTab(evt, tabName) {
        document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
        document.querySelectorAll('.tab-link').forEach(l => l.classList.remove('active'));
        document.getElementById(tabName).classList.add('active');
        evt.currentTarget.classList.add('active');
        if(tabName === 'radarPage') setTimeout(() => map.invalidateSize(), 200);
    }

    // 2. Ø§Ù„Ø±Ø§Ø¯Ø§Ø± ÙˆØ§Ù„Ø®Ø±Ø§Ø¦Ø·
    window.onload = () => {
        map = L.map('map', { zoomControl: false }).setView([33.2722, -8.3732], 7);
        L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png').addTo(map);
        startMarker = L.marker([33.2722, -8.3732]).addTo(map);
        
        const now = new Date();
        now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
        document.getElementById('startTime').value = now.toISOString().slice(0,16);
        updateRadar();
    };

    async function smartSearch(val) {
        if(val.length < 3) return;
        const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${val}&limit=5`);
        const data = await res.json();
        const box = document.getElementById('suggestBox');
        box.innerHTML = data.map(d => `<div class="s-item" onclick="selectCity('${d.display_name}', ${d.lat}, ${d.lon})">${d.display_name}</div>`).join('');
    }

    function selectCity(name, lat, lon) {
        document.getElementById('citySearch').value = name.split(',')[0];
        document.getElementById('suggestBox').innerHTML = '';
        destCoord = [lat, lon];
        
        const dist = (map.distance(startMarker.getLatLng(), destCoord) / 1000).toFixed(3);
        document.getElementById('liveDist').innerText = dist + " Km";
        
        L.marker(destCoord, {icon: L.divIcon({html:'ğŸ', className:''})}).addTo(map);
        map.fitBounds([startMarker.getLatLng(), destCoord], {padding:[50,50]});
    }

    async function updateRadar() {
        const c = document.getElementById('startPos').value.split(',');
        const lat = parseFloat(c[0]), lng = parseFloat(c[1]);
        startMarker.setLatLng([lat, lng]);
        map.setView([lat, lng]);

        const res = await fetch(`https://api.openweathermap.org/data/2.5/weather?lat=${lat}&lon=${lng}&appid=992e2b79f5e3386bda09d14ff4807f9d&units=metric`);
        const d = await res.json();
        document.getElementById('ws').innerText = (d.wind.speed * 3.6).toFixed(1) + " km/h";
        document.getElementById('wt').innerText = d.main.temp + "Â°C";
        const dirs = ['N','NE','E','SE','S','SW','W','NW'];
        document.getElementById('wd').innerText = dirs[Math.round(d.wind.deg/45)%8];
    }

    // 3. Ù…Ù†ØµØ© Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª
    function addRacerToList() {
        const name = document.getElementById('racerName').value;
        const distText = document.getElementById('liveDist').innerText.split(' ')[0];
        if(!name || distText == "0.000") return alert("ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø§Ø³Ù… ÙˆØªØ­Ø¯ÙŠØ¯ Ù…Ø¯ÙŠÙ†Ø© Ø§Ù„ÙˆØµÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹!");

        racers.push({ name, dist: distText, h:12, m:0, s:0 });
        renderRacers();
        document.getElementById('racerName').value = '';
    }

    function renderRacers() {
        const container = document.getElementById('racersList');
        container.innerHTML = racers.map((r, i) => `
            <div class="racer-card">
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <b>${r.name}</b>
                    <small style="color:var(--primary)">${r.dist} Km</small>
                </div>
                <div class="time-inputs">
                    <input type="number" value="${r.h}" oninput="racers[${i}].h=this.value" min="0" max="23"> :
                    <input type="number" value="${r.m}" oninput="racers[${i}].m=this.value" min="0" max="59"> :
                    <input type="number" value="${r.s}" oninput="racers[${i}].s=this.value" min="0" max="59">
                </div>
            </div>
        `).join('');
    }

    function calculateFinalResults() {
        const startT = new Date(document.getElementById('startTime').value);
        let results = [];

        racers.forEach(r => {
            let arrival = new Date(startT);
            arrival.setHours(r.h, r.m, r.s);
            let diffMin = (arrival - startT) / 60000;
            if(diffMin > 0) {
                let speed = (parseFloat(r.dist) * 1000) / diffMin;
                results.push({ ...r, speed, arrivalStr: `${r.h}:${r.m}:${r.s}` });
            }
        });

        results.sort((a,b) => b.speed - a.speed);
        
        const tbody = document.querySelector('#resTable tbody');
        tbody.innerHTML = results.map((r, i) => `
            <tr>
                <td>${i+1}</td>
                <td style="text-align:right"><b>${r.name}</b></td>
                <td>${r.dist} Km</td>
                <td>${r.arrivalStr}</td>
                <td style="color:var(--accent); font-weight:bold;">${r.speed.toFixed(3)}</td>
            </tr>
        `).join('');
        
        document.getElementById('raceSummary').innerText = `Ù†Ù‚Ø·Ø© Ø§Ù„Ø§Ù†Ø·Ù„Ø§Ù‚: ${document.getElementById('startPos').value} | Ù…Ø¯ÙŠÙ†Ø© Ø§Ù„ÙˆØµÙˆÙ„: ${document.getElementById('citySearch').value}`;
        document.getElementById('captureArea').style.display = 'block';
    }

    function downloadImage() {
        html2canvas(document.getElementById('captureArea')).then(canvas => {
            const a = document.createElement('a');
            a.download = 'ELMAKKAOUY_RESULTS.png';
            a.href = canvas.toDataURL();
            a.click();
        });
    }
</script>
</body>
</html>

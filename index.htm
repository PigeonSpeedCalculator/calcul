<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ELMAKKAOUY V6 PRO</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

<style>
body{margin:0;background:#020617;color:white;font-family:Segoe UI}
#map{height:50vh}
.panel{padding:15px;background:#1e293b}
input,button{width:100%;padding:10px;margin-top:5px;border:none}
button{background:#00d4ff;color:black;font-weight:bold;cursor:pointer}
.stats{display:grid;grid-template-columns:repeat(2,1fr);gap:8px;padding:10px;background:#0f172a}
.stat{font-size:13px}
#suggest{background:#1e293b;position:absolute;z-index:999;width:90%;max-height:150px;overflow:auto;display:none}
</style>
</head>

<body>

<div id="map"></div>

<div class="stats">
<div class="stat">Ø§Ù„Ø³Ø±Ø¹Ø©: <span id="speed">0</span></div>
<div class="stat">Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ: <span id="remain">0</span></div>
<div class="stat">Ø§Ù„Ø±ÙŠØ§Ø­: <span id="wind">--</span></div>
<div class="stat">Ø§Ù„Ø±Ø·ÙˆØ¨Ø©: <span id="humidity">--</span></div>
</div>

<div class="panel">
<input id="startCoords" placeholder="Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª Ø§Ù„Ø§Ù†Ø·Ù„Ø§Ù‚ 33.57,-7.58">
<input id="endCity" placeholder="Ø§ÙƒØªØ¨ Ù…Ø¯ÙŠÙ†Ø© Ø§Ù„ÙˆØµÙˆÙ„" oninput="searchCity(this.value)">
<div id="suggest"></div>
<input type="time" id="startClock" step="1">
<button onclick="initFlight()">Ø¨Ø¯Ø¡ Ø§Ù„Ø·ÙŠØ±Ø§Ù†</button>
</div>

<div class="panel">
<h3>Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ù…ØªØ³Ø§Ø¨Ù‚ÙŠÙ†</h3>
<input id="rName" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…ØªØ³Ø§Ø¨Ù‚">
<input id="rDist" type="number" placeholder="Ø§Ù„Ù…Ø³Ø§ÙØ© Km">
<input id="rArrival" type="time" step="1">
<button onclick="recordRacer()">Ø­Ø³Ø§Ø¨ Ø§Ù„Ù†ØªÙŠØ¬Ø©</button>
<table width="100%" id="board"></table>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
let map=L.map('map').setView([33.5,-7.5],6);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

let startPt,endPt,currentPos;
let pigeon,trail;
let BASE_SPEED=70;
let weather={speed:15,deg:300,humidity:60};
let lastFrame=null;
let racers=[];

// ---------- Ø£Ø¯ÙˆØ§Øª ----------

function toRad(x){return x*Math.PI/180}
function toDeg(x){return x*180/Math.PI}
function distance(a,b){
return map.distance([a.lat,a.lng],[b.lat,b.lng])/1000;
}

function windDirectionName(deg){
if(deg>=337||deg<22)return"Ø´Ù…Ø§Ù„ÙŠØ©";
if(deg<67)return"Ø´Ù…Ø§Ù„ÙŠØ© Ø´Ø±Ù‚ÙŠØ©";
if(deg<112)return"Ø´Ø±Ù‚ÙŠØ©";
if(deg<157)return"Ø¬Ù†ÙˆØ¨ÙŠØ© Ø´Ø±Ù‚ÙŠØ©";
if(deg<202)return"Ø¬Ù†ÙˆØ¨ÙŠØ©";
if(deg<247)return"Ø¬Ù†ÙˆØ¨ÙŠØ© ØºØ±Ø¨ÙŠØ©";
if(deg<292)return"ØºØ±Ø¨ÙŠØ©";
return"Ø´Ù…Ø§Ù„ÙŠØ© ØºØ±Ø¨ÙŠØ©";
}

// ---------- Ø¨Ø­Ø« Ù…Ø¯ÙŠÙ†Ø© ----------

async function searchCity(q){
if(q.length<3)return;
const r=await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${q}&limit=5`);
const d=await r.json();
let box=document.getElementById("suggest");
box.style.display="block";
box.innerHTML=d.map(x=>
`<div style="padding:6px;cursor:pointer"
onclick="selectCity(${x.lat},${x.lon},'${x.display_name}')">
${x.display_name}</div>`).join('');
}

function selectCity(lat,lon,name){
endPt={lat:parseFloat(lat),lng:parseFloat(lon)};
document.getElementById("endCity").value=name.split(',')[0];
document.getElementById("suggest").style.display="none";
map.setView([lat,lon],8);
}

// ---------- Ø¨Ø¯Ø¡ Ø§Ù„Ø·ÙŠØ±Ø§Ù† ----------

function initFlight(){

let sc=document.getElementById("startCoords").value.split(",");
startPt={lat:parseFloat(sc[0]),lng:parseFloat(sc[1])};

currentPos={...startPt};

if(pigeon)map.removeLayer(pigeon);
if(trail)map.removeLayer(trail);

pigeon=L.marker(startPt,{
icon:L.divIcon({html:"ğŸ•Šï¸",className:""})
}).addTo(map);

trail=L.polyline([],{
color:"#00d4ff",
weight:3
}).addTo(map);

map.fitBounds([startPt,endPt]);

lastFrame=performance.now();
requestAnimationFrame(updateFlight);
}

// ---------- Ù…Ø­Ø±Ùƒ Ø§Ù„Ø·ÙŠØ±Ø§Ù† ----------

function updateFlight(t){

let dt=(t-lastFrame)/1000;
lastFrame=t;

let bearing=Math.atan2(
endPt.lng-currentPos.lng,
endPt.lat-currentPos.lat
);

let windEffect=weather.speed*
Math.cos(toRad(weather.deg)-bearing);

let humidityFactor=1+(weather.humidity/200);

let speed=BASE_SPEED+windEffect*0.5;
if(speed<40)speed=40;

let moveKm=(speed/3600)*dt;

let driftLat=Math.sin(t/5000)*0.001*humidityFactor;
let driftLng=Math.cos(t/6000)*0.001*humidityFactor;

currentPos.lat+=moveKm*Math.cos(bearing)+driftLat;
currentPos.lng+=moveKm*Math.sin(bearing)+driftLng;

pigeon.setLatLng([currentPos.lat,currentPos.lng]);

trail.addLatLng([currentPos.lat,currentPos.lng]);

document.getElementById("speed")
.innerText=((speed*1000)/60).toFixed(1)+" Ù…/Ø¯";

document.getElementById("remain")
.innerText=distance(currentPos,endPt).toFixed(2)+" Km";

document.getElementById("wind")
.innerText=weather.speed+" km/h "+windDirectionName(weather.deg);

document.getElementById("humidity")
.innerText=weather.humidity+"%";

if(distance(currentPos,endPt)<0.3)return;

requestAnimationFrame(updateFlight);
}

// ---------- Ù†ØªØ§Ø¦Ø¬ ----------

function recordRacer(){

let name=document.getElementById("rName").value;
let dist=parseFloat(document.getElementById("rDist").value);
let arrival=document.getElementById("rArrival").value;
let start=document.getElementById("startClock").value;

if(!name||!dist||!arrival||!start)
return alert("Ø£Ø¯Ø®Ù„ ÙƒÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª");

let [sh,sm,ss]=start.split(':');
let [ah,am,as]=arrival.split(':');

let startSec=(+sh*3600)+(+sm*60)+(+ss||0);
let arrivalSec=(+ah*3600)+(+am*60)+(+as||0);

let flightMin=(arrivalSec-startSec)/60;
if(flightMin<=0)return alert("ÙˆÙ‚Øª ØºÙŠØ± ØµØ­ÙŠØ­");

let speed=(dist*1000)/flightMin;

racers.push({name,dist,speed});

racers.sort((a,b)=>b.speed-a.speed);

renderBoard();
}

function renderBoard(){
document.getElementById("board").innerHTML=
racers.map((r,i)=>
`<tr>
<td>${i+1}</td>
<td>${r.name}</td>
<td>${r.dist}</td>
<td>${r.speed.toFixed(2)} Ù…/Ø¯</td>
</tr>`).join('');
}

</script>
</body>
</html>

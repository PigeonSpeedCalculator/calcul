<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø±Ø§Ø¯Ø§Ø± Ø§Ù„Ù…ÙƒØ§ÙˆÙŠ Ø§Ù„Ø§Ø­ØªØ±Ø§ÙÙŠ - ELMAKKAOUY RADAR</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <style>
        :root { --primary: #3b82f6; --bg: #0b0f19; --card: #161b2a; }
        body { margin: 0; background: var(--bg); color: white; font-family: 'Segoe UI', sans-serif; text-align: right; }
        
        .header { background: var(--card); padding: 15px; border-bottom: 2px solid var(--primary); display: flex; justify-content: space-between; align-items: center; box-shadow: 0 4px 15px rgba(0,0,0,0.4); }
        .container { max-width: 800px; margin: 0 auto; padding: 15px; }
        
        /* Ø§Ù„Ø®Ø±ÙŠØ·Ø© */
        #map { height: 350px; width: 100%; border-radius: 20px; margin-bottom: 20px; border: 1px solid #2d3748; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }

        /* Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª */
        .stats-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; margin-bottom: 20px; }
        .stat-box { background: var(--card); padding: 15px; border-radius: 15px; text-align: center; border: 1px solid #2d3748; }
        .stat-box b { display: block; color: var(--primary); font-size: 1.4rem; }
        .stat-box span { font-size: 11px; color: #718096; text-transform: uppercase; }

        /* Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„ */
        .card { background: var(--card); border-radius: 20px; padding: 20px; border: 1px solid #2d3748; margin-bottom: 20px; }
        label { font-size: 12px; color: #718096; font-weight: bold; margin-bottom: 8px; display: block; }
        input, textarea { background: #0b0f19; border: 1px solid #2d3748; color: white; padding: 12px; border-radius: 10px; width: 100%; box-sizing: border-box; margin-bottom: 15px; font-size: 15px; text-align: center; }
        
        textarea { height: 100px; text-align: right; font-size: 13px; }

        .btn { padding: 15px; border-radius: 12px; border: none; font-weight: bold; cursor: pointer; width: 100%; font-size: 15px; transition: 0.3s; }
        .btn-process { background: #f59e0b; color: black; margin-bottom: 10px; }
        .btn-radar { background: var(--primary); color: white; }

        /* Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù†ØªØ§Ø¦Ø¬ */
        .results-list { margin-top: 20px; }
        .racer-card { background: #1e293b; padding: 15px; border-radius: 15px; margin-bottom: 10px; border-right: 4px solid var(--primary); display: flex; justify-content: space-between; align-items: center; animation: slideIn 0.3s ease; }
        
        .pigeon-icon { font-size: 24px; text-shadow: 0 0 10px white; }
        @keyframes slideIn { from { opacity: 0; transform: translateX(20px); } to { opacity: 1; transform: translateX(0); } }
    </style>
</head>
<body>

<header class="header">
    <div style="font-weight: 900; font-size: 1.3rem;">ELMAKKAOUY <span style="color:var(--primary)">RADAR V4</span></div>
    <div id="liveClock" style="font-family: monospace; color: var(--primary); font-weight: bold;">00:00:00</div>
</header>

<div class="container">
    <div id="map"></div>

    <div class="stats-grid">
        <div class="stat-box"><b id="s-count">0</b><span>Ù…ØªØ³Ø§Ø¨Ù‚</span></div>
        <div class="stat-box"><b id="s-wind">--</b><span>Ø§Ù„Ø±ÙŠØ§Ø­ ÙƒÙ…/Ø³</span></div>
        <div class="stat-box"><b id="s-best">--</b><span>Ø£ÙØ¶Ù„ Ø³Ø±Ø¹Ø©</span></div>
    </div>

    <div class="card">
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
            <div>
                <label>ğŸ“ Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª Ø§Ù„Ø¥Ø·Ù„Ø§Ù‚ (Lat, Lng)</label>
                <input type="text" id="relCoord" value="33.2722, -8.3732">
            </div>
            <div>
                <label>ğŸ™ï¸ Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª Ø§Ù„Ø³Ù†Ø·Ø±Ø§Ù„ (Ø§Ù„Ù‡Ø¯Ù)</label>
                <input type="text" id="homeCoord" value="33.5731, -7.5898">
            </div>
        </div>
        
        <label>â° ÙˆÙ‚Øª Ø§Ù„Ø¥Ø·Ù„Ø§Ù‚ Ø§Ù„Ø±Ø³Ù…ÙŠ</label>
        <input type="datetime-local" id="relTime">

        <label>ğŸ“‹ Ø§Ù„ØµÙ‚ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ØªØ³Ø§Ø¨Ù‚ÙŠÙ† Ù‡Ù†Ø§ (Ø§Ù„Ø§Ø³Ù… ÙˆØ§Ù„Ù…Ø³Ø§ÙØ©)</label>
        <textarea id="dataInput" placeholder="Ù…Ø«Ø§Ù„: Ø¹Ø«Ù…Ø§Ù† 216.65 14:20:05"></textarea>

        <button class="btn btn-process" onclick="processData()">ğŸ“¥ Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙˆØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆØ§Ù‚Ø¹</button>
        <button class="btn btn-radar" onclick="startRadarSim()">ğŸ“¡ Ø¨Ø¯Ø¡ Ø§Ù„Ø±Ø§Ø¯Ø§Ø± Ø§Ù„Ø­ÙŠ</button>
    </div>

    <div id="results" class="results-list"></div>
</div>

<script>
    let map, markers = [], simInterval;
    const API_KEY = '992e2b79f5e3386bda09d14ff4807f9d';

    function initMap() {
        map = L.map('map', { zoomControl: false }).setView([33.4, -8], 8);
        L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png').addTo(map);
        
        // Ø¶Ø¨Ø· Ø§Ù„ÙˆÙ‚Øª Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ
        const now = new Date();
        now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
        document.getElementById('relTime').value = now.toISOString().slice(0, 16);
        updateWeather();
    }

    // Ø§Ù„Ù…Ø­Ø±Ùƒ Ø§Ù„Ø°ÙƒÙŠ Ù„Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙˆØ­Ø³Ø§Ø¨ Ø§Ù„Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª
    function processData() {
        const text = document.getElementById('dataInput').value;
        const start = document.getElementById('relCoord').value.split(',').map(Number);
        const end = document.getElementById('homeCoord').value.split(',').map(Number);
        
        if (!text) return alert("Ø§Ù„Ø±Ø¬Ø§Ø¡ Ù„ØµÙ‚ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø£ÙˆÙ„Ø§Ù‹");

        // ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø®Ø±ÙŠØ·Ø©
        markers.forEach(m => map.removeLayer(m));
        markers = [];
        
        const lines = text.split('\n');
        let html = "";
        let count = 0;

        lines.forEach((line) => {
            // ÙƒØ§Ø´Ù Ø§Ù„Ù…Ø³Ø§ÙØ§Øª: ÙŠØ¨Ø­Ø« Ø¹Ù† Ø£Ø±Ù‚Ø§Ù… Ù…Ø«Ù„ 216.65
            const distMatch = line.match(/(\d{2,3}\.\d{1,3})/);
            if (distMatch) {
                const distance = parseFloat(distMatch[0]);
                count++;

                // Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª Ø§Ù„Ø¬ØºØ±Ø§ÙÙŠØ© Ù„Ù„Ù…ØªØ³Ø§Ø¨Ù‚ Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø³Ø§ÙØ© Ù…Ù† Ù†Ù‚Ø·Ø© Ø§Ù„Ø¥Ø·Ù„Ø§Ù‚
                const totalPathDist = L.latLng(start).distanceTo(L.latLng(end)) / 1000;
                const ratio = Math.min(distance / totalPathDist, 1);
                
                const racerLat = start[0] + (end[0] - start[0]) * ratio;
                const racerLng = start[1] + (end[1] - start[1]) * ratio;

                // Ø¥Ø¶Ø§ÙØ© Ù…Ø§Ø±ÙƒØ± Ø§Ù„Ù…ØªØ³Ø§Ø¨Ù‚
                const m = L.marker([racerLat, racerLng], {
                    icon: L.divIcon({ html: 'ğŸ•Šï¸', className: 'pigeon-marker', iconSize: [25, 25] })
                }).addTo(map).bindPopup(`Ø§Ù„Ù…Ø³Ø§ÙØ©: ${distance} ÙƒÙ…`);
                markers.push(m);

                html += `
                    <div class="racer-card">
                        <div><b>Ù…ØªØ³Ø§Ø¨Ù‚ Ø±Ù‚Ù… ${count}</b><br><small>Ø§Ù„Ù…Ø³Ø§ÙØ©: ${distance} ÙƒÙ…</small></div>
                        <div style="color:var(--primary); font-weight:bold;">ğŸ“ ØªÙ… Ø§Ù„ØªØ­Ø¯ÙŠØ¯</div>
                    </div>
                `;
            }
        });

        document.getElementById('results').innerHTML = html;
        document.getElementById('s-count').innerText = count;

        if(markers.length > 0) {
            const group = new L.featureGroup(markers);
            map.fitBounds(group.getBounds(), {padding: [50, 50]});
        }
    }

    async function updateWeather() {
        const coords = document.getElementById('relCoord').value.split(',');
        try {
            const res = await fetch(`https://api.openweathermap.org/data/2.5/weather?lat=${coords[0].trim()}&lon=${coords[1].trim()}&appid=${API_KEY}&units=metric`);
            const data = await res.json();
            document.getElementById('s-wind').innerText = (data.wind.speed * 3.6).toFixed(1);
        } catch(e) { console.log("Weather error"); }
    }

    function startRadarSim() {
        alert("Ø¨Ø¯Ø£Øª Ø§Ù„Ù…Ø­Ø§ÙƒØ§Ø© Ø§Ù„Ø­ÙŠØ© Ù„Ù„Ù…ØªØ³Ø§Ø¨Ù‚ÙŠÙ† Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø³Ø§ÙØ§Øª Ø§Ù„Ù…Ø³ØªØ®Ø±Ø¬Ø©!");
    }

    setInterval(() => {
        document.getElementById('liveClock').innerText = new Date().toTimeString().split(' ')[0];
    }, 1000);

    initMap();
</script>
</body>
</html>

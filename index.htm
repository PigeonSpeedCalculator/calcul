<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8">
<title>Real Pigeon Flight Physics</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<style>
body{
margin:0;background:#0b0f19;color:#fff;
font-family:Arial,sans-serif
}
#map{height:420px}
.panel{
padding:15px;background:#161b2a
}
.stat{
margin:5px 0;font-size:14px
}
.stat b{color:#00d4ff}
input,button{
width:100%;padding:10px;margin-top:8px;
background:#0b0f19;border:1px solid #2d3343;
color:#fff;border-radius:6px
}
button{
background:#00d4ff;color:#000;font-weight:bold;cursor:pointer
}
</style>
</head>

<body>

<div id="map"></div>

<div class="panel">
<input id="city" placeholder="Ù…Ø¯ÙŠÙ†Ø© Ø§Ù„ÙˆØµÙˆÙ„">
<input id="startCoord" value="33.2722,-8.3732">
<button onclick="start()">Ø¥Ø·Ù„Ø§Ù‚ Ø§Ù„Ø­Ù…Ø§Ù…Ø© ğŸ•Šï¸</button>

<div class="stat">ğŸŒ¬ï¸ Ø³Ø±Ø¹Ø© Ø§Ù„Ø±ÙŠØ§Ø­: <b id="windS">-- m/s</b></div>
<div class="stat">ğŸ§­ Ø§ØªØ¬Ø§Ù‡ Ø§Ù„Ø±ÙŠØ§Ø­: <b id="windD">-- Â°</b></div>
<div class="stat">ğŸ•Šï¸ Ø§Ù„Ø³Ø±Ø¹Ø© Ø§Ù„Ø£Ø±Ø¶ÙŠØ©: <b id="speed">-- m/s</b></div>
<div class="stat">â±ï¸ Ø§Ù„Ø²Ù…Ù† Ø§Ù„Ù…Ø­Ø³ÙˆØ¨: <b id="time">-- s</b></div>
<div class="stat">ğŸ“ Ø§Ù„Ù…Ø³Ø§ÙØ©: <b id="dist">-- m</b></div>
</div>

<script>
/* ================== CONSTANTS ================== */
const AIR_SPEED = 20; // m/s Ø³Ø±Ø¹Ø© Ø§Ù„Ø­Ù…Ø§Ù…Ø©

let map, startMarker, pigeon, dest;
let windSpeed = 0;
let windDeg = 0;

/* ================== MAP ================== */
map = L.map('map').setView([33.2722,-8.3732],7);
L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png')
.addTo(map);

startMarker = L.marker([33.2722,-8.3732]).addTo(map);

/* ================== WEATHER ================== */
async function loadWeather(lat,lon){
    try{
        const r = await fetch(
            `https://api.openweathermap.org/data/2.5/weather?lat=${lat}&lon=${lon}&appid=992e2b79f5e3386bda09d14ff4807f9d`
        );
        const d = await r.json();
        windSpeed = d.wind.speed;
        windDeg = d.wind.deg;
        windS.innerText = windSpeed.toFixed(2);
        windD.innerText = windDeg;
    } catch(e){
        windSpeed = 0;
        windDeg = 0;
        windS.innerText = "--";
        windD.innerText = "--";
        alert("Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø±ÙŠØ§Ø­");
    }
}

/* ================== MATH ================== */
function rad(d){return d*Math.PI/180}

function bearing(a,b,c,d){
    const y=Math.sin(rad(d-b))*Math.cos(rad(c));
    const x=Math.cos(rad(a))*Math.sin(rad(c))-
              Math.sin(rad(a))*Math.cos(rad(c))*Math.cos(rad(d-b));
    return (Math.atan2(y,x)*180/Math.PI+360)%360;
}

/* ================== START Ù…Ø­Ø³Ù‘Ù† ================== */
async function start(){
    const s = startCoord.value.split(',');
    const lat = parseFloat(s[0]);
    const lon = parseFloat(s[1]);

    await loadWeather(lat, lon);

    const cityName = city.value || "Rabat";
    const geo = await fetch(
        `https://nominatim.openstreetmap.org/search?format=json&q=${cityName}&limit=1`
    );
    const g = await geo.json();
    if(!g[0]) return alert("Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©");
    dest = [parseFloat(g[0].lat), parseFloat(g[0].lon)];

    const start = startMarker.getLatLng();
    const end = L.latLng(dest[0], dest[1]);

    // Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø³Ø§ÙØ©
    const distance = map.distance(start, end);
    dist.innerText = distance.toFixed(2);

    // Ø­Ø³Ø§Ø¨ Ø§Ù„Ø§ØªØ¬Ø§Ù‡
    const dir = bearing(start.lat, start.lng, end.lat, end.lng);

    // Ø­Ø³Ø§Ø¨ Ù…ÙƒÙˆÙ†Ø§Øª Ø§Ù„Ø±ÙŠØ§Ø­
    const windAlong = windSpeed * Math.cos(rad(windDeg - dir));  // Ø¹Ù„Ù‰ Ø·ÙˆÙ„ Ø§Ù„Ù…Ø³Ø§Ø±
    const windCross = windSpeed * Math.sin(rad(windDeg - dir));  // Ø¹Ø±Ø¶ÙŠØ©

    // Ø§Ù„Ø³Ø±Ø¹Ø© Ø§Ù„Ø£Ø±Ø¶ÙŠØ© Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠØ©
    const groundSpeed = Math.sqrt(Math.pow(AIR_SPEED + windAlong, 2) + Math.pow(windCross, 2));
    speed.innerText = groundSpeed.toFixed(3);

    // Ø§Ù„Ø²Ù…Ù† Ø§Ù„ÙƒÙ„ÙŠ
    const totalTime = distance / groundSpeed;
    time.innerText = totalTime.toFixed(2);

    /* ================== ANIMATION Ù…Ø­Ø³Ù‘Ù† ================== */
    if(pigeon) map.removeLayer(pigeon);
    pigeon = L.marker(start, {icon:L.divIcon({html:'ğŸ•Šï¸',iconSize:[30,30]})}).addTo(map);

    let traveled = 0;
    let last = performance.now();

    // Ø¯Ø§Ù„Ø© Ù„Ø­Ø³Ø§Ø¨ Ù†Ù‚Ø·Ø© Ø¹Ù„Ù‰ Ù…Ø³Ø§Ø± Ø§Ù„Ø¯Ø§Ø¦Ø±Ø© Ø§Ù„Ø¹Ø¸Ù…Ù‰
    function interpolateGreatCircle(p0, p1, fraction){
        const lat1 = rad(p0.lat);
        const lon1 = rad(p0.lng);
        const lat2 = rad(p1.lat);
        const lon2 = rad(p1.lng);

        const d = 2 * Math.asin(Math.sqrt(
            Math.pow(Math.sin((lat2 - lat1)/2),2) +
            Math.cos(lat1) * Math.cos(lat2) * Math.pow(Math.sin((lon2 - lon1)/2),2)
        ));

        if(d === 0) return [p0.lat, p0.lng];

        const A = Math.sin((1 - fraction) * d) / Math.sin(d);
        const B = Math.sin(fraction * d) / Math.sin(d);

        const x = A * Math.cos(lat1) * Math.cos(lon1) + B * Math.cos(lat2) * Math.cos(lon2);
        const y = A * Math.cos(lat1) * Math.sin(lon1) + B * Math.cos(lat2) * Math.sin(lon2);
        const z = A * Math.sin(lat1) + B * Math.sin(lat2);

        const lat = Math.atan2(z, Math.sqrt(x*x + y*y));
        const lon = Math.atan2(y, x);

        return [lat * 180/Math.PI, lon * 180/Math.PI];
    }

    function animate(now){
        const dt = (now - last)/1000;
        last = now;
        traveled += groundSpeed * dt;
        let p = traveled / distance;
        if(p >= 1){pigeon.setLatLng(end); return;}
        const point = interpolateGreatCircle(start, end, p);
        pigeon.setLatLng(point);
        requestAnimationFrame(animate);
    }
    requestAnimationFrame(animate);
}
</script>

</body>
</html>

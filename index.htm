<!DOCTYPE html>
<html lang="ar">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ø­Ø³Ø§Ø¨ Ø³Ø±Ø¹Ø© Ø§Ù„Ø­Ù…Ø§Ù…</title>
        <title>BY ELMAKKAOUY</title>

    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#3182ce">
    <style>
        body { margin: 0; background: #f0f2f5; font-family: 'Segoe UI', Tahoma, sans-serif; }
        #app-root { max-width: 500px; margin: 0 auto; min-height: 100vh; background: #fff; position: relative; }
        
        /* ØªØ«Ø¨ÙŠØª Ø§Ù„Ø¨Ø­Ø« ÙˆØ²Ø± Ø§Ù„Ø­Ø³Ø§Ø¨ ÙÙŠ Ø§Ù„Ø£Ø¹Ù„Ù‰ */
        .sticky-header {
            position: sticky; top: 0; z-index: 1000;
            background: #ffffff; padding: 12px 15px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            display: flex; flex-direction: column; gap: 10px;
        }
        .header-row { display: flex; justify-content: space-between; align-items: center; }
        .btn-calc { 
            background: #27ae60; color: white; border: none; 
            padding: 10px 25px; border-radius: 25px; font-weight: bold; 
            cursor: pointer; font-size: 16px; transition: 0.3s;
        }
        #searchInput { 
            width: 100%; padding: 12px; border: 2px solid #3182ce; 
            border-radius: 12px; font-size: 16px !important; box-sizing: border-box;
        }

        .content { padding: 15px; }
        .card { background: #fff; border: 1px solid #e2e8f0; border-radius: 12px; padding: 15px; margin-bottom: 12px; }
        input[type="text"], input[type="number"] { width: 100%; padding: 12px; margin: 8px 0; border: 1px solid #cbd5e0; border-radius: 8px; font-size: 16px !important; box-sizing: border-box; text-align: center; }
        
        #rankingSection { margin-top: 20px; border-top: 4px solid #3182ce; padding-top: 15px; }
        .result-item { display:flex; justify-content:space-between; align-items:center; padding:12px; border-bottom:1px solid #edf2f7; }
        .top-1 { background: #fffaf0; border-right: 4px solid #ed8936; }
        
        .btn-save { width: 100%; padding: 15px; background: #4a5568; color: white; border: none; border-radius: 12px; font-weight: bold; margin-top: 10px; cursor: pointer; font-size: 16px; }
        .delete-btn { background:#fee2e2; color:#ef4444; border:none; padding:8px; border-radius:6px; cursor:pointer; }
    </style>
</head>
<body>

<div dir="rtl" id="app-root">
    <div class="sticky-header">
        <div class="header-row">
            <h3 style="margin:0; color:#3182ce;">Ø³Ø±Ø¹Ø© Ø§Ù„Ø­Ù…Ø§Ù… ğŸ•Šï¸</h3>
            <button class="btn-calc" onclick="generateRankings()">Ø­Ø³Ø§Ø¨ ğŸ†</button>
        </div>
        <input type="text" id="searchInput" onkeyup="filterNames()" placeholder="Ø¨Ø­Ø« Ø³Ø±ÙŠØ¹ Ø¹Ù† Ø§Ø³Ù…...">
    </div>

    <div class="content">
        <div class="card" style="background:#f8fafc;">
            <b>1. Ù…Ù„Ù Ø§Ù„Ù€ PDF ÙˆÙˆÙ‚Øª Ø§Ù„Ø¥Ø·Ù„Ø§Ù‚:</b>
            <input type="file" id="pdfInput" accept=".pdf">
            <input type="text" id="lacheTime" placeholder="ÙˆÙ‚Øª Ø§Ù„Ø¥Ø·Ù„Ø§Ù‚ 07:00:00" maxlength="8" oninput="formatTime(this)" inputmode="numeric">
            <button onclick="addManualEntry()" style="background:#3182ce; color:white; border:none; padding:10px; border-radius:8px; width:100%; cursor:pointer;">+ Ø¥Ø¶Ø§ÙØ© ÙŠØ¯ÙˆÙŠØ©</button>
        </div>

        <div id="inputSection">
            <div id="inputCardsContainer"></div>
        </div>

        <div id="rankingSection" style="display:none;">
            <div id="capture-area" style="background:#fff; border-radius:8px; overflow:hidden;">
                <div style="background:#3182ce; color:white; padding:12px; text-align:center;"><b>Ù„ÙˆØ­Ø© Ø§Ù„Ù…ØªØµØ¯Ø±ÙŠÙ†</b></div>
                <div id="rankingList"></div>
            </div>
            <button class="btn-save" onclick="saveAsImage()">ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù†ØªÙŠØ¬Ø© ÙƒØµÙˆØ±Ø© ğŸ“¸</button>
        </div>
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

<script>
    let basePigeons = [];
    const pdfjsLib = window['pdfjs-dist/build/pdf'];
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js';

    function formatTime(t) {
        let v = t.value.replace(/\D/g, '');
        if (v.length > 2 && v.length <= 4) v = v.slice(0, 2) + ':' + v.slice(2);
        else if (v.length > 4) v = v.slice(0, 2) + ':' + v.slice(2, 4) + ':' + v.slice(4, 6);
        t.value = v;
    }

    document.getElementById('pdfInput').addEventListener('change', async (e) => {
        const file = e.target.files[0];
        const reader = new FileReader();
        reader.onload = async function() {
            const pdf = await pdfjsLib.getDocument(new Uint8Array(this.result)).promise;
            let extracted = [];
            for (let i = 1; i <= pdf.numPages; i++) {
                const page = await pdf.getPage(i);
                const content = await page.getTextContent();
                let lines = {};
                content.items.forEach(it => {
                    let y = Math.round(it.transform[5]);
                    if (!lines[y]) lines[y] = [];
                    lines[y].push(it);
                });
                Object.keys(lines).sort((a,b)=>b-a).forEach(y => {
                    let row = lines[y].sort((a,b)=>a.transform[4]-b.transform[4]).map(it=>it.str.trim()).filter(s=>s!=="");
                    if (row.length >= 5 && /^\d+$/.test(row[0])) {
                        extracted.push({ name: row[1], dist: parseFloat(row[row.length-1]) });
                    }
                });
            }
            basePigeons = extracted;
            renderInputCards();
        };
        reader.readAsArrayBuffer(file);
    });

    function addManualEntry() {
        basePigeons.unshift({ name: "", dist: 0, manual: true });
        renderInputCards();
    }

    function renderInputCards() {
        const container = document.getElementById('inputCardsContainer');
        container.innerHTML = "";
        basePigeons.forEach((p, i) => {
            const card = document.createElement('div');
            card.className = "card";
            card.setAttribute('data-name', p.name);
            let head = p.manual ? `<div style="display:flex; gap:5px;"><input type="text" placeholder="Ø§Ù„Ø§Ø³Ù…" onchange="basePigeons[${i}].name=this.value" style="flex:2;"><input type="number" placeholder="Km" onchange="basePigeons[${i}].dist=parseFloat(this.value)" style="flex:1;"></div>` : `<div style="display:flex; justify-content:space-between;"><b>${p.name}</b><span>${p.dist.toFixed(3)} Km</span></div>`;
            card.innerHTML = head + `<div style="display:flex; gap:5px; margin-top:8px;"><input type="text" maxlength="8" oninput="formatTime(this)" inputmode="numeric" placeholder="00:00:00" class="t-inp-${i}" style="flex:1;"></div>`;
            container.appendChild(card);
        });
    }

    function filterNames() {
        let val = document.getElementById('searchInput').value.toLowerCase();
        document.querySelectorAll('.card[data-name]').forEach(c => {
            c.style.display = c.getAttribute('data-name').toLowerCase().includes(val) ? "block" : "none";
        });
    }

    function generateRankings() {
        let results = [];
        const lache = document.getElementById('lacheTime').value;
        if(lache.length < 5) return alert("Ø£Ø¯Ø®Ù„ ÙˆÙ‚Øª Ø§Ù„Ø¥Ø·Ù„Ø§Ù‚");
        
        basePigeons.forEach((p, i) => {
            document.querySelectorAll(`.t-inp-${i}`).forEach(inp => {
                if(inp.value.length >= 5 && p.name && p.dist > 0) {
                    let d1 = new Date("2026-01-01 " + lache);
                    let d2 = new Date("2026-01-01 " + inp.value);
                    let diff = (d2 - d1) / 60000;
                    if(diff <= 0) diff += 1440;
                    results.push({ name: p.name, dist: p.dist, time: inp.value, speed: (p.dist * 1000) / diff });
                }
            });
        });
        results.sort((a,b) => b.speed - a.speed);
        document.getElementById('rankingList').innerHTML = results.map((r, i) => `<div class="result-item ${i==0?'top-1':''}"><div><b>${i+1}. ${r.name}</b><br><small>${r.dist.toFixed(3)} Km | ${r.time}</small></div><b>${r.speed.toFixed(3)}</b></div>`).join('');
        document.getElementById('rankingSection').style.display = 'block';
        document.getElementById('rankingSection').scrollIntoView({ behavior: 'smooth' });
    }

    function saveAsImage() {
        const area = document.getElementById('capture-area');
        html2canvas(area).then(canvas => {
            const link = document.createElement('a');
            link.download = 'results.png';
            link.href = canvas.toDataURL();
            link.click();
        });
    }

    if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
        navigator.serviceWorker.register('./sw.js', { scope: './' })
        .then(reg => console.log('ØªÙ… Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ø¨Ù†Ø¬Ø§Ø­!'))
        .catch(err => console.log('ÙØ´Ù„ Ø§Ù„ØªØ³Ø¬ÙŠÙ„:', err));
    });
}
</script>
</body>
</html>


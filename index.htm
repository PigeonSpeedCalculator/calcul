<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>ELMAKKAOUY FLIGHT AI PRO - Ultimate</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <style>
        :root { --primary: #00d4ff; --bg: #0f172a; --card: #1e293b; --text: #f8fafc; --accent: #22c55e; }
        body { margin: 0; background: var(--bg); color: var(--text); font-family: 'Segoe UI', sans-serif; overflow-x: hidden; }
        #map { height: 450px; width: 100%; border-bottom: 3px solid var(--primary); }
        .container { padding: 20px; max-width: 1100px; margin: auto; }
        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); gap: 20px; }
        .panel { background: var(--card); padding: 20px; border-radius: 15px; box-shadow: 0 10px 25px rgba(0,0,0,0.5); }
        h3 { margin-top: 0; color: var(--primary); display: flex; align-items: center; gap: 10px; }
        input, button { width: 100%; padding: 12px; margin-top: 10px; border-radius: 8px; border: 1px solid #334155; background: #0f172a; color: white; box-sizing: border-box; }
        button { background: var(--primary); color: #000; font-weight: bold; cursor: pointer; border: none; transition: 0.3s; }
        button:hover { opacity: 0.8; transform: translateY(-2px); }
        .stats-bar { display: flex; justify-content: space-around; background: var(--card); padding: 15px; border-radius: 12px; margin: -30px auto 20px; position: relative; z-index: 1000; width: 90%; border: 1px solid var(--primary); }
        .stat-item { text-align: center; }
        .stat-item b { display: block; color: var(--primary); font-size: 1.2em; }
        .search-container { position: relative; }
        #sugStart, #sugEnd { background: var(--card); border: 1px solid var(--primary); position: absolute; z-index: 2000; width: 100%; max-height: 150px; overflow-y: auto; display: none; border-radius: 0 0 8px 8px; }
        .sug-item { padding: 10px; cursor: pointer; border-bottom: 1px solid #444; font-size: 0.9em; }
        .sug-item:hover { background: var(--primary); color: #000; }
        table { width: 100%; margin-top: 20px; }
        th, td { padding: 12px; text-align: center; border-bottom: 1px solid #334155; }
        .bird-icon { font-size: 30px; filter: drop-shadow(0 0 8px var(--primary)); }
    </style>
</head>
<body>

<div id="map"></div>

<div class="stats-bar">
    <div class="stat-item">ğŸ“ Ø§Ù„Ù…Ø³Ø§ÙØ© Ø§Ù„ÙƒÙ„ÙŠØ©<b id="distDisplay">0 Km</b></div>
    <div class="stat-item">ğŸ“ ÙˆØ¶Ø¹ Ø§Ù„Ø·ÙŠØ±Ø§Ù†<b id="statusDisplay">Ø¬Ø§Ù‡Ø²</b></div>
    <div class="stat-item">ğŸŒ¬ï¸ ØªØ£Ø«ÙŠØ± Ø§Ù„Ø±ÙŠØ§Ø­<b id="windDisplay">Ù†Ø´Ø·</b></div>
</div>

<div class="container">
    <div class="grid">
        <div class="panel">
            <h3>ğŸš€ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¥Ø·Ù„Ø§Ù‚ Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠ</h3>
            <label>ÙˆÙ‚Øª Ø§Ù„Ø¥Ø·Ù„Ø§Ù‚ Ø§Ù„ÙØ¹Ù„ÙŠ:</label>
            <input type="datetime-local" id="startTime">
            
            <div class="search-container">
                <input id="startInput" placeholder="Ø¨Ø­Ø« Ø¹Ù† Ù†Ù‚Ø·Ø© Ø§Ù„Ø¥Ø·Ù„Ø§Ù‚..." oninput="searchLoc(this.value, 'start')">
                <div id="sugStart"></div>
            </div>

            <div class="search-container">
                <input id="endInput" placeholder="Ø¨Ø­Ø« Ø¹Ù† Ù…Ø¯ÙŠÙ†Ø© Ø§Ù„ÙˆØµÙˆÙ„..." oninput="searchLoc(this.value, 'end')">
                <div id="sugEnd"></div>
            </div>

            <button onclick="initSim()">ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø­Ø§ÙƒØ§Ø© Ø§Ù„Ø²Ù…Ù†ÙŠØ© ğŸ•Šï¸</button>
            <button onclick="resetSim()" style="background:#ef4444; color:white; margin-top:8px">Ø¥Ø¹Ø§Ø¯Ø© Ø¶Ø¨Ø· ÙƒØ§Ù…Ù„Ø©</button>
        </div>

        <div class="panel">
            <h3>ğŸ† Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ù…ØªØ³Ø§Ø¨Ù‚ÙŠÙ†</h3>
            <input id="rName" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…ØªØ³Ø§Ø¨Ù‚">
            <input id="rDist" type="number" placeholder="Ø§Ù„Ù…Ø³Ø§ÙØ© Ø§Ù„Ù…Ù‚Ø·ÙˆØ¹Ø© (Km)">
            <label>ÙˆÙ‚Øª Ø§Ù„ÙˆØµÙˆÙ„:</label>
            <input id="rTime" type="time">
            <button onclick="addRacer()" style="background:var(--accent); color:white">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù†ØªÙŠØ¬Ø© ÙˆØ­Ø³Ø§Ø¨ Ø§Ù„Ø³Ø±Ø¹Ø©</button>
        </div>
    </div>

    <div class="panel" style="margin-top:20px">
        <h3>ğŸ“Š Ù„ÙˆØ­Ø© Ø§Ù„Ù…ØªØµØ¯Ø±ÙŠÙ† (Ù…Ø²Ø§Ù…Ù†Ø© ÙÙˆØ±ÙŠØ©)</h3>
        <table>
            <thead>
                <tr><th>Ø§Ù„Ø±ØªØ¨Ø©</th><th>Ø§Ù„Ø§Ø³Ù…</th><th>Ø§Ù„Ù…Ø³Ø§ÙØ©</th><th>Ø§Ù„Ø³Ø±Ø¹Ø© (Ù…/Ø¯)</th></tr>
            </thead>
            <tbody id="resultsBody"></tbody>
        </table>
    </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
let map = L.map('map').setView([33.5, -7.5], 6);
L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png').addTo(map);

let pigeon, pathLine, startPoint, endPoint, racers = [];
const AVG_SPEED = 1180; // Ù…ØªÙˆØ³Ø· Ø³Ø±Ø¹Ø© Ø§Ù„Ø­Ù…Ø§Ù… Ù…/Ø¯

// Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ù…ÙˆØ§Ù‚Ø¹
async function searchLoc(q, type) {
    const box = type === 'start' ? document.getElementById('sugStart') : document.getElementById('sugEnd');
    if(q.length < 3) { box.style.display = 'none'; return; }
    
    try {
        const r = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${q}&limit=5`);
        const d = await r.json();
        box.style.display = 'block';
        box.innerHTML = d.map(x => `
            <div class="sug-item" onclick="selectLoc(${x.lat}, ${x.lon}, '${x.display_name}', '${type}')">
                ${x.display_name}
            </div>`).join('');
    } catch(e) { console.error("Search error"); }
}

function selectLoc(lat, lon, name, type) {
    if(type === 'start') {
        startPoint = {lat, lng: lon};
        document.getElementById('startInput').value = name.split(',')[0];
        document.getElementById('sugStart').style.display = 'none';
    } else {
        endPoint = {lat, lng: lon};
        document.getElementById('endInput').value = name.split(',')[0];
        document.getElementById('sugEnd').style.display = 'none';
    }
    saveState();
}

// Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø³Ø§ÙØ©
function calcDist(p1, p2) {
    const R = 6371000;
    const dLat = (p2.lat - p1.lat) * Math.PI / 180;
    const dLon = (p2.lng - p1.lng) * Math.PI / 180;
    const a = Math.sin(dLat/2)**2 + Math.cos(p1.lat*Math.PI/180)*Math.cos(p2.lat*Math.PI/180)*Math.sin(dLon/2)**2;
    return 2 * R * Math.asin(Math.sqrt(a));
}

// Ø­ÙØ¸ Ø§Ù„Ø­Ø§Ù„Ø©
function saveState() {
    const state = {
        startPoint, endPoint,
        startTime: document.getElementById('startTime').value,
        startName: document.getElementById('startInput').value,
        endName: document.getElementById('endInput').value,
        racers
    };
    localStorage.setItem('flightProState', JSON.stringify(state));
}

// Ø§Ù„Ù…Ø­Ø§ÙƒØ§Ø©
function initSim() {
    if(!startPoint || !endPoint || !document.getElementById('startTime').value) return;

    const totalD = calcDist(startPoint, endPoint);
    document.getElementById('distDisplay').innerText = (totalD/1000).toFixed(2) + " Km";

    if(pathLine) map.removeLayer(pathLine);
    pathLine = L.polyline([startPoint, endPoint], {color: 'rgba(0, 212, 255, 0.3)', weight: 2, dashArray: '10, 10'}).addTo(map);

    if(pigeon) map.removeLayer(pigeon);
    pigeon = L.marker(startPoint, {icon: L.divIcon({html: `<div class="bird-icon">ğŸ•Šï¸</div>`, className: ''})}).addTo(map);
    
    map.fitBounds(pathLine.getBounds(), {padding: [50, 50]});

    function step() {
        const now = new Date();
        const startT = new Date(document.getElementById('startTime').value);
        const elapsed = (now - startT) / 60000;

        if(elapsed < 0) {
            document.getElementById('statusDisplay').innerText = "Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ø¥Ø·Ù„Ø§Ù‚";
            return;
        }

        let progress = (elapsed * AVG_SPEED) / totalD;
        if(progress > 1) progress = 1;

        // Ù…Ù†Ø·Ù‚ Ø§Ù„Ø§Ù†Ø­Ù†Ø§Ø¡ Ù„ØªØ¬Ù†Ø¨ Ø§Ù„Ù…Ø³Ø§Ø±Ø§Øª ØºÙŠØ± Ø§Ù„ÙˆØ§Ù‚Ø¹ÙŠØ©
        let currentLat = startPoint.lat + (endPoint.lat - startPoint.lat) * progress;
        let currentLng = startPoint.lng + (endPoint.lng - startPoint.lng) * progress;
        
        // "ØªØ£Ø«ÙŠØ± Ø§Ù„ÙŠØ§Ø¨Ø³Ø©": Ø§Ù†Ø­Ø±Ø§Ù Ø¨Ø³ÙŠØ· Ù„Ø¬Ø¹Ù„ Ø§Ù„Ù…Ø³Ø§Ø± ÙŠØ¨Ø¯Ùˆ ÙƒØ£Ù†Ù‡ ÙŠØªØ¬Ù†Ø¨ Ø®Ø·Ø§Ù‹ Ù…Ø³ØªÙ‚ÙŠÙ…Ø§Ù‹ Ø¨Ø­Ø±ÙŠØ§Ù‹
        let curve = Math.sin(progress * Math.PI) * 0.08; 
        pigeon.setLatLng([currentLat + curve, currentLng]);

        document.getElementById('statusDisplay').innerText = progress >= 1 ? "ÙˆØµÙ„Øª Ø§Ù„Ø­Ù…Ø§Ù…Ø©" : `Ø·ÙŠØ±Ø§Ù†: ${(progress*100).toFixed(1)}%`;
        
        if(progress < 1) requestAnimationFrame(step);
    }
    step();
    saveState();
}

function addRacer() {
    const name = document.getElementById('rName').value;
    const dKm = parseFloat(document.getElementById('rDist').value);
    const arrT = document.getElementById('rTime').value;
    const startT = document.getElementById('startTime').value;

    if(!name || !dKm || !arrT || !startT) return alert("Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ØºÙŠØ± ÙƒØ§Ù…Ù„Ø©");

    let start = new Date(startT);
    let end = new Date(startT.split('T')[0] + 'T' + arrT);
    if(end < start) end.setDate(end.getDate() + 1);

    let speed = (dKm * 1000) / ((end - start) / 60000);
    racers.push({name, dKm, speed});
    racers.sort((a, b) => b.speed - a.speed);
    
    updateTable();
    saveState();
}

function updateTable() {
    document.getElementById('resultsBody').innerHTML = racers.map((r, i) => `
        <tr>
            <td>${i+1}</td>
            <td>${r.name}</td>
            <td>${r.dKm} Km</td>
            <td style="color:var(--accent); font-weight:bold">${r.speed.toFixed(2)}</td>
        </tr>
    `).join('');
}

function resetSim() {
    localStorage.removeItem('flightProState');
    location.reload();
}

window.onload = () => {
    const saved = localStorage.getItem('flightProState');
    if(saved) {
        const data = JSON.parse(saved);
        startPoint = data.startPoint;
        endPoint = data.endPoint;
        racers = data.racers || [];
        document.getElementById('startTime').value = data.startTime;
        document.getElementById('startInput').value = data.startName || '';
        document.getElementById('endInput').value = data.endName || '';
        updateTable();
        if(startPoint && endPoint) initSim();
    }
};
</script>
</body>
</html>

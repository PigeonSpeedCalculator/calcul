<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>ELMAKKAOUY FLIGHT AI PRO - Precision Edition</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <style>
        :root { --primary: #00d4ff; --bg: #0f172a; --card: #1e293b; --text: #f8fafc; }
        body { margin: 0; background: var(--bg); color: var(--text); font-family: 'Segoe UI', sans-serif; }
        #map { height: 450px; width: 100%; border-bottom: 3px solid var(--primary); }
        .container { padding: 15px; max-width: 1200px; margin: auto; }
        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 15px; }
        .panel { background: var(--card); padding: 15px; border-radius: 12px; border: 1px solid #334155; position: relative; }
        .stats-bar { display: grid; grid-template-columns: repeat(4, 1fr); background: var(--card); padding: 15px; border-radius: 12px; margin: -25px auto 15px; width: 95%; position: relative; z-index: 1000; border: 1px solid var(--primary); text-align: center; }
        .stat-item b { display: block; color: var(--primary); font-size: 1.1em; }
        input, button { width: 100%; padding: 10px; margin-top: 8px; border-radius: 6px; border: 1px solid #334155; background: #0f172a; color: white; box-sizing: border-box; }
        button { background: var(--primary); color: #000; font-weight: bold; cursor: pointer; border: none; }
        .sug-box { position: absolute; z-index: 2000; width: calc(100% - 30px); background: var(--card); border: 1px solid var(--primary); display: none; max-height: 150px; overflow-y: auto; }
        .sug-item { padding: 8px; cursor: pointer; border-bottom: 1px solid #444; font-size: 0.85em; }
        .sug-item:hover { background: var(--primary); color: #000; }
        #bird-icon { font-size: 30px; transition: transform 0.5s ease; display: inline-block; }
        table { width: 100%; margin-top: 15px; border-collapse: collapse; }
        th, td { padding: 10px; border-bottom: 1px solid #444; text-align: center; }
    </style>
</head>
<body>

<div id="map"></div>

<div class="stats-bar">
    <div class="stat-item">ğŸŒ¬ï¸ Ø±ÙŠØ§Ø­<b id="st-wind">0 km/h</b></div>
    <div class="stat-item">ğŸš€ Ø³Ø±Ø¹Ø© Ø§Ù„Ø­Ù…Ø§Ù…Ø©<b id="st-airspeed">1166.67 m/min</b></div>
    <div class="stat-item">ğŸŒ Ø³Ø±Ø¹Ø© Ø§Ù„Ø£Ø±Ø¶<b id="st-groundspeed">0 m/min</b></div>
    <div class="stat-item">ğŸ“ Ù…ØªØ¨Ù‚ÙŠ<b id="st-rem-dist">--</b><span>Km</span></div>
</div>

<div class="container">
    <div class="grid">
        <div class="panel">
            <h3>ğŸ“ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¥Ø·Ù„Ø§Ù‚ ÙˆØ§Ù„Ù…Ù„Ø§Ø­Ø©</h3>
            <input id="startCoords" placeholder="Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª Ø§Ù„Ø¥Ø·Ù„Ø§Ù‚ (Ù…Ø«Ø§Ù„: 33.57, -7.58)">
            <div style="position:relative">
                <input id="endInput" placeholder="Ù…Ø¯ÙŠÙ†Ø© Ø§Ù„ÙˆØµÙˆÙ„ (Ø§Ø¨Ø­Ø« Ù‡Ù†Ø§...)" oninput="searchEnd(this.value)">
                <div id="sugEnd" class="sug-box"></div>
            </div>
            <label style="display:block; margin-top:10px;">ÙˆÙ‚Øª Ø§Ù„Ø¥Ø·Ù„Ø§Ù‚ (Ø¨Ø§Ù„Ø«ÙˆØ§Ù†ÙŠ):</label>
            <input type="datetime-local" id="startTime" step="1">
            <button onclick="startSimulation()">Ø¨Ø¯Ø¡ Ø§Ù„Ù…Ø­Ø§ÙƒØ§Ø© Ø§Ù„Ø¬ÙˆÙŠØ© ğŸ•Šï¸</button>
        </div>

        <div class="panel">
            <h3>ğŸ“Š Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø±Ø³Ù…ÙŠØ© (m/min)</h3>
            <input id="rName" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…ØªØ³Ø§Ø¨Ù‚">
            <input id="rDist" type="number" placeholder="Ø§Ù„Ù…Ø³Ø§ÙØ© (Km)" step="0.001">
            <label>ÙˆÙ‚Øª Ø§Ù„ÙˆØµÙˆÙ„ (Ø¨Ø§Ù„Ø«ÙˆØ§Ù†ÙŠ):</label>
            <input id="rTime" type="time" step="1">
            <button onclick="addRacer()" style="background:#22c55e; color:white">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù†ØªÙŠØ¬Ø©</button>
        </div>
    </div>

    <div class="panel" style="margin-top:15px">
        <table>
            <thead><tr><th>#</th><th>Ø§Ù„Ù…ØªØ³Ø§Ø¨Ù‚</th><th>Ø§Ù„Ù…Ø³Ø§ÙØ©</th><th>Ø§Ù„Ø³Ø±Ø¹Ø© (Ù…/Ø¯)</th><th>Ø§Ù„Ø±Ø·ÙˆØ¨Ø©</th></tr></thead>
            <tbody id="results"></tbody>
        </table>
    </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
let map = L.map('map').setView([33.5, -7.5], 6);
L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png').addTo(map);

let pigeon, pathLine, startPt, endPt, racers = [];
let weather = { windKm: 0, deg: 0, hum: 0 };
const PIGEON_BASE_KMH = 70;

async function searchEnd(val) {
    if(val.length < 3) return;
    const r = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${val}&limit=5`);
    const d = await r.json();
    const box = document.getElementById('sugEnd');
    box.style.display = 'block';
    box.innerHTML = d.map(x => `<div class="sug-item" onclick="setEnd(${x.lat}, ${x.lon}, '${x.display_name}')">${x.display_name}</div>`).join('');
}

function setEnd(lat, lon, name) {
    endPt = {lat, lng: lon};
    document.getElementById('endInput').value = name.split(',')[0];
    document.getElementById('sugEnd').style.display = 'none';
    getWeather(lat, lon);
}

async function getWeather(lat, lon) {
    const r = await fetch(`https://api.openweathermap.org/data/2.5/weather?lat=${lat}&lon=${lon}&appid=992e2b79f5e3386bda09d14ff4807f9d`);
    const d = await r.json();
    weather = { windKm: d.wind.speed * 3.6, deg: d.wind.deg, hum: d.main.humidity };
    document.getElementById('st-wind').innerText = weather.windKm.toFixed(1) + " km/h";
}

function calculateRotation(p1, p2) {
    const lat1 = p1.lat * Math.PI / 180;
    const lat2 = p2.lat * Math.PI / 180;
    const dLon = (p2.lng - p1.lng) * Math.PI / 180;
    const y = Math.sin(dLon) * Math.cos(lat2);
    const x = Math.cos(lat1) * Math.sin(lat2) - Math.sin(lat1) * Math.cos(lat2) * Math.cos(dLon);
    return (Math.atan2(y, x) * 180 / Math.PI + 360) % 360;
}

function startSimulation() {
    const coords = document.getElementById('startCoords').value.split(',');
    if(coords.length < 2 || !endPt) return alert("ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª ÙˆØ§Ù„ÙˆØµÙˆÙ„");
    startPt = {lat: parseFloat(coords[0]), lng: parseFloat(coords[1])};

    const angle = calculateRotation(startPt, endPt);
    const rad = (weather.deg - angle) * Math.PI / 180;
    const groundSpeedKm = PIGEON_BASE_KMH + (Math.cos(rad) * weather.windKm);
    
    document.getElementById('st-groundspeed').innerText = ((groundSpeedKm * 1000)/60).toFixed(2) + " m/min";

    if(pathLine) map.removeLayer(pathLine);
    pathLine = L.polyline([startPt, endPt], {color: 'cyan', weight: 1.5, dashArray: '5, 10'}).addTo(map);
    
    if(pigeon) map.removeLayer(pigeon);
    pigeon = L.marker(startPt, {
        icon: L.divIcon({
            html: `<div id="bird-icon" style="transform: rotate(${angle}deg)">ğŸ•Šï¸</div>`,
            className: ''
        })
    }).addTo(map);

    map.fitBounds(pathLine.getBounds());

    function frame() {
        const start = new Date(document.getElementById('startTime').value);
        const elapsedH = (new Date() - start) / 3600000;
        if(elapsedH < 0) return requestAnimationFrame(frame);

        const totalD = map.distance(startPt, endPt) / 1000;
        let progress = (elapsedH * groundSpeedKm) / totalD;
        if(progress > 1) progress = 1;

        // Ù…Ø­Ø§ÙƒØ§Ø© Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„Ù…ØªØ£Ø«Ø± Ø¨Ø§Ù„ØªØ¶Ø§Ø±ÙŠØ³ (Ø§Ù†Ø­Ù†Ø§Ø¡ Ø¨Ø³ÙŠØ·)
        const drift = Math.sin(progress * Math.PI) * 0.01;
        const curLat = startPt.lat + (endPt.lat - startPt.lat) * progress + drift;
        const curLng = startPt.lng + (endPt.lng - startPt.lng) * progress;
        
        pigeon.setLatLng([curLat, curLng]);
        document.getElementById('st-rem-dist').innerText = (totalD * (1 - progress)).toFixed(2);
        
        if(progress < 1) requestAnimationFrame(frame);
    }
    frame();
}

function addRacer() {
    const startStr = document.getElementById('startTime').value;
    const arrivalTime = document.getElementById('rTime').value;
    if(!startStr || !arrivalTime) return;

    const start = new Date(startStr);
    const [h, m, s] = arrivalTime.split(':');
    const end = new Date(startStr.split('T')[0] + `T${h}:${m}:${s || '00'}`);
    if(end < start) end.setDate(end.getDate() + 1);

    const seconds = (end - start) / 1000;
    const speed = (parseFloat(document.getElementById('rDist').value) * 1000) / (seconds / 60);

    racers.push({name: document.getElementById('rName').value, dist: document.getElementById('rDist').value, speed, hum: weather.hum});
    racers.sort((a,b) => b.speed - a.speed);
    document.getElementById('results').innerHTML = racers.map((r, i) => 
        `<tr><td>${i+1}</td><td>${r.name}</td><td>${r.dist} Km</td><td>${r.speed.toFixed(3)}</td><td>${r.hum}%</td></tr>`
    ).join('');
}
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8">
<title>ELMAKKAOUY LIVE SIMULATION</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<style>
body{margin:0;background:#0f172a;color:white;font-family:Arial}
#map{height:420px}
.panel{padding:15px;background:#111827}
input,button{
width:100%;padding:10px;margin-top:8px;
background:#0b1220;border:1px solid #1f2937;
color:white;border-radius:6px
}
button{background:#00d4ff;color:black;font-weight:bold}
.stat{margin:6px 0}
.stat b{color:#00ff88}
</style>
</head>

<body>

<div id="map"></div>

<div class="panel">

<input type="datetime-local" id="startTime">
<input id="startCoord" value="33.421265,-7.812173">
<input id="city" value="kenitra">
<button onclick="startFlight()">Ø¨Ø¯Ø¡ Ø§Ù„ØªØªØ¨Ø¹ ğŸ•Šï¸</button>

<hr>

<div class="stat">Ø§Ù„Ù…Ø³Ø§ÙØ©: <b id="dist">--</b> Km</div>
<div class="stat">Ø§Ù„Ø³Ø±Ø¹Ø©: <b id="speed">--</b> m/min</div>
<div class="stat">Ø§Ù„Ø±ÙŠØ§Ø­: <b id="wind">--</b> m/min</div>
<div class="stat">Ø§Ù„Ø²Ù…Ù†: <b id="elapsed">--</b> min</div>

</div>

<script>

let map = L.map('map').setView([33.4,-7.8],7);
L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png').addTo(map);

let pigeon, routeLine;
let startPoint, endPoint;
let totalDistance = 0;
let interval;

const AIR_SPEED = 1200; // m/min

function rad(x){return x*Math.PI/180}

function bearing(a,b,c,d){
const y=Math.sin(rad(d-b))*Math.cos(rad(c));
const x=Math.cos(rad(a))*Math.sin(rad(c))-
Math.sin(rad(a))*Math.cos(rad(c))*Math.cos(rad(d-b));
return (Math.atan2(y,x)*180/Math.PI+360)%360;
}

async function getCoords(city){
const r = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${city}&limit=1`);
const d = await r.json();
if(!d.length){ alert("Ø§Ù„Ù…Ø¯ÙŠÙ†Ø© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©"); return null; }
return [parseFloat(d[0].lat),parseFloat(d[0].lon)];
}

async function getWind(lat,lon){
try{
const r = await fetch(`https://api.openweathermap.org/data/2.5/weather?lat=${lat}&lon=${lon}&appid=992e2b79f5e3386bda09d14ff4807f9d&units=metric`);
const d = await r.json();
return {
speed:(d.wind?.speed||0)*60,
deg:d.wind?.deg||0
};
}catch{
return {speed:0,deg:0};
}
}

async function startFlight(){

if(interval) clearInterval(interval);

if(!startTime.value){ alert("Ø­Ø¯Ø¯ ÙˆÙ‚Øª Ø§Ù„Ø§Ù†Ø·Ù„Ø§Ù‚"); return; }

const startMoment = new Date(startTime.value).getTime();

const s = startCoord.value.split(',');
startPoint = L.latLng(+s[0],+s[1]);

const coords = await getCoords(city.value);
if(!coords) return;

endPoint = L.latLng(coords[0],coords[1]);

map.setView(startPoint,7);

totalDistance = map.distance(startPoint,endPoint);
dist.innerText = (totalDistance/1000).toFixed(3);

const windData = await getWind(startPoint.lat,startPoint.lng);
wind.innerText = windData.speed.toFixed(1);

const routeBearing = bearing(startPoint.lat,startPoint.lng,endPoint.lat,endPoint.lng);

if(routeLine) map.removeLayer(routeLine);
routeLine = L.polyline([startPoint,endPoint],{color:'#00ffff'}).addTo(map);

if(pigeon) map.removeLayer(pigeon);
pigeon = L.marker(startPoint,{
icon:L.divIcon({
html:"<div id='bird'>ğŸ•Šï¸</div>",
iconSize:[40,40]
})
}).addTo(map);

let traveled = 0;

interval = setInterval(()=>{

const now = Date.now();
const elapsedMin = (now - startMoment)/60000;

if(elapsedMin < 0){
elapsed.innerText = "Ù„Ù… ÙŠÙ†Ø·Ù„Ù‚ Ø¨Ø¹Ø¯";
return;
}

elapsed.innerText = elapsedMin.toFixed(2);

const rel = rad(windData.deg - routeBearing);
const windForward = windData.speed * Math.cos(rel);

const groundSpeed = AIR_SPEED + windForward;
speed.innerText = groundSpeed.toFixed(1);

traveled = groundSpeed * elapsedMin;

let progress = traveled / totalDistance;

if(progress >= 1){
pigeon.setLatLng(endPoint);
speed.innerText = "ÙˆØµÙ„ âœ”";
clearInterval(interval);
return;
}

/* Ø§Ù†Ø­Ø±Ø§Ù Ø¬Ø§Ù†Ø¨ÙŠ */
const drift = windData.speed * Math.sin(rel) * 0.000002 * traveled;

pigeon.setLatLng([
startPoint.lat+(endPoint.lat-startPoint.lat)*progress + drift,
startPoint.lng+(endPoint.lng-startPoint.lng)*progress
]);

/* Ø±ÙØ±ÙØ© */
const b=document.getElementById("bird");
if(b){
b.style.transform=`translateY(${Math.sin(Date.now()/80)*4}px)`;
}

},50);

}

</script>

</body>
</html>

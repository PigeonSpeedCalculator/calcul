<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>ELMAKKAOUY FLIGHT AI PRO - Real Physics</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <style>
        :root { --primary: #00d4ff; --bg: #0f172a; --card: #1e293b; --text: #f8fafc; --danger: #ff4d4d; }
        body { margin: 0; background: var(--bg); color: var(--text); font-family: 'Segoe UI', sans-serif; }
        #map { height: 400px; width: 100%; border-bottom: 3px solid var(--primary); }
        .container { padding: 15px; max-width: 1200px; margin: auto; }
        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 15px; }
        .panel { background: var(--card); padding: 15px; border-radius: 12px; border: 1px solid #334155; }
        .stats-bar { display: grid; grid-template-columns: repeat(4, 1fr); background: var(--card); padding: 15px; border-radius: 12px; margin: -25px auto 15px; width: 95%; position: relative; z-index: 1000; border: 1px solid var(--primary); text-align: center; }
        .stat-item b { display: block; color: var(--primary); font-size: 1.1em; }
        .stat-item span { font-size: 0.8em; color: #94a3b8; }
        input, button { width: 100%; padding: 10px; margin-top: 8px; border-radius: 6px; border: 1px solid #334155; background: #0f172a; color: white; box-sizing: border-box; }
        button { background: var(--primary); color: #000; font-weight: bold; cursor: pointer; border: none; }
        .warning { color: var(--danger); font-size: 0.8em; font-weight: bold; margin-top: 5px; display: none; }
        table { width: 100%; margin-top: 15px; border-collapse: collapse; }
        th, td { padding: 10px; border-bottom: 1px solid #444; text-align: center; }
    </style>
</head>
<body>

<div id="map"></div>

<div class="stats-bar">
    <div class="stat-item">ğŸŒ¬ï¸ Ø±ÙŠØ§Ø­ Ø­Ù‚ÙŠÙ‚ÙŠØ©<b id="st-wind-km">0 km/h</b><span id="wind-dir">--</span></div>
    <div class="stat-item">ğŸš€ Ø³Ø±Ø¹Ø© Ø§Ù„Ø­Ù…Ø§Ù…Ø© (Ø§Ù„Ù†Ø³Ø¨ÙŠØ©)<b id="st-airspeed">70 km/h</b><span>Ø§Ù„Ù‚Ø¯Ø±Ø© Ø§Ù„Ø¬Ø³Ø¯ÙŠØ©</span></div>
    <div class="stat-item">ğŸŒ Ø§Ù„Ø³Ø±Ø¹Ø© Ø§Ù„Ø£Ø±Ø¶ÙŠØ© (Ø§Ù„ÙˆØ§Ù‚Ø¹ÙŠØ©)<b id="st-groundspeed">0 km/h</b><span id="speed-impact">Ù…ØªØ£Ø«Ø±Ø© Ø¨Ø§Ù„Ø¬Ùˆ</span></div>
    <div class="stat-item">ğŸ“ Ø§Ù„Ù…Ø³Ø§ÙØ© Ø§Ù„Ù…ØªØ¨Ù‚ÙŠØ©<b id="st-rem-dist">--</b><span>Km</span></div>
</div>

<div class="container">
    <div class="grid">
        <div class="panel">
            <h3>ğŸ“ Ø¥Ø·Ù„Ø§Ù‚ Ø¨Ù…Ø­Ø§ÙƒØ§Ø© ÙÙŠØ²ÙŠØ§Ø¦ÙŠØ©</h3>
            <input id="startInput" placeholder="Ù†Ù‚Ø·Ø© Ø§Ù„Ø¥Ø·Ù„Ø§Ù‚ (Ø¨Ø­Ø« Ø£Ùˆ Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª)" oninput="handleSearch(this.value, 'start')">
            <input id="endInput" placeholder="Ù†Ù‚Ø·Ø© Ø§Ù„ÙˆØµÙˆÙ„ (Ø¨Ø­Ø« Ø£Ùˆ Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª)" oninput="handleSearch(this.value, 'end')">
            <input type="datetime-local" id="startTime">
            <div id="fog-warning" class="warning">âš ï¸ ØªÙ†Ø¨ÙŠÙ‡: Ø±Ø·ÙˆØ¨Ø© Ø¹Ø§Ù„ÙŠØ© (Ø¶Ø¨Ø§Ø¨ Ù…Ø­ØªÙ…Ù„) Ù‚Ø¯ ÙŠØ¹ÙŠÙ‚ Ø§Ù„Ù…Ù„Ø§Ø­Ø©!</div>
            <button onclick="startSimulation()">Ø¨Ø¯Ø¡ ØªØªØ¨Ø¹ Ø§Ù„Ø±Ø­Ù„Ø© Ø§Ù„ÙˆØ§Ù‚Ø¹ÙŠØ© ğŸ•Šï¸</button>
        </div>

        <div class="panel">
            <h3>ğŸ“Š ØªØ±ØªÙŠØ¨ Ø§Ù„Ù…ØªØ³Ø§Ø¨Ù‚ÙŠÙ† (Ø­Ø³Ø§Ø¨ Ø±Ø³Ù…ÙŠ)</h3>
            <input id="rName" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…ØªØ³Ø§Ø¨Ù‚">
            <input id="rDist" type="number" placeholder="Ø§Ù„Ù…Ø³Ø§ÙØ© Ø§Ù„Ù…Ù‚Ø·ÙˆØ¹Ø© (Km)">
            <input id="rTime" type="time">
            <button onclick="addRacer()" style="background:#22c55e; color:white">ØªØ³Ø¬ÙŠÙ„ ÙˆØ­Ø³Ø§Ø¨ Ù…/Ø¯</button>
        </div>
    </div>

    <div class="panel" style="margin-top:15px">
        <table>
            <thead><tr><th>#</th><th>Ø§Ù„Ø§Ø³Ù…</th><th>Ø§Ù„Ù…Ø³Ø§ÙØ©</th><th>Ø§Ù„Ø³Ø±Ø¹Ø© (Ù…/Ø¯)</th><th>Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø¬ÙˆÙŠØ©</th></tr></thead>
            <tbody id="results"></tbody>
        </table>
    </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
let map = L.map('map').setView([33.5, -7.5], 6);
L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png').addTo(map);

let pigeon, pathLine, startPt, endPt, racers = [];
let weatherData = { windKm: 0, deg: 0, hum: 0 };
const PIGEON_BASE_KMH = 70; // Ø§Ù„Ø³Ø±Ø¹Ø© Ø§Ù„Ù†Ø³Ø¨ÙŠØ© Ù„Ù„Ø­Ù…Ø§Ù…Ø© (70 ÙƒÙ…/Ø³Ø§Ø¹Ø© ÙÙŠ Ø§Ù„Ø¬Ùˆ Ø§Ù„Ø³Ø§ÙƒÙ†)

// Ø­Ø³Ø§Ø¨ Ø§Ù„Ø³Ø±Ø¹Ø© Ø§Ù„Ø£Ø±Ø¶ÙŠØ© Ø§Ù„ÙˆØ§Ù‚Ø¹ÙŠØ© (Ground Speed)
function calculatePhysics(airspeedKm, windKm, windDeg, flightDeg) {
    const angleRad = (windDeg - flightDeg) * Math.PI / 180;
    // Ø§Ù„ØªØ£Ø«ÙŠØ± Ø§Ù„Ø·ÙˆÙ„ÙŠ (Ø¯ÙØ¹ Ø£Ùˆ Ù…Ù‚Ø§ÙˆÙ…Ø©)
    const tailwind = Math.cos(angleRad) * windKm;
    // Ø§Ù„ØªØ£Ø«ÙŠØ± Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠ (Ø§Ù†Ø­Ø±Ø§Ù)
    const crosswind = Math.sin(angleRad) * windKm;
    
    // Ø§Ù„Ø³Ø±Ø¹Ø© Ø§Ù„Ø£Ø±Ø¶ÙŠØ© Ù‡ÙŠ Ù…Ø¬Ù…ÙˆØ¹ Ø³Ø±Ø¹Ø© Ø§Ù„Ø­Ù…Ø§Ù…Ø© + Ø¯ÙØ¹ Ø§Ù„Ø±ÙŠØ§Ø­
    let groundSpeed = airspeedKm + tailwind;
    
    // ØªØµØ­ÙŠØ­ Ø§Ù„Ø§Ù†Ø­Ø±Ø§Ù (Ø§Ù„Ø­Ù…Ø§Ù…Ø© ØªÙ…ÙŠÙ„ Ø¨Ø¬Ø³Ø¯Ù‡Ø§ Ù„ØªØ¹ÙˆÙŠØ¶ Ø§Ù„Ø±ÙŠØ§Ø­ Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ©)
    groundSpeed = Math.sqrt(Math.pow(groundSpeed, 2) - Math.pow(crosswind, 0.5));
    
    return groundSpeed > 10 ? groundSpeed : 10; // Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ø¯Ù†Ù‰ Ù„Ù„Ø³Ø±Ø¹Ø©
}

async function handleSearch(val, type) {
    if(val.length < 3) return;
    const r = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${val}&limit=1`);
    const d = await r.json();
    if(d[0]) {
        const pt = {lat: parseFloat(d[0].lat), lng: parseFloat(d[0].lon)};
        if(type === 'start') startPt = pt; else endPt = pt;
        getWeather(pt.lat, pt.lng);
    }
}

async function getWeather(lat, lon) {
    const r = await fetch(`https://api.openweathermap.org/data/2.5/weather?lat=${lat}&lon=${lon}&appid=992e2b79f5e3386bda09d14ff4807f9d`);
    const d = await r.json();
    weatherData = {
        windKm: (d.wind.speed * 3.6), // ØªØ­ÙˆÙŠÙ„ Ù…Ù† m/s Ø¥Ù„Ù‰ km/h
        deg: d.wind.deg,
        hum: d.main.humidity
    };
    document.getElementById('st-wind-km').innerText = weatherData.windKm.toFixed(1) + " km/h";
    document.getElementById('fog-warning').style.display = weatherData.hum > 85 ? 'block' : 'none';
}

function startSimulation() {
    if(!startPt || !endPt || !document.getElementById('startTime').value) return;

    const flightDeg = Math.atan2(endPt.lat - startPt.lat, endPt.lng - startPt.lng) * 180 / Math.PI;
    const groundSpeedKm = calculatePhysics(PIGEON_BASE_KMH, weatherData.windKm, weatherData.deg, flightDeg);
    
    document.getElementById('st-groundspeed').innerText = groundSpeedKm.toFixed(1) + " km/h";
    document.getElementById('speed-impact').innerText = groundSpeedKm > PIGEON_BASE_KMH ? "Ø±ÙŠØ§Ø­ Ø¯Ø§ÙØ¹Ø© âš¡" : "Ø±ÙŠØ§Ø­ Ù…Ø¹Ø§ÙƒØ³Ø© ğŸ¢";

    if(pathLine) map.removeLayer(pathLine);
    pathLine = L.polyline([startPt, endPt], {color: 'cyan', weight: 1}).addTo(map);
    if(!pigeon) pigeon = L.marker(startPt, {icon: L.divIcon({html: 'ğŸ•Šï¸', className: 'bird-icon'})}).addTo(map);

    function animate() {
        const elapsedH = (new Date() - new Date(document.getElementById('startTime').value)) / 3600000;
        if(elapsedH < 0) return requestAnimationFrame(animate);

        const totalD = map.distance(startPt, endPt) / 1000;
        let progress = (elapsedH * groundSpeedKm) / totalD;
        if(progress > 1) progress = 1;

        const curLat = startPt.lat + (endPt.lat - startPt.lat) * progress;
        const curLng = startPt.lng + (endPt.lng - startPt.lng) * progress;
        pigeon.setLatLng([curLat, curLng]);
        
        document.getElementById('st-rem-dist').innerText = (totalD * (1 - progress)).toFixed(2);
        if(progress < 1) requestAnimationFrame(animate);
    }
    animate();
}

function addRacer() {
    const start = new Date(document.getElementById('startTime').value);
    const end = new Date(start.toISOString().split('T')[0] + 'T' + document.getElementById('rTime').value);
    if(end < start) end.setDate(end.getDate() + 1);
    
    const min = (end - start) / 60000;
    const speed = (document.getElementById('rDist').value * 1000) / min;
    
    racers.push({name: document.getElementById('rName').value, dist: document.getElementById('rDist').value, speed});
    racers.sort((a,b) => b.speed - a.speed);
    
    document.getElementById('results').innerHTML = racers.map((r, i) => `
        <tr><td>${i+1}</td><td>${r.name}</td><td>${r.dist} Km</td><td>${r.speed.toFixed(2)}</td><td>${weatherData.hum}% Ø±Ø·ÙˆØ¨Ø©</td></tr>
    `).join('');
}
</script>
</body>
</html>

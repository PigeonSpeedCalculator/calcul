<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ELMAKKAOUY | Column-Based PDF Radar</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>

    <style>
        :root { --primary: #3b82f6; --bg: #0b0f19; --card: #161b2a; }
        body { margin: 0; background: var(--bg); color: white; font-family: 'Segoe UI', sans-serif; }
        .header { background: var(--card); padding: 15px; border-bottom: 2px solid var(--primary); display: flex; justify-content: space-between; align-items: center; }
        .container { max-width: 1000px; margin: 0 auto; padding: 15px; }
        #map { height: 400px; width: 100%; border-radius: 20px; border: 1px solid #2d3748; margin-bottom: 20px; }
        .card { background: var(--card); border-radius: 20px; padding: 20px; border: 1px solid #2d3748; }
        .input-row { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px; }
        input { background: #0b0f19; border: 1px solid #334155; color: white; padding: 12px; border-radius: 10px; width: 100%; box-sizing: border-box; }
        .upload-area { border: 2px dashed var(--primary); padding: 30px; text-align: center; border-radius: 15px; cursor: pointer; background: rgba(59, 130, 246, 0.05); }
        .racer-table { width: 100%; margin-top: 20px; border-collapse: collapse; }
        .racer-table th { background: var(--primary); padding: 12px; text-align: left; font-size: 13px; }
        .racer-table td { padding: 12px; border-bottom: 1px solid #2d3748; background: var(--card); font-size: 14px; }
        .loading { display: none; color: #f59e0b; font-weight: bold; text-align: center; margin: 10px; }
    </style>
</head>
<body>

<header class="header">
    <div style="font-weight: 900;">ELMAKKAOUY <span style="color:var(--primary)">COLUMN RADAR</span></div>
    <div id="clock">00:00:00</div>
</header>

<div class="container">
    <div id="map"></div>

    <div class="card">
        <div class="input-row">
            <div><label>üìç Release Coord</label><input type="text" id="startCoord" value="33.2722, -8.3732"></div>
            <div><label>üèôÔ∏è Central Hub</label><input type="text" id="endCoord" value="33.5731, -7.5898"></div>
        </div>

        <div class="upload-area" onclick="document.getElementById('pdfFile').click()">
            <div style="font-size: 30px;">üìÑ</div>
            <b>Upload PDF (Extracting Name & Distance Columns)</b>
            <input type="file" id="pdfFile" hidden accept=".pdf" onchange="processRacePDF(event)">
        </div>
        <div id="status" class="loading">Mapping competitors from columns...</div>
    </div>

    <table class="racer-table" id="outputTable">
        <thead>
            <tr>
                <th>Name (From Column)</th>
                <th>Distance (KM)</th>
                <th>Map Status</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>
</div>

<script>
    let map, markers = [];
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.worker.min.js';

    function initMap() {
        map = L.map('map', { zoomControl: false }).setView([33.4, -8], 8);
        L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png').addTo(map);
    }

    async function processRacePDF(event) {
        const file = event.target.files[0];
        if (!file) return;
        document.getElementById('status').style.display = 'block';
        
        const reader = new FileReader();
        reader.onload = async function() {
            const typedArray = new Uint8Array(this.result);
            const pdf = await pdfjsLib.getDocument(typedArray).promise;
            let rows = [];

            for (let i = 1; i <= pdf.numPages; i++) {
                const page = await pdf.getPage(i);
                const textContent = await page.getTextContent();
                
                // ÿßÿ≥ÿ™ÿÆÿ±ÿßÿ¨ ÿßŸÑŸÜÿµŸàÿµ Ÿàÿ™ÿ±ÿ™Ÿäÿ®Ÿáÿß ÿ≠ÿ≥ÿ® ÿ•ÿ≠ÿØÿßÿ´Ÿäÿßÿ™Ÿáÿß ŸÅŸä ÿßŸÑÿµŸÅÿ≠ÿ© (ŸÑÿ∂ŸÖÿßŸÜ ÿßŸÑÿ£ÿπŸÖÿØÿ©)
                let items = textContent.items.map(item => ({
                    text: item.str,
                    x: item.transform[4],
                    y: item.transform[5]
                }));

                // ÿ™ÿ¨ŸÖŸäÿπ ÿßŸÑÿπŸÜÿßÿµÿ± ÿßŸÑÿ™Ÿä ÿ™ŸÇÿπ ÿπŸÑŸâ ŸÜŸÅÿ≥ ÿßŸÑÿ≥ÿ∑ÿ± (ŸÜŸÅÿ≥ Y ÿ™ŸÇÿ±Ÿäÿ®ÿßŸã)
                let lines = {};
                items.forEach(item => {
                    let y = Math.round(item.y);
                    if (!lines[y]) lines[y] = [];
                    lines[y].push(item);
                });

                // ŸÖÿπÿßŸÑÿ¨ÿ© ŸÉŸÑ ÿ≥ÿ∑ÿ± ŸÉÿ£ŸÜŸá ÿµŸÅ ŸÅŸä ÿ¨ÿØŸàŸÑ
                Object.keys(lines).sort((a, b) => b - a).forEach(y => {
                    let lineItems = lines[y].sort((a, b) => a.x - b.x);
                    let rowText = lineItems.map(i => i.text).join(' ');
                    
                    // ÿßŸÑÿ®ÿ≠ÿ´ ÿπŸÜ ÿßŸÑŸÖÿ≥ÿßŸÅÿ© (ÿ±ŸÇŸÖ ÿπÿ¥ÿ±Ÿä) ŸàÿßŸÑÿßÿ≥ŸÖ ŸÅŸä ÿßŸÑÿ≥ÿ∑ÿ±
                    const distMatch = rowText.match(/(\d{1,3}\.\d{2,4})/);
                    if (distMatch) {
                        const distance = parseFloat(distMatch[0]);
                        // ÿßÿ≥ÿ™ÿÆÿ±ÿßÿ¨ ÿßŸÑÿßÿ≥ŸÖ: ŸÜÿ£ÿÆÿ∞ ÿßŸÑŸÉŸÑŸÖÿßÿ™ ÿßŸÑÿ∑ŸàŸäŸÑÿ© ÿßŸÑÿ™Ÿä ÿ™ÿ≥ÿ®ŸÇ ÿßŸÑŸÖÿ≥ÿßŸÅÿ©
                        const name = rowText.split(distMatch[0])[0].replace(/[\d-#]/g, '').trim();
                        if (name.length > 2) rows.push({ name, distance });
                    }
                });
            }
            renderResults(rows);
        };
        reader.readAsArrayBuffer(file);
    }

    function renderResults(data) {
        const start = document.getElementById('startCoord').value.split(',').map(Number);
        const end = document.getElementById('endCoord').value.split(',').map(Number);
        const tbody = document.querySelector('#outputTable tbody');
        
        tbody.innerHTML = "";
        markers.forEach(m => map.removeLayer(m));
        markers = [];

        data.forEach(item => {
            const totalPath = L.latLng(start).distanceTo(L.latLng(end)) / 1000;
            const ratio = Math.min(item.distance / totalPath, 1);
            const pos = [
                start[0] + (end[0] - start[0]) * ratio,
                start[1] + (end[1] - start[1]) * ratio
            ];

            const m = L.marker(pos, {
                icon: L.divIcon({ html: 'üïäÔ∏è', className: 'p-icon', iconSize:[25,25] })
            }).addTo(map).bindPopup(item.name);
            markers.push(m);

            tbody.innerHTML += `<tr>
                <td><b>${item.name}</b></td>
                <td style="color:#3b82f6; font-weight:bold;">${item.distance} KM</td>
                <td style="color:#22c55e;">In Radar üìç</td>
            </tr>`;
        });

        document.getElementById('status').style.display = 'none';
        if (markers.length) map.fitBounds(new L.featureGroup(markers).getBounds(), {padding:[50,50]});
    }

    setInterval(() => { document.getElementById('clock').innerText = new Date().toTimeString().split(' ')[0]; }, 1000);
    initMap();
</script>
</body>
</html>

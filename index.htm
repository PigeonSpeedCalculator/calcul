<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ELMAKKAOUY RADAR PRO</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

<style>
:root{
--primary:#00d4ff;
--bg:#0b0f19;
--card:#161b2a;
--accent:#00ff88;
}
body{
margin:0;
background:var(--bg);
color:#fff;
font-family:'Segoe UI',sans-serif;
height:100vh;
display:flex;
flex-direction:column
}
nav{
display:flex;
background:#1a1f2e;
border-bottom:2px solid var(--primary)
}
.nav-btn{
flex:1;
padding:15px;
border:none;
background:none;
color:#8892b0;
font-weight:bold;
font-size:1rem;
cursor:pointer
}
.nav-btn.active{
color:var(--primary);
border-bottom:4px solid var(--primary)
}
.container{flex:1;overflow:hidden}
.page{display:none;height:100%;overflow-y:auto;padding:20px}
.page.active{display:block}

#map{
height:400px;
border-radius:15px;
border:1px solid #2d3343
}

.stats-bar{
display:grid;
grid-template-columns:repeat(3,1fr);
gap:10px;
margin:15px 0
}
.stat-card{
background:var(--card);
padding:10px;
border-radius:8px;
text-align:center;
border:1px solid #2d3343
}
.stat-card small{color:#8892b0;font-size:11px}
.stat-card b{color:var(--primary)}

.form-section{
background:var(--card);
padding:20px;
border-radius:15px;
border:1px solid #2d3343;
margin-bottom:20px
}
label{
display:block;
color:var(--primary);
font-size:12px;
font-weight:bold;
margin-top:10px
}
input{
width:100%;
padding:12px;
margin-top:5px;
border-radius:8px;
border:1px solid #2d3343;
background:#0b0f19;
color:#fff
}
.action-btn{
width:100%;
padding:15px;
border:none;
border-radius:10px;
font-weight:800;
cursor:pointer;
margin-top:10px
}

.search-results{
background:#1a1f2e;
position:absolute;
width:90%;
max-height:200px;
overflow:auto;
z-index:2000
}
.search-item{
padding:10px;
border-bottom:1px solid #2d3343;
cursor:pointer
}
.search-item:hover{
background:var(--primary);
color:#000
}

#resultCapture{
display:none;
background:#fff;
color:#000;
border-radius:15px;
overflow:hidden;
margin-top:20px
}
table{width:100%;border-collapse:collapse}
th{
background:#0b0f19;
color:#fff;
padding:15px
}
td{
padding:12px;
text-align:center;
font-weight:bold
}
</style>
</head>

<body>

<nav>
<button class="nav-btn active" onclick="showTab('radar-tab',this)">ğŸ“¡ Ø§Ù„Ø±Ø§Ø¯Ø§Ø±</button>
<button class="nav-btn" onclick="showTab('calc-tab',this)">â±ï¸ Ø§Ù„Ø­Ø³Ø§Ø¨</button>
</nav>

<div class="container">

<!-- ================= RADAR TAB ================= -->
<div id="radar-tab" class="page active">

<div id="map"></div>

<div class="stats-bar">
<div class="stat-card"><small>Ø§Ù„Ø±ÙŠØ§Ø­</small><b id="ws">--</b></div>
<div class="stat-card"><small>Ø§Ù„Ø§ØªØ¬Ø§Ù‡</small><b id="wd">--</b></div>
<div class="stat-card"><small>Ø§Ù„Ø­Ø±Ø§Ø±Ø©</small><b id="wt">--</b></div>
</div>

<div class="form-section" style="position:relative">
<label>Ù…Ø¯ÙŠÙ†Ø© Ø§Ù„ÙˆØµÙˆÙ„</label>
<input id="cityIn" oninput="searchCity(this.value)">
<div id="results" class="search-results"></div>

<label>Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª Ø§Ù„Ø§Ù†Ø·Ù„Ø§Ù‚</label>
<input id="startCoord" value="33.2722,-8.3732" onchange="initWeather()">

<label>ÙˆÙ‚Øª Ø§Ù„Ø§Ù†Ø·Ù„Ø§Ù‚</label>
<input type="datetime-local" id="startTimeOfficial">

<button class="action-btn" style="background:var(--primary)" onclick="startPigeonSim()">Ø¥Ø·Ù„Ø§Ù‚ ğŸ•Šï¸</button>
</div>

</div>

<!-- ================= CALC TAB ================= -->
<div id="calc-tab" class="page">

<div class="form-section">
<label>Ø§Ø³Ù… Ø§Ù„Ù…ØªØ³Ø§Ø¨Ù‚</label>
<input id="racerName">

<label>Ø§Ù„Ù…Ø³Ø§ÙØ© (Km)</label>
<input id="racerDist" type="number">

<label>ÙˆÙ‚Øª Ø§Ù„ÙˆØµÙˆÙ„</label>
<div style="display:flex;gap:10px">
<input id="h" placeholder="HH" value="12">
<input id="m" placeholder="MM" value="0">
<input id="s" placeholder="SS" value="0">
</div>

<button class="action-btn" style="background:var(--accent)" onclick="addToList()">Ø¥Ø¶Ø§ÙØ©</button>
</div>

<div id="racersList"></div>

<button class="action-btn" style="background:#fff;color:#000" onclick="calculateSpeed()">Ø¹Ø±Ø¶ Ø§Ù„Ù†ØªØ§Ø¦Ø¬</button>

<div id="resultCapture">
<div style="background:#0b0f19;color:var(--primary);padding:20px;text-align:center">
<h2 style="margin:0">ELMAKKAOUY RADAR PRO</h2>
</div>
<table>
<thead>
<tr>
<th>#</th><th>Ø§Ù„Ø§Ø³Ù…</th><th>Km</th><th>Ø§Ù„ÙˆØµÙˆÙ„</th><th>Ù…/Ø¯</th>
</tr>
</thead>
<tbody id="resBody"></tbody>
</table>
</div>

<button class="action-btn" id="dlBtn" style="display:none" onclick="saveAsImage()">ğŸ“¸ Ø­ÙØ¸</button>

</div>
</div>

<script>
let map,startMarker,pigeon,route,dest=null;
let racers=[];
let mapReady=false;

/* ---------- NAV ---------- */
function showTab(id,btn){
document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
document.querySelectorAll('.nav-btn').forEach(b=>b.classList.remove('active'));
document.getElementById(id).classList.add('active');
btn.classList.add('active');

if(id==='radar-tab'){
setTimeout(initMap,100);
}
}

/* ---------- MAP ---------- */
function initMap(){
if(mapReady) return;

map = L.map('map',{zoomControl:false}).setView([33.2722,-8.3732],7);

L.tileLayer(
'https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png',
{attribution:'Â© OpenStreetMap'}
).addTo(map);

startMarker = L.marker([33.2722,-8.3732]).addTo(map);

mapReady=true;

setTimeout(()=>{
map.invalidateSize();
initWeather();
},300);
}

/* ---------- WEATHER ---------- */
async function initWeather(){
const c=startCoord.value.split(',');
if(c.length!==2) return;

const res=await fetch(
`https://api.openweathermap.org/data/2.5/weather?lat=${c[0]}&lon=${c[1]}&units=metric&appid=992e2b79f5e3386bda09d14ff4807f9d`
);
const d=await res.json();

ws.innerText=(d.wind.speed*3.6).toFixed(1)+' km/h';
wt.innerText=d.main.temp+' Â°C';

const dirs=['Ø´Ù…Ø§Ù„','Ø´Ù…Ø§Ù„ Ø´Ø±Ù‚ÙŠ','Ø´Ø±Ù‚','Ø¬Ù†ÙˆØ¨ Ø´Ø±Ù‚ÙŠ','Ø¬Ù†ÙˆØ¨','Ø¬Ù†ÙˆØ¨ ØºØ±Ø¨ÙŠ','ØºØ±Ø¨','Ø´Ù…Ø§Ù„ ØºØ±Ø¨ÙŠ'];
wd.innerText=dirs[Math.round(d.wind.deg/45)%8];
}

/* ---------- CITY SEARCH ---------- */
async function searchCity(q){
if(q.length<3) return;

const r=await fetch(
`https://nominatim.openstreetmap.org/search?format=json&q=${q}&limit=5`,
{headers:{'User-Agent':'ELMAKKAOUY-RADAR'}}
);
const d=await r.json();

results.innerHTML=d.map(x=>
`<div class="search-item" onclick="pickCity(${x.lat},${x.lon},'${x.display_name}')">
${x.display_name.split(',')[0]}
</div>`
).join('');
}

function pickCity(lat,lon,name){
dest=[lat,lon];
cityIn.value=name.split(',')[0];
results.innerHTML='';

const km=(map.distance(startMarker.getLatLng(),dest)/1000).toFixed(3);
racerDist.value=km;

if(route) map.removeLayer(route);
route=L.polyline(
[startMarker.getLatLng(),dest],
{color:'#00d4ff',dashArray:'5,10'}
).addTo(map);

map.fitBounds(route.getBounds(),{padding:[40,40]});
}

/* ---------- PIGEON ---------- */
function startPigeonSim(){
if(!dest || !mapReady) return alert('Ø§Ø®ØªØ± Ù…Ø¯ÙŠÙ†Ø© Ø§Ù„ÙˆØµÙˆÙ„');

if(pigeon) map.removeLayer(pigeon);

pigeon=L.marker(startMarker.getLatLng(),{
icon:L.divIcon({html:'ğŸ•Šï¸',iconSize:[30,30]})
}).addTo(map);

let p=0;
const start=startMarker.getLatLng();

const t=setInterval(()=>{
p+=0.01;
if(p>=1) clearInterval(t);

pigeon.setLatLng([
start.lat+(dest[0]-start.lat)*p,
start.lng+(dest[1]-start.lng)*p
]);
},50);
}

/* ---------- RACE ---------- */
function addToList(){
if(!racerName.value || !racerDist.value) return;

racers.push({
name:racerName.value,
dist:parseFloat(racerDist.value),
h:+h.value,m:+m.value,s:+s.value
});

racersList.innerHTML=racers.map(r=>
`<div style="padding:6px">${r.name} - ${r.dist} Km</div>`
).join('');

racerName.value='';
}

function calculateSpeed(){
const start=new Date(startTimeOfficial.value);

const res=racers.map(r=>{
const a=new Date(start);
a.setHours(r.h,r.m,r.s);

let diff=(a-start)/60000;
if(diff<=0) diff=0.1;

return {...r,speed:(r.dist*1000/diff)};
}).sort((a,b)=>b.speed-a.speed);

resBody.innerHTML=res.map((r,i)=>`
<tr>
<td>${i+1}</td>
<td>${r.name}</td>
<td>${r.dist}</td>
<td>${r.h}:${r.m}:${r.s}</td>
<td style="color:#10b981">${r.speed.toFixed(3)}</td>
</tr>
`).join('');

resultCapture.style.display='block';
dlBtn.style.display='block';
}

/* ---------- EXPORT ---------- */
function saveAsImage(){
html2canvas(resultCapture,{backgroundColor:'#fff',scale:2})
.then(c=>{
const a=document.createElement('a');
a.download='ELMAKKAOUY_RESULTS.png';
a.href=c.toDataURL();
a.click();
});
}

/* ---------- INIT TIME ---------- */
window.onload=()=>{
const d=new Date();
d.setMinutes(d.getMinutes()-d.getTimezoneOffset());
startTimeOfficial.value=d.toISOString().slice(0,16);
};
</script>

</body>
</html>

<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8">
<title>ELMAKKAOUY REAL FLIGHT PRO</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<style>
body{margin:0;background:#0f172a;color:white;font-family:Arial}
#map{height:420px}
.panel{padding:15px;background:#111827}

input,button{
width:100%;padding:10px;margin-top:8px;
background:#0b1220;border:1px solid #1f2937;
color:white;border-radius:6px
}
button{background:#00d4ff;color:black;font-weight:bold;cursor:pointer}

.stat{margin:6px 0}
.stat b{color:#00ff88}

/* Ø¥Ø²Ø§Ù„Ø© Ø®Ù„ÙÙŠØ© Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø© */
.leaflet-div-icon{
background:transparent!important;
border:none!important;
}

/* Ø±ÙØ±ÙØ© */
@keyframes flap{
from{transform:scale(1)}
to{transform:scale(1.15)}
}

#bird{
font-size:30px;
display:inline-block;
animation:flap 0.35s infinite alternate ease-in-out;
transform-origin:center;
}
</style>
</head>

<body>

<div id="map"></div>

<div class="panel">
<input type="datetime-local" id="startTime">
<input id="startCoord" value="33.421265,-7.812173">
<input id="city" placeholder="Ø§ÙƒØªØ¨ Ù…Ø¯ÙŠÙ†Ø© Ø§Ù„ÙˆØµÙˆÙ„">
<button onclick="startFlight()">Ø¨Ø¯Ø¡ Ø§Ù„ØªØªØ¨Ø¹ ğŸ•Šï¸</button>

<hr>

<div class="stat">ğŸ“ Ø§Ù„Ù…Ø³Ø§ÙØ©: <b id="dist">--</b> Km</div>
<div class="stat">ğŸš€ Ø§Ù„Ø³Ø±Ø¹Ø©: <b id="speed">--</b> m/min</div>
<div class="stat">ğŸŒ¬ï¸ Ø§Ù„Ø±ÙŠØ§Ø­: <b id="wind">--</b> m/min</div>
<div class="stat">ğŸ§­ Ø§Ù„Ø§ØªØ¬Ø§Ù‡: <b id="heading">--</b> Â°</div>

</div>

<script>

/* ================== Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø®Ø±ÙŠØ·Ø© ================== */

let map = L.map('map').setView([33.4,-7.8],7);
L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png').addTo(map);

let pigeon, routeLine, animationId;
let startPoint, endPoint;
let totalDistance=0;

const AIR_SPEED = 1200; // m/min Ø³Ø±Ø¹Ø© Ø³Ø¨Ø§Ù‚

/* ================== Ø£Ø¯ÙˆØ§Øª Ø±ÙŠØ§Ø¶ÙŠØ© ================== */

function rad(x){return x*Math.PI/180}
function deg(x){return x*180/Math.PI}

function haversine(a,b,c,d){
const R=6371000;
const dLat=rad(c-a);
const dLon=rad(d-b);
const x=Math.sin(dLat/2)**2+
Math.cos(rad(a))*Math.cos(rad(c))*Math.sin(dLon/2)**2;
return 2*R*Math.asin(Math.sqrt(x));
}

function bearing(a,b,c,d){
const y=Math.sin(rad(d-b))*Math.cos(rad(c));
const x=Math.cos(rad(a))*Math.sin(rad(c))-
Math.sin(rad(a))*Math.cos(rad(c))*Math.cos(rad(d-b));
return (deg(Math.atan2(y,x))+360)%360;
}

/* ================== Ø¬Ù„Ø¨ Ø§Ù„Ù…Ø¯ÙŠÙ†Ø© ================== */

async function getCoords(name){
const r=await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(name)}&limit=1`);
const d=await r.json();
if(!d.length){
alert("Ø§Ù„Ù…Ø¯ÙŠÙ†Ø© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©");
return null;
}
return [parseFloat(d[0].lat),parseFloat(d[0].lon)];
}

/* ================== Ø¬Ù„Ø¨ Ø§Ù„Ø±ÙŠØ§Ø­ ================== */

async function getWind(lat,lon){
try{
const r=await fetch(`https://api.openweathermap.org/data/2.5/weather?lat=${lat}&lon=${lon}&appid=992e2b79f5e3386bda09d14ff4807f9d`);
const d=await r.json();
return{
speed:(d.wind?.speed||0)*60, // m/min
deg:d.wind?.deg||0
};
}catch{
return{speed:0,deg:0};
}
}

/* ================== Ø¨Ø¯Ø¡ Ø§Ù„Ù…Ø­Ø§ÙƒØ§Ø© ================== */

async function startFlight(){

cancelAnimationFrame(animationId);

if(!startTime.value) return alert("Ø­Ø¯Ø¯ ÙˆÙ‚Øª Ø§Ù„Ø§Ù†Ø·Ù„Ø§Ù‚");

const s=startCoord.value.split(',');
startPoint=L.latLng(+s[0],+s[1]);

const coords=await getCoords(city.value);
if(!coords) return;

endPoint=L.latLng(coords[0],coords[1]);

totalDistance=haversine(startPoint.lat,startPoint.lng,endPoint.lat,endPoint.lng);
dist.innerText=(totalDistance/1000).toFixed(3);

if(routeLine) map.removeLayer(routeLine);
routeLine=L.polyline([startPoint,endPoint],{color:'#00ffff'}).addTo(map);

if(pigeon) map.removeLayer(pigeon);

pigeon=L.marker(startPoint,{
icon:L.divIcon({
html:`<div id="bird">ğŸ•Šï¸</div>`,
iconSize:[30,30],
className:''
})
}).addTo(map);

map.fitBounds(routeLine.getBounds(),{padding:[50,50]});

const wind=await getWind(startPoint.lat,startPoint.lng);
windEl=document.getElementById("wind");
windEl.innerText=wind.speed.toFixed(1);

/* Ù…ÙˆÙ‚Ø¹ Ø­Ø§Ù„ÙŠ */
let current={
lat:startPoint.lat,
lng:startPoint.lng
};

let lastTime=performance.now();

function animate(now){

let dt=(now-lastTime)/60000;
lastTime=now;

/* Ø§ØªØ¬Ø§Ù‡ Ù†Ø­Ùˆ Ø§Ù„Ù‡Ø¯Ù */
let routeBear=bearing(current.lat,current.lng,endPoint.lat,endPoint.lng);

/* Ù…ØªØ¬Ù‡ Ù‡ÙˆØ§Ø¦ÙŠ */
let airX=AIR_SPEED*Math.cos(rad(routeBear));
let airY=AIR_SPEED*Math.sin(rad(routeBear));

/* Ù…ØªØ¬Ù‡ Ø§Ù„Ø±ÙŠØ§Ø­ */
let windX=wind.speed*Math.cos(rad(wind.deg));
let windY=wind.speed*Math.sin(rad(wind.deg));

/* Ù…ØªØ¬Ù‡ Ø£Ø±Ø¶ÙŠ */
let groundX=airX+windX;
let groundY=airY+windY;

let groundSpeed=Math.sqrt(groundX**2+groundY**2);

document.getElementById("speed").innerText=groundSpeed.toFixed(1);

/* Ø§Ù„Ø§ØªØ¬Ø§Ù‡ Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠ */
let heading=deg(Math.atan2(groundY,groundX));
document.getElementById("heading").innerText=heading.toFixed(0);

/* ØªØ­Ø±ÙŠÙƒ */
let metersStep=groundSpeed*dt;
let ratio=metersStep/totalDistance;

current.lat+=(endPoint.lat-current.lat)*ratio;
current.lng+=(endPoint.lng-current.lng)*ratio;

pigeon.setLatLng([current.lat,current.lng]);

/* ØªØ¯ÙˆÙŠØ± */
document.getElementById("bird").style.transform=
`rotate(${heading}deg) scale(${1+0.05*Math.sin(Date.now()/80)})`;

/* ØªØ­Ù‚Ù‚ Ø§Ù„ÙˆØµÙˆÙ„ */
if(haversine(current.lat,current.lng,endPoint.lat,endPoint.lng)<5){
document.getElementById("speed").innerText="ÙˆØµÙ„ âœ”";
return;
}

animationId=requestAnimationFrame(animate);
}

animationId=requestAnimationFrame(animate);
}

</script>

</body>
</html>

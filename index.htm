<!DOCTYPE html>
<html lang="ar">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ø­Ø³Ø§Ø¨ Ø³Ø±Ø¹Ø© Ø§Ù„Ø­Ù…Ø§Ù…</title>
        <title>BY ELMAKKAOUY</title>

    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#3182ce">
    <style>
        body { margin: 0; padding: 0; background: #f0f2f5; font-family: 'Segoe UI', Tahoma, sans-serif; }
        #app-root { max-width: 500px; margin: 0 auto; min-height: 100vh; background: #fff; position: relative; padding-bottom: 50px; }
        
        /* Ø´Ø±ÙŠØ· Ø¹Ù„ÙˆÙŠ Ù…Ø«Ø¨Øª ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø§Ù„Ø¨Ø­Ø« ÙˆØ²Ø± Ø§Ù„Ø­Ø³Ø§Ø¨ */
        .sticky-header {
            position: sticky;
            top: 0;
            z-index: 1000;
            background: #fff;
            padding: 10px 15px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .header-top { display: flex; justify-content: space-between; align-items: center; }
        
        .btn-calc { 
            background: #27ae60; color: white; border: none; 
            padding: 8px 20px; border-radius: 20px; font-weight: bold; 
            cursor: pointer; font-size: 16px; border: 2px solid #fff;
        }

        #searchInput { 
            width: 100%; padding: 12px; border: 2px solid #3182ce; 
            border-radius: 10px; font-size: 16px !important; box-sizing: border-box;
        }

        .content { padding: 15px; }
        .card { background: #fff; border: 1px solid #e2e8f0; border-radius: 12px; padding: 15px; margin-bottom: 12px; }
        input[type="text"], input[type="number"] { width: 100%; padding: 12px; margin: 8px 0; border: 1px solid #cbd5e0; border-radius: 8px; font-size: 16px !important; box-sizing: border-box; text-align: center; }
        
        /* ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù†ØªØ§Ø¦Ø¬ */
        #rankingSection { margin-top: 20px; border-top: 3px solid #3182ce; padding-top: 20px; }
        .result-item { display:flex; justify-content:space-between; align-items:center; padding:12px; border-bottom:1px solid #edf2f7; }
        .top-3 { background: #fffaf0; }
        
        .btn-save { width: 100%; padding: 15px; background: #4a5568; color: white; border: none; border-radius: 10px; font-weight: bold; margin-top: 15px; cursor: pointer; }
        .delete-btn { background:#fee2e2; color:#ef4444; border:none; padding:8px 12px; border-radius:8px; cursor:pointer; }
    </style>
</head>
<body>

<div dir="rtl" id="app-root">
    <div class="sticky-header">
        <div class="header-top">
            <h3 style="margin:0; color:#3182ce;">Ø³Ø±Ø¹Ø© Ø§Ù„Ø­Ù…Ø§Ù… ğŸ•Šï¸</h3>
            <button class="btn-calc" onclick="generateRankings()">Ø­Ø³Ø§Ø¨ Ø§Ù„Ù†ØªØ§Ø¦Ø¬ ğŸ†</button>
        </div>
        <div id="searchArea">
            <input type="text" id="searchInput" onkeyup="filterNames()" placeholder="Ø§Ø¨Ø­Ø« Ø¹Ù† Ø§Ø³Ù… Ø§Ù„Ù…ØªØ³Ø§Ø¨Ù‚...">
        </div>
    </div>

    <div class="content">
        <div class="card" style="background:#f8fafc;">
            <label style="font-weight:bold;">1. Ø§Ø±ÙØ¹ Ù…Ù„Ù Ø§Ù„Ù€ PDF:</label>
            <input type="file" id="pdfInput" accept=".pdf">
            <label style="font-weight:bold;">2. ÙˆÙ‚Øª Ø§Ù„Ø¥Ø·Ù„Ø§Ù‚:</label>
            <input type="text" id="lacheTime" placeholder="07:00:00" maxlength="8" oninput="formatTime(this)" inputmode="numeric">
            <button onclick="addManualEntry()" style="margin-top:10px; background:#3182ce; color:white; border:none; padding:10px; border-radius:8px; width:100%; font-weight:bold;">+ Ø¥Ø¶Ø§ÙØ© Ù…ØªØ³Ø§Ø¨Ù‚ ÙŠØ¯ÙˆÙŠØ§Ù‹</button>
        </div>

        <div id="inputSection">
            <div id="inputCardsContainer"></div>
        </div>

        <div id="rankingSection" style="display:none;">
            <div id="capture-area" style="background:#fff; border:1px solid #ddd; border-radius:8px; overflow:hidden;">
                <div style="background:#3182ce; color:white; padding:15px; text-align:center;">
                    <h3 style="margin:0;">Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…ØªØµØ¯Ø±ÙŠÙ†</h3>
                </div>
                <div id="rankingList"></div>
            </div>
            <button class="btn-save" onclick="saveAsImage()">ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù†ØªÙŠØ¬Ø© ÙƒØµÙˆØ±Ø© ğŸ“¸</button>
        </div>
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

<script>
    let basePigeons = [];
    const pdfjsLib = window['pdfjs-dist/build/pdf'];
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js';

    function formatTime(t) {
        let v = t.value.replace(/\D/g, '');
        if (v.length > 2 && v.length <= 4) v = v.slice(0, 2) + ':' + v.slice(2);
        else if (v.length > 4) v = v.slice(0, 2) + ':' + v.slice(2, 4) + ':' + v.slice(4, 6);
        t.value = v;
    }

    document.getElementById('pdfInput').addEventListener('change', async function(e) {
        const file = e.target.files[0];
        const reader = new FileReader();
        reader.onload = async function() {
            const pdf = await pdfjsLib.getDocument(new Uint8Array(this.result)).promise;
            let extracted = [];
            for (let i = 1; i <= pdf.numPages; i++) {
                const page = await pdf.getPage(i);
                const content = await page.getTextContent();
                let lines = {};
                content.items.forEach(it => {
                    let y = Math.round(it.transform[5]);
                    if (!lines[y]) lines[y] = [];
                    lines[y].push(it);
                });
                Object.keys(lines).sort((a,b)=>b-a).forEach(y => {
                    let row = lines[y].sort((a,b)=>a.transform[4]-b.transform[4]).map(it=>it.str.trim()).filter(s=>s!=="");
                    if (row.length >= 5 && /^\d+$/.test(row[0])) {
                        extracted.push({ name: row[1], dist: parseFloat(row[row.length-1]), manual: false });
                    }
                });
            }
            basePigeons = extracted;
            renderInputCards();
        };
        reader.readAsArrayBuffer(file);
    });

    function addManualEntry() {
        basePigeons.unshift({ name: "", dist: 0, manual: true });
        renderInputCards();
    }

    function renderInputCards() {
        const container = document.getElementById('inputCardsContainer');
        container.innerHTML = "";
        basePigeons.forEach((p, i) => {
            const card = document.createElement('div');
            card.className = "card";
            card.setAttribute('data-name', p.name);
            let head = p.manual ? `<div style="display:flex; gap:10px;"><input type="text" placeholder="Ø§Ù„Ø§Ø³Ù…" onchange="basePigeons[${i}].name=this.value; this.parentElement.parentElement.setAttribute('data-name', this.value)" style="flex:2;"><input type="number" placeholder="Km" onchange="basePigeons[${i}].dist=parseFloat(this.value)" style="flex:1;"></div>` : `<div style="display:flex; justify-content:space-between; font-weight:bold;"><span>${p.name}</span><span style="color:#3182ce;">${p.dist.toFixed(3)} Km</span></div>`;
            card.innerHTML = head + `<div id="wrap-${i}"><div style="display:flex; gap:10px; margin-top:10px;"><input type="text" maxlength="8" oninput="formatTime(this)" inputmode="numeric" placeholder="00:00:00" class="t-inp-${i}" style="flex:1;"><button onclick="this.parentElement.remove()" class="delete-btn">ğŸ—‘ï¸</button></div></div><button onclick="addInput(${idx=i})" style="background:none; border:1px dashed #3182ce; color:#3182ce; font-size:12px; margin-top:5px; cursor:pointer; width:100%;">+ Ø¥Ø¶Ø§ÙØ© ØªÙˆÙ‚ÙŠØª Ø¢Ø®Ø±</button>`;
            container.appendChild(card);
        });
    }

    function addInput(idx) {
        const div = document.createElement('div');
        div.style.cssText = "display:flex; gap:10px; margin-top:10px;";
        div.innerHTML = `<input type="text" maxlength="8" oninput="formatTime(this)" inputmode="numeric" placeholder="00:00:00" class="t-inp-${idx}" style="flex:1;"><button onclick="this.parentElement.remove()" class="delete-btn">ğŸ—‘ï¸</button>`;
        document.getElementById(`wrap-${idx}`).appendChild(div);
    }

    function filterNames() {
        let val = document.getElementById('searchInput').value.toLowerCase();
        document.querySelectorAll('.card[data-name]').forEach(c => {
            c.style.display = c.getAttribute('data-name').toLowerCase().includes(val) ? "block" : "none";
        });
    }

    function generateRankings() {
        let results = [];
        const lache = document.getElementById('lacheTime').value;
        if(lache.length < 5) return alert("ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ ÙˆÙ‚Øª Ø§Ù„Ø¥Ø·Ù„Ø§Ù‚ Ø£ÙˆÙ„Ø§Ù‹");
        
        basePigeons.forEach((p, i) => {
            document.querySelectorAll(`.t-inp-${i}`).forEach(inp => {
                if(inp.value.length >= 5 && p.name && p.dist > 0) {
                    let d1 = new Date("2026-01-01 " + lache);
                    let d2 = new Date("2026-01-01 " + inp.value);
                    let diff = (d2 - d1) / 60000;
                    if(diff <= 0) diff += 1440;
                    results.push({ name: p.name, dist: p.dist, time: inp.value, speed: (p.dist * 1000) / diff });
                }
            });
        });
        results.sort((a,b) => b.speed - a.speed);
        const list = document.getElementById('rankingList');
        list.innerHTML = results.map((r, i) => `<div class="result-item ${i < 3 ? 'top-3' : ''}"><div><b>${i+1}. ${r.name}</b><br><small>${r.dist.toFixed(3)} Km | ${r.time}</small></div><b style="color:#e53e3e; font-size:18px;">${r.speed.toFixed(3)}</b></div>`).join('');
        document.getElementById('rankingSection').style.display = 'block';
        
        // Ø§Ù„ØªÙ…Ø±ÙŠØ± Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ Ù„Ù„Ù†ØªØ§Ø¦Ø¬
        document.getElementById('rankingSection').scrollIntoView({ behavior: 'smooth' });
    }

    function saveAsImage() {
        const area = document.getElementById('capture-area');
        html2canvas(area, { scale: 2 }).then(canvas => {
            const link = document.createElement('a');
            link.download = 'Ù†ØªØ§Ø¦Ø¬_Ø§Ù„Ø³Ø¨Ø§Ù‚.png';
            link.href = canvas.toDataURL();
            link.click();
        });
    }

    if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('./sw.js');
    }
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ELMAKKAOUY RADAR PRO</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<style>
:root{
--primary:#00d4ff;
--bg:#0b0f19;
--card:#161b2a;
}
body{
margin:0;background:var(--bg);color:#fff;
font-family:'Segoe UI',sans-serif;
height:100vh;display:flex;flex-direction:column
}
nav{display:flex;background:#1a1f2e;border-bottom:2px solid var(--primary)}
.nav-btn{
flex:1;padding:15px;border:none;background:none;
color:#8892b0;font-weight:bold;font-size:1rem;cursor:pointer
}
.nav-btn.active{color:var(--primary);border-bottom:4px solid var(--primary)}
.container{flex:1;overflow:hidden}
.page{display:none;height:100%;overflow-y:auto;padding:20px}
.page.active{display:block}

#map{height:400px;border-radius:15px;border:1px solid #2d3343}

.stats-bar{
display:grid;
grid-template-columns:repeat(4,1fr);
gap:10px;margin:15px 0
}
.stat-card{
background:var(--card);padding:10px;
border-radius:8px;text-align:center;border:1px solid #2d3343
}
.stat-card small{color:#8892b0;font-size:11px}
.stat-card b{color:var(--primary)}

.form-section{
background:var(--card);padding:20px;border-radius:15px;
border:1px solid #2d3343;margin-bottom:20px
}
label{display:block;color:var(--primary);font-size:12px;font-weight:bold}
input{
width:100%;padding:12px;margin-top:5px;
border-radius:8px;border:1px solid #2d3343;
background:#0b0f19;color:#fff
}
button{
width:100%;padding:15px;border:none;border-radius:10px;
font-weight:800;cursor:pointer;margin-top:10px;
background:var(--primary);color:#000
}
</style>
</head>

<body>

<nav>
<button class="nav-btn active" onclick="showTab('radar',this)">ğŸ“¡ Ø§Ù„Ø±Ø§Ø¯Ø§Ø±</button>
</nav>

<div class="container">
<div id="radar" class="page active">

<div id="map"></div>

<div class="stats-bar">
<div class="stat-card"><small>Ø§Ù„Ø±ÙŠØ§Ø­</small><b id="ws">--</b></div>
<div class="stat-card"><small>Ø§Ù„Ø§ØªØ¬Ø§Ù‡</small><b id="wd">--</b></div>
<div class="stat-card"><small>Ø§Ù„Ø­Ø±Ø§Ø±Ø©</small><b id="wt">--</b></div>
<div class="stat-card"><small>Ø³Ø±Ø¹Ø© Ø§Ù„Ø·ÙŠØ±Ø§Ù†</small><b id="ps">-- km/h</b></div>
</div>

<div class="form-section">
<label>Ù…Ø¯ÙŠÙ†Ø© Ø§Ù„ÙˆØµÙˆÙ„</label>
<input id="cityIn">

<label>Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª Ø§Ù„Ø§Ù†Ø·Ù„Ø§Ù‚</label>
<input id="startCoord" value="33.2722,-8.3732">

<button onclick="pickCity()">Ø¨Ø¯Ø¡ Ø§Ù„Ø·ÙŠØ±Ø§Ù† ğŸ•Šï¸</button>
</div>

</div>
</div>

<script>
let map,startMarker,pigeon,route,dest;
let mapReady=false;

let windSpeed=0; // m/s
let windDeg=0;   // degrees

const pigeonBaseSpeed = 70/3.6; // m/s

function showTab(id,btn){
document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
document.getElementById(id).classList.add('active');
btn.classList.add('active');
setTimeout(initMap,100);
}

function initMap(){
if(mapReady) return;

map=L.map('map',{zoomControl:false})
.setView([33.2722,-8.3732],7);

L.tileLayer(
'https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png'
).addTo(map);

startMarker=L.marker([33.2722,-8.3732]).addTo(map);
mapReady=true;
initWeather();
}

async function initWeather(){
const c=startCoord.value.split(',');
const r=await fetch(
`https://api.openweathermap.org/data/2.5/weather?lat=${c[0]}&lon=${c[1]}&units=metric&appid=992e2b79f5e3386bda09d14ff4807f9d`
);
const d=await r.json();

windSpeed=d.wind.speed;
windDeg=d.wind.deg;

ws.innerText=(windSpeed*3.6).toFixed(1)+' km/h';
wt.innerText=d.main.temp+' Â°C';

const dirs=['Ø´Ù…Ø§Ù„','Ø´Ù…Ø§Ù„ Ø´Ø±Ù‚ÙŠ','Ø´Ø±Ù‚','Ø¬Ù†ÙˆØ¨ Ø´Ø±Ù‚ÙŠ','Ø¬Ù†ÙˆØ¨','Ø¬Ù†ÙˆØ¨ ØºØ±Ø¨ÙŠ','ØºØ±Ø¨','Ø´Ù…Ø§Ù„ ØºØ±Ø¨ÙŠ'];
wd.innerText=dirs[Math.round(windDeg/45)%8];
}

function degToRad(d){return d*Math.PI/180}

function bearing(lat1,lon1,lat2,lon2){
const y=Math.sin(degToRad(lon2-lon1))*Math.cos(degToRad(lat2));
const x=Math.cos(degToRad(lat1))*Math.sin(degToRad(lat2))-
Math.sin(degToRad(lat1))*Math.cos(degToRad(lat2))*Math.cos(degToRad(lon2-lon1));
return (Math.atan2(y,x)*180/Math.PI+360)%360;
}

function pickCity(){
dest=[34.0209,-6.8416]; // Ù…Ø«Ø§Ù„ Ø§Ù„Ø±Ø¨Ø§Ø·
if(route) map.removeLayer(route);

route=L.polyline(
[startMarker.getLatLng(),dest],
{color:'#00d4ff',dashArray:'5,10'}
).addTo(map);

map.fitBounds(route.getBounds(),{padding:[40,40]});
startPigeonSim();
}

function startPigeonSim(){
if(!dest) return;

if(pigeon) map.removeLayer(pigeon);

pigeon=L.marker(startMarker.getLatLng(),{
icon:L.divIcon({html:'ğŸ•Šï¸',iconSize:[30,30]})
}).addTo(map);

const start=startMarker.getLatLng();
const end=L.latLng(dest[0],dest[1]);

const totalDist=map.distance(start,end);
const dir=bearing(start.lat,start.lng,end.lat,end.lng);

let traveled=0;
let last=performance.now();

function animate(now){
const dt=(now-last)/1000;
last=now;

const relWind=degToRad(windDeg-dir);
const windForward=Math.cos(relWind)*windSpeed;
const windSide=Math.sin(relWind)*windSpeed;

const groundSpeed=Math.max(5,pigeonBaseSpeed+windForward);

ps.innerText=(groundSpeed*3.6).toFixed(1)+' km/h';

traveled+=groundSpeed*dt;
let p=traveled/totalDist;

if(p>=1){
pigeon.setLatLng(end);
ps.innerText='ÙˆØµÙˆÙ„ âœ”ï¸';
return;
}

const drift=windSide*p*0.00005;

pigeon.setLatLng([
start.lat+(end.lat-start.lat)*p+drift,
start.lng+(end.lng-start.lng)*p
]);

requestAnimationFrame(animate);
}
requestAnimationFrame(animate);
}

window.onload=initMap;
</script>

</body>
</html>

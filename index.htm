<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>ELMAKKAOUY FLIGHT AI - Professional Simulator</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <style>
        :root { --primary: #00d4ff; --bg: #0f172a; --card: #1e293b; --text: #f8fafc; --accent: #22c55e; }
        body { margin: 0; background: var(--bg); color: var(--text); font-family: 'Segoe UI', sans-serif; }
        #map { height: 400px; width: 100%; border-bottom: 3px solid var(--primary); }
        .container { padding: 15px; max-width: 1200px; margin: auto; }
        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 15px; }
        .panel { background: var(--card); padding: 15px; border-radius: 12px; border: 1px solid #334155; }
        input, button { width: 100%; padding: 10px; margin-top: 8px; border-radius: 6px; border: 1px solid #334155; background: #0f172a; color: white; box-sizing: border-box; }
        button { background: var(--primary); color: #000; font-weight: bold; cursor: pointer; border: none; }
        .stats-bar { display: grid; grid-template-columns: repeat(4, 1fr); background: var(--card); padding: 15px; border-radius: 12px; margin: -25px auto 15px; width: 95%; position: relative; z-index: 1000; border: 1px solid var(--primary); text-align: center; }
        .stat-item b { display: block; color: var(--primary); font-size: 1.1em; }
        .search-box { position: relative; }
        .sug-box { position: absolute; z-index: 2000; width: 100%; background: var(--card); border: 1px solid var(--primary); display: none; max-height: 150px; overflow-y: auto; }
        .sug-item { padding: 8px; cursor: pointer; border-bottom: 1px solid #444; font-size: 0.85em; }
        .sug-item:hover { background: var(--primary); color: #000; }
        .env-badge { display: inline-block; padding: 2px 8px; border-radius: 4px; font-size: 0.8em; margin-top: 5px; background: #334155; }
    </style>
</head>
<body>

<div id="map"></div>

<div class="stats-bar">
    <div class="stat-item">ğŸ“ Ø§Ù„Ù…Ø³Ø§ÙØ©<b id="st-dist">0 Km</b></div>
    <div class="stat-item">ğŸŒ¬ï¸ Ø§Ù„Ø±ÙŠØ§Ø­<b id="st-wind">0 m/m</b></div>
    <div class="stat-item">ğŸ’§ Ø§Ù„Ø±Ø·ÙˆØ¨Ø©<b id="st-hum">0%</b></div>
    <div class="stat-item">ğŸš€ Ø§Ù„Ø³Ø±Ø¹Ø© Ø§Ù„Ø£Ø±Ø¶ÙŠØ©<b id="st-gspeed">0 m/m</b></div>
</div>

<div class="container">
    <div class="grid">
        <div class="panel">
            <h3>ğŸ“ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¥Ø·Ù„Ø§Ù‚ Ø§Ù„Ø°ÙƒÙŠ</h3>
            <div class="search-box">
                <input id="startInput" placeholder="Ù†Ù‚Ø·Ø© Ø§Ù„Ø¥Ø·Ù„Ø§Ù‚ (Ø¨Ø­Ø« Ø£Ùˆ Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª: lat, lon)" oninput="handleLocationInput(this.value, 'start')">
                <div id="sugStart" class="sug-box"></div>
            </div>
            <div class="search-box">
                <input id="endInput" placeholder="Ù†Ù‚Ø·Ø© Ø§Ù„ÙˆØµÙˆÙ„ (Ø¨Ø­Ø« Ø£Ùˆ Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª: lat, lon)" oninput="handleLocationInput(this.value, 'end')">
                <div id="sugEnd" class="sug-box"></div>
            </div>
            <label style="display:block; margin-top:10px;">ÙˆÙ‚Øª Ø§Ù„Ø¥Ø·Ù„Ø§Ù‚:</label>
            <input type="datetime-local" id="startTime">
            <button onclick="syncSimulation()">ØªÙØ¹ÙŠÙ„ Ø§Ù„Ù…Ø­Ø§ÙƒØ§Ø© Ø§Ù„ÙÙŠØ²ÙŠØ§Ø¦ÙŠØ© âš¡</button>
        </div>

        <div class="panel">
            <h3>ğŸ† ØªØ³Ø¬ÙŠÙ„ Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø³Ø¨Ø§Ù‚</h3>
            <input id="rName" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…ØªØ³Ø§Ø¨Ù‚">
            <input id="rDist" type="number" placeholder="Ø§Ù„Ù…Ø³Ø§ÙØ© Ø§Ù„ÙØ¹Ù„ÙŠØ© (Km)">
            <input id="rTime" type="time">
            <button onclick="processRacer()" style="background:var(--accent); color:white">Ø­Ø³Ø§Ø¨ Ø§Ù„Ø³Ø±Ø¹Ø© Ø§Ù„Ø±Ø³Ù…ÙŠØ©</button>
            <div id="env-info" class="env-badge">Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¬ÙˆÙŠØ©...</div>
        </div>
    </div>

    <div class="panel" style="margin-top:15px">
        <table style="width:100%; border-collapse: collapse;">
            <thead>
                <tr style="border-bottom: 2px solid var(--primary)">
                    <th>Ø§Ù„Ù…Ø±ÙƒØ²</th><th>Ø§Ù„Ù…ØªØ³Ø§Ø¨Ù‚</th><th>Ø§Ù„Ù…Ø³Ø§ÙØ©</th><th>Ø§Ù„Ø³Ø±Ø¹Ø© (Ù…/Ø¯)</th><th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
                </tr>
            </thead>
            <tbody id="leaderboard"></tbody>
        </table>
    </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
let map = L.map('map').setView([33.5, -7.5], 6);
L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png').addTo(map);

let pigeon, pathLine, startPt, endPt, racers = [];
let weather = { windSpd: 0, windDeg: 0, humidity: 50 };

// Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ù…Ø¯Ø®Ù„Ø§Øª (Ø¨Ø­Øª Ø£Ùˆ Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª)
async function handleLocationInput(val, type) {
    const box = type === 'start' ? document.getElementById('sugStart') : document.getElementById('sugEnd');
    
    // Ø§Ù„ØªØ­Ù‚Ù‚ Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙŠØ¯Ø®Ù„ Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª ÙŠØ¯ÙˆÙŠØ§Ù‹ (lat, lon)
    const coordRegex = /^(-?\ d+(\.\d+)?),\s*(-?\d+(\.\d+)?)$/;
    if(coordRegex.test(val)) {
        const [lat, lon] = val.split(',').map(Number);
        updatePoint(lat, lon, "Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª ÙŠØ¯ÙˆÙŠØ©", type);
        box.style.display = 'none';
        return;
    }

    if(val.length < 3) { box.style.display = 'none'; return; }
    const r = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${val}&limit=5`);
    const d = await r.json();
    box.style.display = 'block';
    box.innerHTML = d.map(x => `<div class="sug-item" onclick="updatePoint(${x.lat}, ${x.lon}, '${x.display_name}', '${type}')">${x.display_name}</div>`).join('');
}

function updatePoint(lat, lon, name, type) {
    if(type === 'start') {
        startPt = {lat, lng: lon};
        document.getElementById('startInput').value = name.split(',')[0];
        document.getElementById('sugStart').style.display = 'none';
    } else {
        endPt = {lat, lng: lon};
        document.getElementById('endInput').value = name.split(',')[0];
        document.getElementById('sugEnd').style.display = 'none';
    }
    fetchWeather(lat, lon);
    save();
}

async function fetchWeather(lat, lon) {
    try {
        const r = await fetch(`https://api.openweathermap.org/data/2.5/weather?lat=${lat}&lon=${lon}&appid=992e2b79f5e3386bda09d14ff4807f9d`);
        const d = await r.json();
        weather = {
            windSpd: (d.wind.speed || 0) * 60, // ØªØ­ÙˆÙŠÙ„ Ù„Ù…ØªØ±/Ø¯Ù‚ÙŠÙ‚Ø©
            windDeg: d.wind.deg || 0,
            humidity: d.main.humidity || 50
        };
        document.getElementById('st-wind').innerText = weather.windSpd.toFixed(0) + " m/m";
        document.getElementById('st-hum').innerText = weather.humidity + "%";
        document.getElementById('env-info').innerText = `Ø§Ù„Ø¬Ùˆ: ${weather.humidity > 70 ? 'Ø±Ø·Ø¨ (Ø«Ù‚ÙŠÙ„)' : 'Ø¬Ø§Ù (Ù…Ø«Ø§Ù„ÙŠ)'}`;
    } catch(e) { console.log("Weather error"); }
}

function calcGroundSpeed(baseSpeed, wSpd, wDeg, targetDeg) {
    // Ù…Ø«Ù„Ø« Ø§Ù„Ø±ÙŠØ§Ø­ Ø§Ù„Ù…Ø¨Ø³Ø·
    const angleRad = (wDeg - targetDeg) * Math.PI / 180;
    const tailwindComponent = Math.cos(angleRad) * wSpd;
    const crosswindComponent = Math.sin(angleRad) * wSpd;
    
    // ØªØ£Ø«ÙŠØ± Ø§Ù„Ø±Ø·ÙˆØ¨Ø©: Ø§Ù„Ø±Ø·ÙˆØ¨Ø© Ø§Ù„Ø¹Ø§Ù„ÙŠØ© ØªØ²ÙŠØ¯ Ù…Ù‚Ø§ÙˆÙ…Ø© Ø§Ù„Ù‡ÙˆØ§Ø¡ Ù‚Ù„ÙŠÙ„Ø§Ù‹ (Ù…Ø­Ø§ÙƒØ§Ø©)
    const humFactor = 1 - (weather.humidity / 1000); 
    
    return (baseSpeed * humFactor) + tailwindComponent;
}

function syncSimulation() {
    if(!startPt || !endPt || !document.getElementById('startTime').value) return;

    const R = 6371000;
    const dLat = (endPt.lat - startPt.lat) * Math.PI / 180;
    const dLon = (endPt.lng - startPt.lng) * Math.PI / 180;
    const dist = 2 * R * Math.asin(Math.sqrt(Math.sin(dLat/2)**2 + Math.cos(startPt.lat*Math.PI/180)*Math.cos(endPt.lat*Math.PI/180)*Math.sin(dLon/2)**2));
    
    document.getElementById('st-dist').innerText = (dist/1000).toFixed(2) + " Km";

    if(pathLine) map.removeLayer(pathLine);
    pathLine = L.polyline([startPt, endPt], {color: 'cyan', weight: 1, dashArray: '5,5'}).addTo(map);
    
    if(!pigeon) pigeon = L.marker(startPt, {icon: L.divIcon({html: 'ğŸ•Šï¸', className: 'bird-icon'})}).addTo(map);
    map.fitBounds(pathLine.getBounds());

    function animate() {
        const elapsed = (new Date() - new Date(document.getElementById('startTime').value)) / 60000;
        if(elapsed < 0) return requestAnimationFrame(animate);

        const targetDeg = Math.atan2(endPt.lat - startPt.lat, endPt.lng - startPt.lng) * 180 / Math.PI;
        const gSpeed = calcGroundSpeed(1200, weather.windSpd, weather.windDeg, targetDeg);
        document.getElementById('st-gspeed').innerText = gSpeed.toFixed(0) + " m/m";

        let progress = (elapsed * gSpeed) / dist;
        if(progress > 1) progress = 1;

        // Ø§Ù„Ø¬ØºØ±Ø§ÙÙŠØ§: Ø§Ù†Ø­Ø±Ø§Ù Ø§Ù„Ù…Ø³Ø§Ø± Ù„ØªØ¬Ù†Ø¨ "Ø§Ù„ÙØ±Ø§Øº" (Ù…Ø­Ø§ÙƒØ§Ø© Ø§Ù„ØªØ¶Ø§Ø±ÙŠØ³)
        const terrainEffect = Math.sin(progress * Math.PI) * 0.02;
        pigeon.setLatLng([
            startPt.lat + (endPt.lat - startPt.lat) * progress + terrainEffect,
            startPt.lng + (endPt.lng - startPt.lng) * progress
        ]);

        if(progress < 1) requestAnimationFrame(animate);
    }
    animate();
}

function processRacer() {
    const name = document.getElementById('rName').value;
    const d = document.getElementById('rDist').value;
    const time = document.getElementById('rTime').value;
    const start = document.getElementById('startTime').value;
    
    if(!name || !d || !time || !start) return alert("Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù†Ø§Ù‚ØµØ©");

    const t1 = new Date(start);
    const t2 = new Date(start.split('T')[0] + 'T' + time);
    if(t2 < t1) t2.setDate(t2.getDate() + 1);

    const speed = (d * 1000) / ((t2 - t1) / 60000);
    racers.push({name, d, speed});
    racers.sort((a,b) => b.speed - a.speed);
    
    document.getElementById('leaderboard').innerHTML = racers.map((r, i) => `
        <tr><td>${i+1}</td><td>${r.name}</td><td>${r.d} Km</td><td>${r.speed.toFixed(2)}</td><td>âœ…</td></tr>
    `).join('');
    save();
}

function save() {
    localStorage.setItem('flightSimData', JSON.stringify({
        startPt, endPt, racers, 
        stName: document.getElementById('startInput').value,
        edName: document.getElementById('endInput').value,
        sTime: document.getElementById('startTime').value
    }));
}

window.onload = () => {
    const saved = JSON.parse(localStorage.getItem('flightSimData') || '{}');
    if(saved.startPt) {
        startPt = saved.startPt; endPt = saved.endPt; racers = saved.racers || [];
        document.getElementById('startInput').value = saved.stName;
        document.getElementById('endInput').value = saved.edName;
        document.getElementById('startTime').value = saved.sTime;
        processRacer(); // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¬Ø¯ÙˆÙ„
        syncSimulation();
    }
};
</script>
</body>
</html>

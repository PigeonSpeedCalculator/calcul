<!DOCTYPE html>
<html lang="ar">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ELMAKKAOUY RADAR PRO</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <style>
        :root { --primary: #00d4ff; --bg: #0b0f19; --card: #161b2a; --accent: #00ff88; }
        body { margin: 0; background: var(--bg); color: white; font-family: 'Segoe UI', sans-serif; height: 100vh; display: flex; flex-direction: column; }
        
        /* Navigation Fixed */
        nav { display: flex; background: #1a1f2e; border-bottom: 2px solid var(--primary); z-index: 1000; }
        .nav-btn { flex: 1; padding: 15px; border: none; background: none; color: #8892b0; font-weight: bold; cursor: pointer; font-size: 1rem; }
        .nav-btn.active { color: var(--primary); background: rgba(0, 212, 255, 0.1); border-bottom: 4px solid var(--primary); }

        .container { flex: 1; position: relative; overflow: hidden; }
        .page { display: none; height: 100%; overflow-y: auto; padding: 20px; box-sizing: border-box; }
        .page.active { display: block; }

        /* Map UI */
        #map { height: 400px; width: 100%; border-radius: 15px; border: 1px solid #2d3343; }
        .stats-bar { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin: 15px 0; }
        .stat-card { background: var(--card); padding: 10px; border-radius: 8px; text-align: center; border: 1px solid #2d3343; }
        .stat-card small { display: block; color: #8892b0; font-size: 10px; }
        .stat-card b { color: var(--primary); }

        /* Forms */
        .form-section { background: var(--card); padding: 20px; border-radius: 15px; border: 1px solid #2d3343; margin-bottom: 20px; }
        label { display: block; color: var(--primary); font-size: 12px; margin-bottom: 8px; font-weight: bold; }
        input { width: 100%; padding: 12px; margin-bottom: 15px; border-radius: 8px; border: 1px solid #2d3343; background: #0b0f19; color: white; box-sizing: border-box; }
        
        .action-btn { background: var(--primary); color: #000; border: none; padding: 15px; border-radius: 10px; width: 100%; font-weight: 800; cursor: pointer; text-transform: uppercase; }
        .btn-green { background: var(--accent); }

        /* Suggestions */
        .search-results { background: #1a1f2e; border-radius: 8px; position: absolute; width: 90%; z-index: 2000; max-height: 200px; overflow-y: auto; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        .search-item { padding: 12px; cursor: pointer; border-bottom: 1px solid #2d3343; font-size: 14px; }
        .search-item:hover { background: var(--primary); color: #000; }

        /* Results Table */
        #resultCapture { background: white; color: black; border-radius: 15px; overflow: hidden; display: none; margin-top: 20px; }
        table { width: 100%; border-collapse: collapse; }
        th { background: #0b0f19; color: white; padding: 15px; }
        td { padding: 12px; border-bottom: 1px solid #eee; text-align: center; font-weight: bold; }
    </style>
</head>
<body>

    <nav>
        <button class="nav-btn active" onclick="showTab('radar-tab')">ğŸ“¡ Ø§Ù„Ø±Ø§Ø¯Ø§Ø± ÙˆØ§Ù„ØªØªØ¨Ø¹</button>
        <button class="nav-btn" onclick="showTab('calc-tab')">â±ï¸ Ø­Ø³Ø§Ø¨ Ø§Ù„Ø³Ø±Ø¹Ø©</button>
    </nav>

    <div class="container">
        <div id="radar-tab" class="page active">
            <div id="map"></div>
            
            <div class="stats-bar">
                <div class="stat-card"><small>Ø§Ù„Ø±ÙŠØ§Ø­</small><b id="ws">--</b></div>
                <div class="stat-card"><small>Ø§Ù„Ø§ØªØ¬Ø§Ù‡</small><b id="wd">--</b></div>
                <div class="stat-card"><small>Ø§Ù„Ø­Ø±Ø§Ø±Ø©</small><b id="wt">--</b></div>
            </div>

            <div class="form-section">
                <div style="position:relative;">
                    <label>ğŸ Ù…Ø¯ÙŠÙ†Ø© Ø§Ù„ÙˆØµÙˆÙ„ (Ø¥Ø¯Ø®Ø§Ù„ Ø°ÙƒÙŠ)</label>
                    <input type="text" id="cityIn" placeholder="Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©..." oninput="searchCity(this.value)">
                    <div id="results" class="search-results"></div>
                </div>

                <label>ğŸ“ Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª Ø§Ù„Ø§Ù†Ø·Ù„Ø§Ù‚</label>
                <input type="text" id="startCoord" value="33.2722, -8.3732" onchange="initWeather()">

                <label>â° ÙˆÙ‚Øª Ø§Ù„Ø§Ù†Ø·Ù„Ø§Ù‚ Ø§Ù„Ø±Ø³Ù…ÙŠ</label>
                <input type="datetime-local" id="startTimeOfficial">

                <button class="action-btn" onclick="startPigeonSim()">Ø¥Ø·Ù„Ø§Ù‚ Ø§Ù„Ù…Ø­Ø§ÙƒØ§Ø© ğŸ•Šï¸</button>
            </div>
        </div>

        <div id="calc-tab" class="page">
            <div class="form-section">
                <h3 style="margin-top:0">Ø¥Ø¶Ø§ÙØ© Ù…ØªØ³Ø§Ø¨Ù‚ÙŠÙ†</h3>
                <label>Ø§Ø³Ù… Ø§Ù„Ù…ØªØ³Ø§Ø¨Ù‚</label>
                <input type="text" id="racerName" placeholder="Ù…Ø«Ø§Ù„: Ø§Ù„Ø¨Ø·Ù„ Ø§Ù„Ù…ÙƒØ§ÙˆÙŠ">
                
                <label>Ø§Ù„Ù…Ø³Ø§ÙØ© (Km)</label>
                <input type="number" id="racerDist" placeholder="0.000">
                
                <label>ØªÙˆÙ‚ÙŠØª Ø§Ù„ÙˆØµÙˆÙ„ (Ø³Ø§Ø¹Ø© : Ø¯Ù‚ÙŠÙ‚Ø© : Ø«Ø§Ù†ÙŠØ©)</label>
                <div style="display:flex; gap:10px;">
                    <input type="number" id="h" placeholder="HH" value="12">
                    <input type="number" id="m" placeholder="MM" value="00">
                    <input type="number" id="s" placeholder="SS" value="00">
                </div>
                
                <button class="action-btn btn-green" onclick="addToList()">Ø£Ø¶Ù Ù„Ù„Ù‚Ø§Ø¦Ù…Ø© +</button>
            </div>

            <div id="racersList" style="margin-bottom:20px;"></div>

            <button class="action-btn" style="background:#fff; color:#000;" onclick="calculateSpeed()">ğŸ† Ø¹Ø±Ø¶ Ø§Ù„ØªØ±ØªÙŠØ¨ ÙˆØ§Ù„Ù†ØªØ§Ø¦Ø¬</button>

            <div id="resultCapture">
                <div style="background:#0b0f19; color:var(--primary); padding:20px; text-align:center;">
                    <h2 style="margin:0;">ELMAKKAOUY RADAR PRO</h2>
                    <span id="raceMeta" style="font-size:12px;"></span>
                </div>
                <table id="resTable">
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>Ø§Ù„Ø§Ø³Ù…</th>
                            <th>Ø§Ù„Ù…Ø³Ø§ÙØ©</th>
                            <th>Ø§Ù„ÙˆØµÙˆÙ„</th>
                            <th>Ø§Ù„Ø³Ø±Ø¹Ø© (Ù…/Ø¯)</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
            <button class="action-btn" id="dlBtn" style="display:none; margin-top:10px; background:#475569;" onclick="saveAsImage()">ğŸ“¸ Ø­ÙØ¸ Ø§Ù„Ù†ØªÙŠØ¬Ø© ÙƒØµÙˆØ±Ø©</button>
        </div>
    </div>

<script>
    let map, startMarker, pigeon, route, racersData = [], dest = null;

    // Ø¥ØµÙ„Ø§Ø­ Ù…Ø´ÙƒÙ„Ø© Ø§Ù„ØªÙ†Ù‚Ù„ ÙˆØ§Ù„Ø®Ø±ÙŠØ·Ø©
    function showTab(tabId) {
        document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
        document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
        
        document.getElementById(tabId).classList.add('active');
        event.currentTarget.classList.add('active');

        if(tabId === 'radar-tab' && map) {
            setTimeout(() => { map.invalidateSize(); }, 200);
        }
    }

    // ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ø®Ø±ÙŠØ·Ø©
    window.onload = () => {
        map = L.map('map', { zoomControl: false }).setView([33.2722, -8.3732], 7);
        L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png').addTo(map);
        startMarker = L.marker([33.2722, -8.3732]).addTo(map);
        
        // ÙˆÙ‚Øª Ø§ÙØªØ±Ø§Ø¶ÙŠ
        let d = new Date();
        d.setMinutes(d.getMinutes() - d.getTimezoneOffset());
        document.getElementById('startTimeOfficial').value = d.toISOString().slice(0,16);
        
        initWeather();
    };

    // Ø·Ù‚Ø³ Ø­Ù‚ÙŠÙ‚ÙŠ
    async function initWeather() {
        const c = document.getElementById('startCoord').value.split(',');
        const res = await fetch(`https://api.openweathermap.org/data/2.5/weather?lat=${c[0]}&lon=${c[1]}&appid=992e2b79f5e3386bda09d14ff4807f9d&units=metric`);
        const data = await res.json();
        document.getElementById('ws').innerText = (data.wind.speed * 3.6).toFixed(1) + " km/h";
        document.getElementById('wt').innerText = data.main.temp + " Â°C";
        const dirs = ['Ø´Ù…Ø§Ù„','Ø´Ù…Ø§Ù„ Ø´Ø±Ù‚ÙŠ','Ø´Ø±Ù‚','Ø¬Ù†ÙˆØ¨ Ø´Ø±Ù‚ÙŠ','Ø¬Ù†ÙˆØ¨','Ø¬Ù†ÙˆØ¨ ØºØ±Ø¨ÙŠ','ØºØ±Ø¨','Ø´Ù…Ø§Ù„ ØºØ±Ø¨ÙŠ'];
        document.getElementById('wd').innerText = dirs[Math.round(data.wind.deg/45)%8];
    }

    // Ø¨Ø­Ø« Ø°ÙƒÙŠ Ø¹Ù† Ø§Ù„Ù…Ø¯Ù†
    async function searchCity(q) {
        if(q.length < 3) return;
        const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${q}&limit=5`);
        const data = await res.json();
        const results = document.getElementById('results');
        results.innerHTML = data.map(d => `<div class="search-item" onclick="pickCity(${d.lat}, ${d.lon}, '${d.display_name}')">${d.display_name.split(',')[0]}</div>`).join('');
    }

    function pickCity(lat, lon, name) {
        dest = [lat, lon];
        document.getElementById('cityIn').value = name.split(',')[0];
        document.getElementById('results').innerHTML = '';
        
        const dist = (map.distance(startMarker.getLatLng(), dest)/1000).toFixed(3);
        document.getElementById('racerDist').value = dist; // Ù†Ù‚Ù„ Ø§Ù„Ù…Ø³Ø§ÙØ© ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹

        if(route) map.removeLayer(route);
        route = L.polyline([startMarker.getLatLng(), dest], {color: var(--primary), weight: 2, dashArray: '5, 10'}).addTo(map);
        map.fitBounds(route.getBounds(), {padding:[50,50]});
    }

    // Ù…Ø­Ø§ÙƒØ§Ø© Ø§Ù„Ø­Ù…Ø§Ù…Ø©
    function startPigeonSim() {
        if(!dest) return alert("Ø§Ø®ØªØ± Ù…Ø¯ÙŠÙ†Ø© Ø§Ù„ÙˆØµÙˆÙ„");
        if(pigeon) map.removeLayer(pigeon);
        pigeon = L.marker(startMarker.getLatLng(), { icon: L.divIcon({ html: 'ğŸ•Šï¸', className: '', iconSize:[25,25] }) }).addTo(map);
        
        let p = 0;
        const start = startMarker.getLatLng();
        const move = setInterval(() => {
            p += 0.01;
            if(p >= 1) { clearInterval(move); return; }
            pigeon.setLatLng([start.lat + (dest[0] - start.lat)*p, start.lng + (dest[1] - start.lng)*p]);
        }, 50);
    }

    // Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª
    function addToList() {
        const name = document.getElementById('racerName').value;
        const dist = document.getElementById('racerDist').value;
        if(!name || !dist) return alert("Ø§ÙƒÙ…Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª");
        
        racersData.push({
            name, dist, 
            h: document.getElementById('h').value,
            m: document.getElementById('m').value,
            s: document.getElementById('s').value
        });
        
        document.getElementById('racersList').innerHTML = racersData.map(r => `
            <div style="background:var(--card); padding:10px; border-radius:8px; margin-bottom:5px; border-left:4px solid var(--primary)">
                ${r.name} - ${r.dist} Km - (${r.h}:${r.m}:${r.s})
            </div>
        `).join('');
        document.getElementById('racerName').value = '';
    }

    function calculateSpeed() {
        const startVal = new Date(document.getElementById('startTimeOfficial').value);
        let final = racersData.map(r => {
            let arrival = new Date(startVal);
            arrival.setHours(r.h, r.m, r.s);
            let diff = (arrival - startVal) / 60000;
            let speed = (parseFloat(r.dist) * 1000) / diff;
            return { ...r, speed };
        }).sort((a,b) => b.speed - a.speed);

        const tbody = document.querySelector('#resTable tbody');
        tbody.innerHTML = final.map((r, i) => `
            <tr>
                <td>${i+1}</td>
                <td style="text-align:right">${r.name}</td>
                <td>${r.dist}</td>
                <td>${r.h}:${r.m}:${r.s}</td>
                <td style="color:#10b981">${r.speed.toFixed(3)}</td>
            </tr>
        `).join('');
        document.getElementById('resultCapture').style.display = 'block';
        document.getElementById('dlBtn').style.display = 'block';
    }

    function saveAsImage() {
        html2canvas(document.getElementById('resultCapture')).then(canvas => {
            const a = document.createElement('a');
            a.download = 'ELMAKKAOUY_RESULTS.png';
            a.href = canvas.toDataURL();
            a.click();
        });
    }
</script>
</body>
</html>

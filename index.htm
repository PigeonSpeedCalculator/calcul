<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>ELMAKKAOUY FLIGHT AI - Live Tracking</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <style>
        :root { --primary: #00d4ff; --bg: #0f172a; --card: #1e293b; --text: #f8fafc; --accent: #fbbf24; }
        body { margin: 0; background: var(--bg); color: var(--text); font-family: 'Segoe UI', sans-serif; }
        #map { height: 450px; width: 100%; border-bottom: 3px solid var(--primary); }
        .stats-bar { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); background: var(--card); padding: 15px; border-radius: 12px; margin: -30px auto 20px; position: relative; z-index: 1000; width: 92%; border: 1px solid var(--primary); text-align: center; box-shadow: 0 8px 32px rgba(0,0,0,0.6); }
        .stat-item b { display: block; color: var(--primary); font-size: 1.2em; margin-top: 4px; }
        .panel { background: var(--card); padding: 20px; border-radius: 15px; border: 1px solid #334155; margin-bottom: 20px; }
        input, button { width: 100%; padding: 12px; margin-top: 10px; border-radius: 8px; border: 1px solid #334155; background: #0f172a; color: white; box-sizing: border-box; }
        button { background: var(--primary); color: #000; font-weight: bold; cursor: pointer; border: none; transition: 0.2s; }
        button:hover { filter: brightness(1.2); }
        #bird-icon { font-size: 32px; filter: drop-shadow(0 0 8px var(--primary)); display: inline-block; }
        .eta-highlight { color: var(--accent) !important; font-weight: 800; }
        .sug-box { position: absolute; z-index: 2000; width: 100%; background: var(--card); border: 1px solid var(--primary); display: none; }
    </style>
</head>
<body>

<div id="map"></div>

<div class="stats-bar">
    <div class="stat-item">ğŸŒ¬ï¸ Ø§Ù„Ø±ÙŠØ§Ø­<b id="st-wind">0 km/h</b></div>
    <div class="stat-item">ğŸ•Šï¸ Ø³Ø±Ø¹Ø© Ø§Ù„Ø­Ù…Ø§Ù…Ø©<b id="st-airspeed">1166.67 m/min</b></div>
    <div class="stat-item">ğŸŒ Ø³Ø±Ø¹Ø© Ø§Ù„Ø£Ø±Ø¶<b id="st-groundspeed">0 m/min</b></div>
    <div class="stat-item">ğŸ“ Ù…ØªØ¨Ù‚ÙŠ<b id="st-rem-dist">0.00 Km</b></div>
    <div class="stat-item">ğŸ•’ Ø¯Ø®ÙˆÙ„ Ù…Ø­ØªÙ…Ù„<b id="st-eta" class="eta-highlight">--:--:--</b></div>
</div>

<div class="container" style="padding: 20px; max-width: 1200px; margin: auto;">
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 20px;">
        <div class="panel">
            <h3>ğŸ“ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø±Ø­Ù„Ø© Ø§Ù„Ø­ÙŠØ©</h3>
            <input id="startCoords" placeholder="Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª Ø§Ù„Ø¥Ø·Ù„Ø§Ù‚ (Ù…Ø«Ù„Ø§Ù‹: 33.57, -7.58)">
            <div style="position:relative">
                <input id="endInput" placeholder="Ù…Ø¯ÙŠÙ†Ø© Ø§Ù„ÙˆØµÙˆÙ„..." oninput="searchLoc(this.value)">
                <div id="sugEnd" class="sug-box"></div>
            </div>
            <label>ÙˆÙ‚Øª Ø§Ù„Ø¥Ø·Ù„Ø§Ù‚ Ø§Ù„ÙØ¹Ù„ÙŠ (Ø¨Ø§Ù„Ø«ÙˆØ§Ù†ÙŠ):</label>
            <input type="datetime-local" id="startTime" step="1">
            <button onclick="initFlight()">Ø¨Ø¯Ø¡ Ø§Ù„Ù…Ø­Ø§ÙƒØ§Ø© Ø§Ù„ÙÙŠØ²ÙŠØ§Ø¦ÙŠØ© âš¡</button>
        </div>

        <div class="panel">
            <h3>ğŸ“Š ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø±Ø³Ù…ÙŠØ©</h3>
            <input id="rName" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…ØªØ³Ø§Ø¨Ù‚">
            <input id="rDist" type="number" placeholder="Ø§Ù„Ù…Ø³Ø§ÙØ© (Km)" step="0.001">
            <label>ØªÙˆÙ‚ÙŠØª Ø§Ù„Ø¯Ø®ÙˆÙ„:</label>
            <input id="rTime" type="time" step="1">
            <button onclick="recordRacer()" style="background:#22c55e; color:white">ØªØ³Ø¬ÙŠÙ„</button>
        </div>
    </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
let map = L.map('map').setView([33.5, -7.5], 7);
L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png').addTo(map);

let pigeon, livePath, historyCoords = [], startPt, endPt;
let weather = { windKm: 0, deg: 0 };
const AIR_SPEED_KMH = 70; // Ø§Ù„Ø³Ø±Ø¹Ø© Ø§Ù„Ø·Ø¨ÙŠØ¹ÙŠØ© Ù„Ù„Ø­Ù…Ø§Ù…Ø©

async function searchLoc(q) {
    if(q.length < 3) return;
    const r = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${q}&limit=5`);
    const d = await r.json();
    const box = document.getElementById('sugEnd');
    box.style.display = 'block';
    box.innerHTML = d.map(x => `<div style="padding:10px; cursor:pointer; border-bottom:1px solid #444" onclick="selectEnd(${x.lat}, ${x.lon}, '${x.display_name}')">${x.display_name}</div>`).join('');
}

function selectEnd(lat, lon, name) {
    endPt = {lat, lng: lon};
    document.getElementById('endInput').value = name.split(',')[0];
    document.getElementById('sugEnd').style.display = 'none';
    getWeather(lat, lon);
}

async function getWeather(lat, lon) {
    try {
        const r = await fetch(`https://api.openweathermap.org/data/2.5/weather?lat=${lat}&lon=${lon}&appid=992e2b79f5e3386bda09d14ff4807f9d`);
        const d = await r.json();
        weather = { windKm: (d.wind.speed * 3.6), deg: d.wind.deg };
        document.getElementById('st-wind').innerText = weather.windKm.toFixed(1) + " km/h";
    } catch(e) { console.error("Weather failed"); }
}

function initFlight() {
    const coords = document.getElementById('startCoords').value.split(',');
    if(coords.length < 2 || !endPt) return alert("ÙŠØ±Ø¬Ù‰ Ù…Ù„Ø¡ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª");
    startPt = {lat: parseFloat(coords[0]), lng: parseFloat(coords[1])};

    historyCoords = [startPt];
    if(livePath) map.removeLayer(livePath);
    livePath = L.polyline(historyCoords, {color: '#00d4ff', weight: 3, opacity: 0.7}).addTo(map);

    if(pigeon) map.removeLayer(pigeon);
    pigeon = L.marker(startPt, {
        icon: L.divIcon({ html: `<div id="bird-icon">ğŸ•Šï¸</div>`, className: '' })
    }).addTo(map);

    map.fitBounds([startPt, endPt], {padding: [50, 50]});
    requestAnimationFrame(updateFrame);
}

function updateFrame() {
    const startTime = new Date(document.getElementById('startTime').value);
    const now = new Date();
    const elapsedHours = (now - startTime) / 3600000;

    if(elapsedHours < 0) { requestAnimationFrame(updateFrame); return; }

    // 1. Ø­Ø³Ø§Ø¨ Ø§Ù„Ø²Ø§ÙˆÙŠØ© Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø© (Heading)
    const dy = endPt.lat - startPt.lat;
    const dx = endPt.lng - startPt.lng;
    const targetAngle = Math.atan2(dx, dy) * 180 / Math.PI;

    // 2. Ø­Ø³Ø§Ø¨ Ù…Ø«Ù„Ø« Ø§Ù„Ø±ÙŠØ§Ø­ (Ø§Ù„Ø³Ø±Ø¹Ø© Ø§Ù„Ø£Ø±Ø¶ÙŠØ© Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠØ©)
    const windRad = (weather.deg - targetAngle) * Math.PI / 180;
    const headwind = Math.cos(windRad) * weather.windKm;
    const crosswind = Math.sin(windRad) * weather.windKm;
    
    // Ø§Ù„Ø³Ø±Ø¹Ø© Ø§Ù„Ø£Ø±Ø¶ÙŠØ© Ø§Ù„ÙØ¹Ù„ÙŠØ© (ØªØ£Ø«ÙŠØ± Ø§Ù„Ù…Ù‚Ø§ÙˆÙ…Ø© ÙˆØ§Ù„Ø¯ÙØ¹)
    const groundSpeedKmh = Math.sqrt(Math.pow(AIR_SPEED_KMH - headwind, 2) + Math.pow(crosswind, 2));
    const gsMmin = (groundSpeedKmh * 1000) / 60;
    
    document.getElementById('st-groundspeed').innerText = gsMmin.toFixed(2) + " m/min";

    // 3. ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø¨Ø°ÙƒØ§Ø¡ (Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„Ø·Ø¨ÙŠØ¹ÙŠ)
    const totalDist = map.distance(startPt, endPt) / 1000;
    let progress = (elapsedHours * groundSpeedKmh) / totalDist;
    if(progress > 1) progress = 1;

    // Ù…Ø­Ø§ÙƒØ§Ø© "Ø§Ù„ØªØ°Ø¨Ø°Ø¨ Ø§Ù„Ø·Ø¨ÙŠØ¹ÙŠ" Ù„Ù„Ø·ÙŠØ±Ø§Ù† (Ù„ÙŠØ³ Ø®Ø·Ø§Ù‹ Ù…Ø³Ø·Ø±Ø§Ù‹)
    const wobble = Math.sin(progress * 20) * 0.001 * (weather.windKm / 10);
    const curLat = startPt.lat + (endPt.lat - startPt.lat) * progress + wobble;
    const curLng = startPt.lng + (endPt.lng - startPt.lng) * progress + (wobble/2);

    const currentPos = [curLat, curLng];
    pigeon.setLatLng(currentPos);
    
    // ØªØ¯ÙˆÙŠØ± Ø±Ø£Ø³ Ø§Ù„Ø­Ù…Ø§Ù…Ø© Ø¨Ø§ØªØ¬Ø§Ù‡ Ø§Ù„Ø­Ø±ÙƒØ©
    document.getElementById('bird-icon').style.transform = `rotate(${targetAngle}deg)`;

    // 4. Ø±Ø³Ù… Ø§Ù„Ù…Ø³Ø§Ø± Ø®Ù„Ù Ø§Ù„Ø­Ù…Ø§Ù…Ø© Ù„Ø­Ø¸Ø© Ø¨Ù„Ø­Ø¸Ø©
    historyCoords.push(currentPos);
    livePath.setLatLngs(historyCoords);

    // 5. ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ ÙˆØ§Ù„ÙˆÙ‚Øª ETA
    const remKm = totalDist * (1 - progress);
    document.getElementById('st-rem-dist').innerText = remKm.toFixed(2) + " Km";

    if(progress < 1) {
        const remSec = (remKm / groundSpeedKmh) * 3600;
        const eta = new Date(now.getTime() + remSec * 1000);
        document.getElementById('st-eta').innerText = eta.getHours().toString().padStart(2,'0') + ":" + 
                                                     eta.getMinutes().toString().padStart(2,'0') + ":" + 
                                                     eta.getSeconds().toString().padStart(2,'0');
        requestAnimationFrame(updateFrame);
    } else {
        document.getElementById('st-eta').innerText = "Ø¯Ø®Ù„Øª";
    }
}
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="ar">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ELMAKKAOUY RADAR PRO - MANUAL SMART</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <style>
        :root { --primary: #00d4ff; --bg: #050a14; --card: #111827; }
        body { margin: 0; background: var(--bg); color: white; font-family: 'Segoe UI', sans-serif; direction: ltr; }
        .app-container { display: grid; grid-template-columns: 350px 1fr; height: 100vh; }
        @media (max-width: 800px) { .app-container { grid-template-columns: 1fr; } }

        /* Sidebar */
        .sidebar { background: var(--card); padding: 20px; border-right: 2px solid #1e293b; overflow-y: auto; }
        .input-box { background: #1f2937; padding: 12px; border-radius: 10px; margin-bottom: 15px; border: 1px solid #374151; }
        label { display: block; font-size: 11px; color: var(--primary); margin-bottom: 5px; font-weight: bold; }
        input, select { background: transparent; border: none; color: white; width: 100%; outline: none; font-size: 14px; }
        
        /* Auto-complete suggestions */
        .suggestions { background: #374151; border-radius: 0 0 10px 10px; position: absolute; width: 310px; z-index: 1000; max-height: 150px; overflow-y: auto; }
        .suggestion-item { padding: 10px; cursor: pointer; border-bottom: 1px solid #4b5563; }
        .suggestion-item:hover { background: var(--primary); color: #000; }

        /* Map & Results */
        .main-content { padding: 20px; overflow-y: auto; }
        #map { height: 300px; border-radius: 15px; border: 1px solid var(--primary); margin-bottom: 20px; }
        
        .weather-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-bottom: 20px; }
        .w-stat { background: #111827; padding: 10px; border-radius: 10px; text-align: center; border: 1px solid #1e293b; }
        .w-stat small { display: block; font-size: 10px; color: #94a3b8; }
        .w-stat b { color: var(--primary); font-size: 1.1rem; }

        .btn { padding: 12px; border-radius: 8px; border: none; font-weight: bold; cursor: pointer; width: 100%; margin-top: 10px; }
        .btn-add { background: var(--primary); color: #000; }
        .btn-calc { background: #10b981; color: white; }

        .racer-row { background: #1e293b; padding: 15px; border-radius: 10px; margin-bottom: 10px; display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; align-items: center; }
        
        #captureArea { background: white; color: black; border-radius: 15px; padding: 0; overflow: hidden; display: none; margin-top: 20px; }
        .final-table { width: 100%; border-collapse: collapse; }
        .final-table th { background: #111827; color: white; padding: 12px; }
        .final-table td { padding: 12px; border-bottom: 1px solid #eee; text-align: center; }
    </style>
</head>
<body>

<div class="app-container">
    <div class="sidebar">
        <h2 style="color:var(--primary); text-align:center;">RADAR PRO 2026</h2>
        
        <div class="input-box">
            <label>üìç RELEASE COORD (Lat, Lng)</label>
            <input type="text" id="startCoord" value="33.2722, -8.3732" onchange="updateStart()">
        </div>

        <div class="input-box" style="position:relative;">
            <label>üèÅ ARRIVAL CITY (SMART SEARCH)</label>
            <input type="text" id="cityInput" placeholder="Type city name..." oninput="searchCity(this.value)">
            <div id="suggestBox" class="suggestions"></div>
        </div>

        <div class="input-box">
            <label>‚è∞ RELEASE DATE & TIME</label>
            <input type="datetime-local" id="startTime">
        </div>

        <hr style="border: 0.5px solid #1e293b; margin: 20px 0;">
        
        <h3 style="font-size: 14px;">Add Competitors</h3>
        <div class="input-box">
            <label>RACER NAME</label>
            <input type="text" id="racerName" placeholder="Enter name">
        </div>
        <button class="btn btn-add" onclick="addRacer()">+ ADD TO LIST</button>
        
        <div id="racersList" style="margin-top: 20px;"></div>
        
        <button class="btn btn-calc" onclick="calculateFinal()">üèÜ RUN CALCULATION</button>
        <button class="btn" style="background:#475569; color:white;" onclick="downloadRes()">üì∏ SAVE IMAGE</button>
    </div>

    <div class="main-content">
        <div id="map"></div>
        
        <div class="weather-grid">
            <div class="w-stat"><small>WIND</small><b id="w-speed">--</b></div>
            <div class="w-stat"><small>DIRECTION</small><b id="w-dir">--</b></div>
            <div class="w-stat"><small>TEMP</small><b id="w-temp">--</b></div>
        </div>

        <div id="captureArea">
            <div style="background:#111827; color:#00d4ff; padding:20px; text-align:center;">
                <h2 style="margin:0;">ELMAKKAOUY RADAR OFFICIAL</h2>
                <small id="raceInfo"></small>
            </div>
            <table class="final-table" id="resTable">
                <thead>
                    <tr>
                        <th>POS</th>
                        <th>NAME</th>
                        <th>DISTANCE</th>
                        <th>ARRIVAL</th>
                        <th>SPEED (m/m)</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </div>
</div>

<script>
    let map, startMarker, racers = [];
    let destinationCoord = [33.5731, -7.5898]; // Default: Casablanca

    // 1. Initialize Map
    window.onload = () => {
        map = L.map('map', { zoomControl: false }).setView([33.2722, -8.3732], 7);
        L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png').addTo(map);
        startMarker = L.marker([33.2722, -8.3732]).addTo(map).bindPopup("Release");
        
        const now = new Date();
        now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
        document.getElementById('startTime').value = now.toISOString().slice(0,16);
        updateStart();
    };

    // 2. Smart City Search (Using OpenStreetMap Nominatim)
    async function searchCity(query) {
        if (query.length < 3) return;
        try {
            const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${query}&limit=5`);
            const data = await res.json();
            const box = document.getElementById('suggestBox');
            box.innerHTML = data.map(item => `
                <div class="suggestion-item" onclick="selectCity('${item.display_name}', ${item.lat}, ${item.lon})">
                    ${item.display_name}
                </div>
            `).join('');
        } catch(e) {}
    }

    function selectCity(name, lat, lon) {
        document.getElementById('cityInput').value = name.split(',')[0];
        document.getElementById('suggestBox').innerHTML = '';
        destinationCoord = [lat, lon];
        L.marker([lat, lon], {icon: L.divIcon({html:'üèÅ', className:''})}).addTo(map);
        map.fitBounds([startMarker.getLatLng(), [lat, lon]], {padding: [50,50]});
    }

    // 3. Weather Tracking
    async function updateStart() {
        const c = document.getElementById('startCoord').value.split(',');
        const lat = parseFloat(c[0]), lng = parseFloat(c[1]);
        startMarker.setLatLng([lat, lng]);
        map.setView([lat, lng]);

        try {
            const res = await fetch(`https://api.openweathermap.org/data/2.5/weather?lat=${lat}&lon=${lng}&appid=992e2b79f5e3386bda09d14ff4807f9d&units=metric`);
            const d = await res.json();
            document.getElementById('w-speed').innerText = (d.wind.speed * 3.6).toFixed(1) + " km/h";
            document.getElementById('w-temp').innerText = d.main.temp + "¬∞C";
            const dirs = ['N','NE','E','SE','S','SW','W','NW'];
            document.getElementById('w-dir').innerText = dirs[Math.round(d.wind.deg/45)%8];
        } catch(e) {}
    }

    // 4. Manual Entry Logic
    function addRacer() {
        const name = document.getElementById('racerName').value;
        if (!name) return;
        
        // Calculate Distance using Haversine formula
        const start = startMarker.getLatLng();
        const dist = (map.distance(start, destinationCoord) / 1000).toFixed(3);

        racers.push({ name, dist, h:12, m:0, s:0 });
        renderRacers();
        document.getElementById('racerName').value = '';
    }

    function renderRacers() {
        document.getElementById('racersList').innerHTML = racers.map((r, i) => `
            <div class="racer-row" style="background:#111827; border: 1px solid #1e293b; padding: 10px; border-radius: 8px;">
                <div style="font-size:12px;"><b>${r.name}</b><br><small>${r.dist} Km</small></div>
                <div style="display:flex; gap:2px;">
                    <input type="number" value="${r.h}" onchange="racers[${i}].h=this.value" style="width:30px; background:#050a14; border:1px solid #334151;">:
                    <input type="number" value="${r.m}" onchange="racers[${i}].m=this.value" style="width:30px; background:#050a14; border:1px solid #334151;">:
                    <input type="number" value="${r.s}" onchange="racers[${i}].s=this.value" style="width:30px; background:#050a14; border:1px solid #334151;">
                </div>
                <button onclick="racers.splice(${i},1); renderRacers()" style="background:none; border:none; color:#ff4d4d; cursor:pointer;">‚úñ</button>
            </div>
        `).join('');
    }

    // 5. Final Calculation
    function calculateFinal() {
        const startTime = new Date(document.getElementById('startTime').value);
        let finalData = [];

        racers.forEach(r => {
            let arrival = new Date(startTime);
            arrival.setHours(r.h, r.m, r.s);
            let diffMin = (arrival - startTime) / 60000;
            if (diffMin > 0) {
                let speed = (parseFloat(r.dist) * 1000) / diffMin;
                finalData.push({ ...r, speed, arrTime: `${r.h}:${r.m}:${r.s}` });
            }
        });

        finalData.sort((a,b) => b.speed - a.speed);
        
        const tbody = document.querySelector('#resTable tbody');
        tbody.innerHTML = finalData.map((d, i) => `
            <tr>
                <td>${i+1}</td>
                <td><b>${d.name}</b></td>
                <td>${d.dist} Km</td>
                <td>${d.arrTime}</td>
                <td><b style="color:#16a34a">${d.speed.toFixed(3)}</b></td>
            </tr>
        `).join('');
        
        document.getElementById('raceInfo').innerText = `Release: ${startTime.toLocaleString()} | From: ${document.getElementById('startCoord').value} | To: ${document.getElementById('cityInput').value}`;
        document.getElementById('captureArea').style.display = 'block';
    }

    function downloadRes() {
        html2canvas(document.getElementById('captureArea')).then(canvas => {
            const a = document.createElement('a');
            a.download = 'RADAR_RESULT.png';
            a.href = canvas.toDataURL();
            a.click();
        });
    }
</script>
</body>
</html>

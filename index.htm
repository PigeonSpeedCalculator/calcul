<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Pigeon Speed Expert - BY ELMAKKAOUY</title>
    <link rel="manifest" href="manifest.json">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        :root { --primary: #3182ce; --success: #27ae60; --dark: #2d3748; }
        body { margin: 0; background: #f4f7f9; font-family: 'Segoe UI', system-ui; }
        .sticky-header { position: sticky; top: 0; z-index: 1000; background: #fff; padding: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .header-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .btn-calc { background: var(--success); color: #fff; border: none; padding: 10px 25px; border-radius: 25px; font-weight: bold; cursor: pointer; }
        #searchInput { width: 100%; padding: 12px; border: 2px solid var(--primary); border-radius: 12px; font-size: 16px; box-sizing: border-box; }
        
        .content { padding: 15px; max-width: 500px; margin: 0 auto; }
        .card { background: #fff; border-radius: 15px; padding: 15px; margin-bottom: 15px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        label { display: block; font-size: 12px; color: #718096; margin-bottom: 4px; font-weight: bold; }
        input { width: 100%; padding: 12px; margin-bottom: 10px; border: 1px solid #e2e8f0; border-radius: 8px; box-sizing: border-box; text-align: center; font-size: 15px; }
        
        .dead-time-box { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; background: #edf2f7; padding: 10px; border-radius: 8px; margin-bottom: 10px; }
        .btn-add-time { background: #ebf8ff; color: var(--primary); border: 1px dashed var(--primary); padding: 8px; width: 100%; border-radius: 8px; cursor: pointer; font-size: 13px; }
        
        #rankingSection { margin-top: 20px; }
        .result-item { display:flex; justify-content:space-between; padding:12px; border-bottom:1px solid #eee; }
        .copyright { text-align: center; padding: 15px; font-weight: bold; color: #a0aec0; letter-spacing: 2px; font-size: 11px; }
    </style>
</head>
<body>

<div id="app-root">
    <div class="sticky-header">
        <div class="header-row">
            <span style="font-weight: bold; color: var(--primary);">ELMAKKAOUY PRO</span>
            <button class="btn-calc" onclick="calculateAll()">Calculate üèÜ</button>
        </div>
        <input type="text" id="searchInput" onkeyup="filterRacer()" placeholder="Search racer name...">
    </div>

    <div class="content">
        <div class="card">
            <label>1. Race Document (PDF)</label>
            <input type="file" id="pdfInput" accept=".pdf">
            
            <label>2. Release Date & Time</label>
            <input type="datetime-local" id="releaseDateTime">

            <label>3. Dead Time (Neutralization)</label>
            <div class="dead-time-box">
                <div><label>Start (Night)</label><input type="time" id="deadStart" value="22:00"></div>
                <div><label>End (Morning)</label><input type="time" id="deadEnd" value="05:30"></div>
            </div>
            <button onclick="addManual()" style="width:100%; background:var(--primary); color:#fff; border:none; padding:10px; border-radius:8px;">+ Add Manual Racer</button>
        </div>

        <div id="racersList"></div>

        <div id="rankingSection" style="display:none;">
            <div id="capture-area" style="background:#fff; border:1px solid #ddd; border-radius:12px; overflow:hidden;">
                <div style="background:var(--primary); color:#fff; padding:15px; text-align:center;"><b>RACE RESULTS</b></div>
                <div id="rankingList"></div>
                <div class="copyright">BY ELMAKKAOUY</div>
            </div>
            <button onclick="saveImage()" style="width:100%; padding:15px; background:#4a5568; color:#fff; border:none; border-radius:12px; margin-top:10px; font-weight:bold;">Download Result Image üì∏</button>
        </div>
    </div>
</div>

<script>
    let racers = [];

    // Smart PDF Parsing
    document.getElementById('pdfInput').onchange = async (e) => {
        const file = e.target.files[0];
        const reader = new FileReader();
        reader.onload = async function() {
            const loadingTask = pdfjsLib.getDocument(new Uint8Array(this.result));
            const pdf = await loadingTask.promise;
            let foundData = [];

            for (let i = 1; i <= pdf.numPages; i++) {
                const page = await pdf.getPage(i);
                const textContent = await page.getTextContent();
                let lines = {};
                
                textContent.items.forEach(item => {
                    let y = Math.round(item.transform[5]);
                    if (!lines[y]) lines[y] = [];
                    lines[y].push(item);
                });

                Object.keys(lines).sort((a,b)=>b-a).forEach(y => {
                    let row = lines[y].sort((a,b)=>a.transform[4]-b.transform[4]).map(it => it.str.trim()).filter(s => s !== "");
                    
                    // Smart detection: Look for a name (string) and a distance (number with decimals like 120.450)
                    let distance = row.find(val => /^-?\d+\.\d{3}$/.test(val) || (parseFloat(val) > 10 && val.includes('.')));
                    let name = row.find(val => val.length > 3 && isNaN(val));

                    if (distance && name) {
                        foundData.push({ name: name, dist: parseFloat(distance) });
                    }
                });
            }
            racers = foundData;
            renderRacers();
        };
        reader.readAsArrayBuffer(file);
    };

    function renderRacers() {
        const container = document.getElementById('racersList');
        container.innerHTML = racers.map((r, i) => `
            <div class="card racer-card" data-name="${r.name}">
                <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
                    <b>${r.name}</b> <span>${r.dist} Km</span>
                </div>
                <div id="times-${i}">
                    <input type="datetime-local" class="t-inp-${i}" placeholder="Arrival Date/Time">
                </div>
                <button class="btn-add-time" onclick="addTimeField(${i})">+ Add Pigeon</button>
            </div>
        `).join('');
    }

    function addTimeField(idx) {
        const div = document.createElement('div');
        div.innerHTML = `<input type="datetime-local" class="t-inp-${idx}" style="margin-top:5px;">`;
        document.getElementById(`times-${idx}`).appendChild(div);
    }

    function calculateAll() {
        const releaseTime = new Date(document.getElementById('releaseDateTime').value);
        const dStart = document.getElementById('deadStart').value;
        const dEnd = document.getElementById('deadEnd').value;

        if (isNaN(releaseTime)) return alert("Set Release Date & Time!");

        let results = [];
        racers.forEach((r, i) => {
            document.querySelectorAll(`.t-inp-${i}`).forEach(inp => {
                if (inp.value) {
                    const arrivalTime = new Date(inp.value);
                    let travelMinutes = (arrivalTime - releaseTime) / 60000;

                    // Dead Time Logic (for multi-day races)
                    if (travelMinutes > 0) {
                        travelMinutes -= calculateDeadTime(releaseTime, arrivalTime, dStart, dEnd);
                        let speed = (r.dist * 1000) / travelMinutes;
                        results.push({ name: r.name, dist: r.dist, speed: speed, time: inp.value.replace('T', ' ') });
                    }
                }
            });
        });

        results.sort((a, b) => b.speed - a.speed);
        displayResults(results);
    }

    function calculateDeadTime(start, end, dStart, dEnd) {
        let totalDead = 0;
        let current = new Date(start);
        current.setHours(0,0,0,0);

        let endDay = new Date(end);
        endDay.setHours(0,0,0,0);

        while (current <= endDay) {
            let nightStart = new Date(current);
            let [hS, mS] = dStart.split(':');
            nightStart.setHours(hS, mS, 0);

            let morningEnd = new Date(current);
            morningEnd.setDate(morningEnd.getDate() + 1);
            let [hE, mE] = dEnd.split(':');
            morningEnd.setHours(hE, mE, 0);

            // Calculate overlap between (nightStart to morningEnd) and (start to end)
            let overlapStart = new Date(Math.max(start, nightStart));
            let overlapEnd = new Date(Math.min(end, morningEnd));

            if (overlapStart < overlapEnd) {
                totalDead += (overlapEnd - overlapStart) / 60000;
            }
            current.setDate(current.getDate() + 1);
        }
        return totalDead;
    }

    function displayResults(data) {
        const list = document.getElementById('rankingList');
        list.innerHTML = data.map((r, i) => `
            <div class="result-item">
                <div><b>${i+1}. ${r.name}</b><br><small>${r.dist} Km | ${r.time}</small></div>
                <div style="text-align:right"><b style="color:var(--success)">${r.speed.toFixed(3)}</b><br><small>m/m</small></div>
            </div>
        `).join('');
        document.getElementById('rankingSection').style.display = 'block';
        document.getElementById('rankingSection').scrollIntoView({ behavior: 'smooth' });
    }

    function filterRacer() {
        let q = document.getElementById('searchInput').value.toLowerCase();
        document.querySelectorAll('.racer-card').forEach(c => {
            c.style.display = c.getAttribute('data-name').toLowerCase().includes(q) ? 'block' : 'none';
        });
    }

    function saveImage() {
        html2canvas(document.getElementById('capture-area')).then(canvas => {
            const link = document.createElement('a');
            link.download = 'Race_Results_ELMAKKAOUY.png';
            link.href = canvas.toDataURL();
            link.click();
        });
    }
</script>
</body>
</html>

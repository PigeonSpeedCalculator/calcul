<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø±Ø§Ø¯Ø§Ø± Ø§Ù„Ù…ÙƒØ§ÙˆÙŠ - Ù†Ø¸Ø§Ù… Ø§Ù„Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª Ø§Ù„Ù…ØªÙ‚Ø¯Ù…</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>

    <style>
        :root { --primary: #3b82f6; --bg: #0b0f19; --card: #161b2a; }
        body { margin: 0; background: var(--bg); color: white; font-family: sans-serif; text-align: right; }
        .header { background: var(--card); padding: 15px; border-bottom: 2px solid var(--primary); display: flex; justify-content: space-between; }
        .container { max-width: 800px; margin: 0 auto; padding: 10px; }
        #map { height: 350px; width: 100%; border-radius: 20px; border: 1px solid #2d3748; margin-bottom: 15px; }
        .card { background: var(--card); border-radius: 20px; padding: 15px; border: 1px solid #2d3748; margin-bottom: 15px; }
        input, button { width: 100%; padding: 12px; margin-top: 10px; border-radius: 10px; border: none; box-sizing: border-box; }
        input { background: #0b0f19; color: white; border: 1px solid #2d3748; text-align: center; }
        .btn-upload { background: #f59e0b; color: black; font-weight: bold; cursor: pointer; }
        .btn-radar { background: var(--primary); color: white; font-weight: bold; cursor: pointer; }
        .racer-list { margin-top: 15px; }
        .racer-card { background: #1a202c; padding: 10px; margin-bottom: 8px; border-radius: 12px; border-right: 4px solid var(--primary); display: flex; justify-content: space-between; }
        .speed { color: #22c55e; font-weight: bold; }
    </style>
</head>
<body>

<header class="header">
    <div style="font-weight: bold;">ELMAKKAOUY <span style="color:var(--primary)">RADAR V2</span></div>
    <div id="clock">00:00:00</div>
</header>

<div class="container">
    <div id="map"></div>

    <div class="card">
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
            <div>
                <label>ğŸ“ Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª Ø§Ù„Ø¥Ø·Ù„Ø§Ù‚</label>
                <input type="text" id="startCoord" value="33.2722, -8.3732">
            </div>
            <div>
                <label>ğŸ™ï¸ Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª Ø§Ù„Ø³Ù†Ø·Ø±Ø§Ù„</label>
                <input type="text" id="endCoord" value="33.5731, -7.5898">
            </div>
        </div>
        
        <label>â° ÙˆÙ‚Øª Ø§Ù„Ø¥Ø·Ù„Ø§Ù‚ Ø§Ù„Ø±Ø³Ù…ÙŠ</label>
        <input type="datetime-local" id="releaseTime">

        <button class="btn-upload" onclick="document.getElementById('fileInput').click()">ğŸ“ Ø¥Ø¯Ø±Ø§Ø¬ Ù…Ù„Ù Ø§Ù„Ù†ØªØ§Ø¦Ø¬ ÙˆØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆØ§Ù‚Ø¹</button>
        <input type="file" id="fileInput" hidden onchange="processFile(event)">
        
        <button class="btn-radar" onclick="toggleRadar()">ğŸ“¡ ØªØ´ØºÙŠÙ„ Ø§Ù„Ù…Ø­Ø§ÙƒØ§Ø© Ø§Ù„Ø­ÙŠØ©</button>
    </div>

    <div id="list" class="racer-list"></div>
</div>

<script>
    let map, markers = [], simInterval;
    const API_KEY = '992e2b79f5e3386bda09d14ff4807f9d';

    function initMap() {
        map = L.map('map', { zoomControl: false }).setView([33.4, -8], 8);
        L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png').addTo(map);
        document.getElementById('releaseTime').value = new Date().toISOString().slice(0, 16);
    }

    // ÙˆØ¸ÙŠÙØ© Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª Ù„Ù„Ù…ØªØ³Ø§Ø¨Ù‚ÙŠÙ† Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø³Ø§ÙØ©
    function calculatePosition(start, end, distanceKM) {
        const totalDist = L.latLng(start).distanceTo(L.latLng(end)) / 1000;
        const ratio = Math.min(distanceKM / totalDist, 1);
        
        return [
            start[0] + (end[0] - start[0]) * ratio,
            start[1] + (end[1] - start[1]) * ratio
        ];
    }

    async function processFile(event) {
        const file = event.target.files[0];
        if (!file) return;

        const start = document.getElementById('startCoord').value.split(',').map(Number);
        const end = document.getElementById('endCoord').value.split(',').map(Number);
        
        // Ù…Ø³Ø­ Ø§Ù„Ø®Ø±ÙŠØ·Ø© ÙˆØ§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©
        markers.forEach(m => map.removeLayer(m));
        markers = [];
        document.getElementById('list').innerHTML = "Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­Ø³Ø§Ø¨...";

        // Ù…Ø­Ø§ÙƒØ§Ø© Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (ÙŠØªÙ… Ø§Ø³ØªØ¨Ø¯Ø§Ù„Ù‡Ø§ Ø¨Ù€ PDF Parser Ø­Ø³Ø¨ Ù‡ÙŠÙƒÙ„Ø© Ù…Ù„ÙÙƒ)
        setTimeout(() => {
            const data = [
                { name: "Ø§Ù„Ø¨Ø·Ù„ Ø¹Ø«Ù…Ø§Ù†", dist: 190.5, arrival: "14:20:05" },
                { name: "Ø§Ù„Ø¨Ø·Ù„ Ø±Ø´ÙŠØ¯", dist: 216.6, arrival: "13:55:10" },
                { name: "Ø§Ù„Ø¨Ø·Ù„ Ù…Ø­Ù…Ø¯", dist: 205.2, arrival: "14:05:30" }
            ];

            let html = "";
            data.forEach(r => {
                // Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¬ØºØ±Ø§ÙÙŠ Ù„ÙƒÙ„ Ù…ØªØ³Ø§Ø¨Ù‚
                const pos = calculatePosition(start, end, r.dist);
                
                // Ø¥Ø¶Ø§ÙØ© Ù…Ø§Ø±ÙƒØ± Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø±ÙŠØ·Ø© ÙÙŠ Ù…ÙƒØ§Ù† Ø§Ù„Ù…ØªØ³Ø§Ø¨Ù‚
                const m = L.marker(pos, {
                    icon: L.divIcon({ html: 'ğŸ•Šï¸', className: 'pigeon-marker', iconSize: [25, 25] })
                }).addTo(map).bindPopup(`${r.name}: ${r.dist}km`);
                markers.push(m);

                html += `
                    <div class="racer-card">
                        <div><b>${r.name}</b><br><small>Ø§Ù„Ù…Ø³Ø§ÙØ©: ${r.dist} ÙƒÙ…</small></div>
                        <div class="speed">Ø§Ù„ÙˆØµÙˆÙ„: ${r.arrival}</div>
                    </div>
                `;
            });

            document.getElementById('list').innerHTML = html;
            if(markers.length) {
                const group = new L.featureGroup(markers);
                map.fitBounds(group.getBounds(), {padding: [50, 50]});
            }
        }, 1500);
    }

    function toggleRadar() {
        alert("Ø¨Ø¯Ø£Øª Ø§Ù„Ù…Ø­Ø§ÙƒØ§Ø© Ø§Ù„Ø­ÙŠØ© Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª Ù†Ù‚Ø·Ø© Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„Ù…Ø­Ø¯Ø«Ø©.");
    }

    setInterval(() => {
        document.getElementById('clock').innerText = new Date().toTimeString().split(' ')[0];
    }, 1000);

    initMap();
</script>
</body>
</html>

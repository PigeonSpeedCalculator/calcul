<!DOCTYPE html>
<html lang="ar">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ELMAKKAOUY RADAR PRO 2026</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <style>
        :root { --primary: #00d4ff; --bg: #050a14; --card: #0f172a; --accent: #10b981; }
        body { margin: 0; background: var(--bg); color: white; font-family: 'Segoe UI', Tahoma, sans-serif; }
        
        /* Navigation */
        .nav-tabs { display: flex; background: #111827; border-bottom: 2px solid #1e293b; position: sticky; top: 0; z-index: 2000; }
        .tab-link { flex: 1; padding: 15px; text-align: center; cursor: pointer; font-weight: bold; color: #94a3b8; border-bottom: 3px solid transparent; }
        .tab-link.active { color: var(--primary); border-bottom-color: var(--primary); background: rgba(0, 212, 255, 0.1); }

        .page { display: none; min-height: calc(100vh - 55px); padding: 20px; box-sizing: border-box; }
        .page.active { display: block; }

        /* Simulation Map */
        #map { height: 500px; border-radius: 20px; border: 1px solid var(--primary); position: relative; }
        .wind-indicator { position: absolute; top: 20px; right: 20px; z-index: 1000; background: rgba(0,0,0,0.8); padding: 10px; border-radius: 50%; border: 2px solid var(--primary); width: 60px; height: 60px; display: flex; align-items: center; justify-content: center; transition: 0.5s; }

        /* Calculator Styles */
        .input-row { display: grid; grid-template-columns: 2fr 1fr 1.5fr auto; gap: 10px; background: var(--card); padding: 15px; border-radius: 12px; margin-bottom: 10px; border: 1px solid #1e293b; }
        input { background: #050a14; border: 1px solid #334155; color: white; padding: 10px; border-radius: 8px; width: 100%; box-sizing: border-box; }
        
        .btn { background: var(--primary); color: #000; border: none; padding: 10px 20px; border-radius: 8px; font-weight: bold; cursor: pointer; }
        .btn-sim { background: #f59e0b; color: white; width: 100%; margin-top: 10px; font-size: 1.1rem; }

        /* Pigeon Marker Style */
        .pigeon-icon { font-size: 24px; transition: all 0.1s linear; }

        /* Results Table */
        #captureArea { background: white; color: black; border-radius: 15px; overflow: hidden; display: none; margin-top: 20px; }
        .res-table { width: 100%; border-collapse: collapse; }
        .res-table th { background: #0f172a; color: white; padding: 15px; }
        .res-table td { padding: 12px; border-bottom: 1px solid #eee; text-align: center; }
    </style>
</head>
<body>

    <nav class="nav-tabs">
        <div class="tab-link active" onclick="openTab(event, 'radarPage')">ğŸ“¡ Ø±Ø§Ø¯Ø§Ø± Ø§Ù„Ù…Ø­Ø§ÙƒØ§Ø© Ø§Ù„Ø­ÙŠØ©</div>
        <div class="tab-link" onclick="openTab(event, 'calcPage')">â±ï¸ Ø­Ø³Ø§Ø¨Ø§Øª Ø§Ù„Ø³Ø±Ø¹Ø© Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø©</div>
    </nav>

    <div id="radarPage" class="page active">
        <div style="display: grid; grid-template-columns: 1fr 300px; gap: 20px;">
            <div style="position: relative;">
                <div id="map"></div>
                <div id="windArrow" class="wind-indicator">â¬†ï¸</div>
            </div>

            <div class="control-panel" style="background:var(--card); padding:20px; border-radius:15px;">
                <h3 style="color:var(--primary); margin-top:0;">Ù…Ø­Ø§ÙƒØ§Ø© Ø§Ù„Ø±Ø­Ù„Ø©</h3>
                <label style="font-size:12px;">Ù†Ù‚Ø·Ø© Ø§Ù„Ø§Ù†Ø·Ù„Ø§Ù‚</label>
                <input type="text" id="startCoord" value="33.2722, -8.3732" onchange="initSimulation()">
                
                <label style="font-size:12px; margin-top:10px; display:block;">Ù…Ø¯ÙŠÙ†Ø© Ø§Ù„ÙˆØµÙˆÙ„</label>
                <input type="text" id="cityInput" placeholder="Ø¨Ø­Ø« Ø¹Ù† Ù…Ø¯ÙŠÙ†Ø©..." oninput="citySearch(this.value)">
                <div id="suggestions" style="background:#1e293b; border-radius:5px; max-height:100px; overflow-y:auto;"></div>

                <div style="margin-top:20px; padding:15px; background:rgba(255,255,255,0.05); border-radius:10px;">
                    <small>ØªØ£Ø«ÙŠØ± Ø§Ù„Ø±ÙŠØ§Ø­ Ø§Ù„Ø­Ø§Ù„ÙŠ</small>
                    <div id="windEffect" style="font-weight:bold; color:#10b981;">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù„ÙŠÙ„...</div>
                </div>

                <button class="btn btn-sim" onclick="startFlight()">Ø¥Ø·Ù„Ø§Ù‚ Ø§Ù„Ø­Ù…Ø§Ù…Ø© (Ù…Ø­Ø§ÙƒØ§Ø©) ğŸ•Šï¸</button>
            </div>
        </div>
    </div>

    <div id="calcPage" class="page">
        <div style="background:var(--card); padding:20px; border-radius:15px; margin-bottom:20px;">
            <h3 style="margin-top:0; color:var(--primary);">Ø¥Ø¯Ø®Ø§Ù„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ØªØ³Ø§Ø¨Ù‚ÙŠÙ†</h3>
            <div class="input-row" style="background:none; border:none; padding:0;">
                <input type="text" id="rName" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…ØªØ³Ø§Ø¨Ù‚">
                <input type="number" id="rDist" placeholder="Ø§Ù„Ù…Ø³Ø§ÙØ© (Km)">
                <div style="display:flex; gap:5px; align-items:center;">
                    <input type="number" id="rH" value="12" style="width:50px;">:
                    <input type="number" id="rM" value="00" style="width:50px;">:
                    <input type="number" id="rS" value="00" style="width:50px;">
                </div>
                <button class="btn" onclick="addRacerRow()">Ø¥Ø¶Ø§ÙØ© +</button>
            </div>
        </div>

        <div id="racersList"></div>

        <button class="btn" style="width:100%; background:var(--accent); color:white; font-size:1.2rem; margin-top:20px;" onclick="generateFinalReport()">ğŸ† Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ù„Ø§Ø¦Ø­Ø© Ø§Ù„Ø³Ø±Ø¹Ø© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©</button>

        <div id="captureArea">
            <div style="background:#0f172a; color:#00d4ff; padding:20px; text-align:center;">
                <h2 style="margin:0;">ELMAKKAOUY RADAR PRO - OFFICIAL RESULTS</h2>
            </div>
            <table class="res-table" id="resTable">
                <thead>
                    <tr>
                        <th>Ø§Ù„Ø±ØªØ¨Ø©</th>
                        <th>Ø§Ù„Ù…ØªØ³Ø§Ø¨Ù‚</th>
                        <th>Ø§Ù„Ù…Ø³Ø§ÙØ©</th>
                        <th>ÙˆÙ‚Øª Ø§Ù„ÙˆØµÙˆÙ„</th>
                        <th>Ø§Ù„Ø³Ø±Ø¹Ø© (Ù…/Ø¯)</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </div>

<script>
    let map, startMarker, pigeonMarker, flightPath;
    let racers = [];
    let windSpeed = 0, windDeg = 0;
    let destCoord = null;

    function openTab(evt, tabName) {
        document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
        document.querySelectorAll('.tab-link').forEach(l => l.classList.remove('active'));
        document.getElementById(tabName).classList.add('active');
        evt.currentTarget.classList.add('active');
        if(tabName === 'radarPage') setTimeout(() => map.invalidateSize(), 200);
    }

    // 1. Ù†Ø¸Ø§Ù… Ø§Ù„Ø±Ø§Ø¯Ø§Ø± ÙˆØ§Ù„Ù…Ø­Ø§ÙƒØ§Ø©
    window.onload = () => {
        map = L.map('map', { zoomControl: false }).setView([33.2722, -8.3732], 7);
        L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png').addTo(map);
        startMarker = L.marker([33.2722, -8.3732]).addTo(map);
        initSimulation();
    };

    async function initSimulation() {
        const c = document.getElementById('startCoord').value.split(',');
        const lat = parseFloat(c[0]), lng = parseFloat(c[1]);
        startMarker.setLatLng([lat, lng]);

        const res = await fetch(`https://api.openweathermap.org/data/2.5/weather?lat=${lat}&lon=${lng}&appid=992e2b79f5e3386bda09d14ff4807f9d&units=metric`);
        const d = await res.json();
        windSpeed = d.wind.speed; // m/s
        windDeg = d.wind.deg;
        
        document.getElementById('windArrow').style.transform = `rotate(${windDeg}deg)`;
        document.getElementById('windEffect').innerText = `Ø±ÙŠØ§Ø­: ${(windSpeed * 3.6).toFixed(1)} ÙƒÙ…/Ø³`;
    }

    async function citySearch(v) {
        if(v.length < 3) return;
        const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${v}&limit=3`);
        const data = await res.json();
        document.getElementById('suggestions').innerHTML = data.map(d => `<div style="padding:5px; cursor:pointer;" onclick="setDest(${d.lat}, ${d.lon}, '${d.display_name}')">${d.display_name.split(',')[0]}</div>`).join('');
    }

    function setDest(lat, lon, name) {
        destCoord = [lat, lon];
        document.getElementById('cityInput').value = name.split(',')[0];
        document.getElementById('suggestions').innerHTML = '';
        if(flightPath) map.removeLayer(flightPath);
        flightPath = L.polyline([startMarker.getLatLng(), destCoord], {color: var(--primary), dashArray: '5, 10'}).addTo(map);
        map.fitBounds(flightPath.getBounds(), {padding:[50,50]});
        
        // Ø§Ù„ØªØ¹Ø¨Ø¦Ø© Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠØ© Ù„Ù„Ù…Ø³Ø§ÙØ© ÙÙŠ ØµÙØ­Ø© Ø§Ù„Ø­Ø³Ø§Ø¨
        document.getElementById('rDist').value = (map.distance(startMarker.getLatLng(), destCoord)/1000).toFixed(3);
    }

    // Ù…Ø­Ø§ÙƒØ§Ø© Ø§Ù„Ø·ÙŠØ±Ø§Ù† Ø§Ù„ÙˆØ§Ù‚Ø¹ÙŠ
    function startFlight() {
        if(!destCoord) return alert("Ø­Ø¯Ø¯ Ù…Ø¯ÙŠÙ†Ø© Ø§Ù„ÙˆØµÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹");
        if(pigeonMarker) map.removeLayer(pigeonMarker);
        
        pigeonMarker = L.marker(startMarker.getLatLng(), {
            icon: L.divIcon({ html: '<div class="pigeon-icon">ğŸ•Šï¸</div>', className: '' })
        }).addTo(map);

        let progress = 0;
        const start = startMarker.getLatLng();
        
        // Ø­Ø³Ø§Ø¨ ØªØ£Ø«ÙŠØ± Ø§Ù„Ø±ÙŠØ§Ø­ (ØªØ¨Ø³ÙŠØ·: Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„Ø²Ø§ÙˆÙŠØ© Ù…ØªÙ‚Ø§Ø±Ø¨Ø© ØªØ²ÙŠØ¯ Ø§Ù„Ø³Ø±Ø¹Ø©)
        let simulationStep = 0.005; 
        
        const interval = setInterval(() => {
            progress += simulationStep;
            if(progress >= 1) {
                clearInterval(interval);
                pigeonMarker.setLatLng(destCoord);
                return;
            }

            let lat = start.lat + (destCoord[0] - start.lat) * progress;
            let lng = start.lng + (destCoord[1] - start.lng) * progress;
            
            // Ø§Ù†Ø­Ø±Ø§Ù Ø¨Ø³ÙŠØ· Ø¨Ø³Ø¨Ø¨ Ø§Ù„Ø±ÙŠØ§Ø­ Ù„Ù„Ù…Ø­Ø§ÙƒØ§Ø© Ø§Ù„Ø¨ØµØ±ÙŠØ©
            let windDrift = (Math.sin(progress * Math.PI) * windSpeed * 0.001);
            pigeonMarker.setLatLng([lat + windDrift, lng + windDrift]);
            
        }, 50);
    }

    // 2. Ù†Ø¸Ø§Ù… Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª
    function addRacerRow() {
        const name = document.getElementById('rName').value;
        const dist = document.getElementById('rDist').value;
        const h = document.getElementById('rH').value;
        const m = document.getElementById('rM').value;
        const s = document.getElementById('rS').value;

        if(!name || !dist) return;

        racers.push({ name, dist, h, m, s });
        renderRacers();
        document.getElementById('rName').value = '';
    }

    function renderRacers() {
        document.getElementById('racersList').innerHTML = racers.map((r, i) => `
            <div class="input-row">
                <div style="font-weight:bold;">${r.name}</div>
                <div style="color:var(--primary)">${r.dist} Km</div>
                <div>${r.h}:${r.m}:${r.s}</div>
                <button onclick="racers.splice(${i},1); renderRacers()" style="background:none; border:none; color:#ff4d4d; cursor:pointer;">âœ–</button>
            </div>
        `).join('');
    }

    function generateFinalReport() {
        // Ù†Ø³ØªØ®Ø¯Ù… ØªÙˆÙ‚ÙŠØª Ø§Ù„Ø§Ù†Ø·Ù„Ø§Ù‚ Ø§Ù„Ø­Ø§Ù„ÙŠ Ø£Ùˆ Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ 07:00:00
        let startT = new Date();
        startT.setHours(7,0,0); 

        let results = racers.map(r => {
            let arrival = new Date(startT);
            arrival.setHours(r.h, r.m, r.s);
            let diffMin = (arrival - startT) / 60000;
            let speed = (parseFloat(r.dist) * 1000) / diffMin;
            return { ...r, speed };
        }).sort((a,b) => b.speed - a.speed);

        const tbody = document.querySelector('#resTable tbody');
        tbody.innerHTML = results.map((r, i) => `
            <tr>
                <td>${i+1}</td>
                <td style="text-align:right"><b>${r.name}</b></td>
                <td>${r.dist} Km</td>
                <td>${r.h}:${r.m}:${r.s}</td>
                <td style="color:#16a34a; font-weight:bold;">${r.speed.toFixed(3)}</td>
            </tr>
        `).join('');
        document.getElementById('captureArea').style.display = 'block';
    }
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="ar">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Pigeon Speed Auto-Geo - BY ELMAKKAOUY</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        :root { --primary: #3182ce; --success: #27ae60; --dark: #2d3748; }
        body { margin: 0; background: #f4f7f9; font-family: 'Segoe UI', Tahoma, sans-serif; direction: rtl; }
        .sticky-header { position: sticky; top: 0; z-index: 1000; background: #fff; padding: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .header-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .btn-calc { background: var(--success); color: #fff; border: none; padding: 10px 25px; border-radius: 25px; font-weight: bold; cursor: pointer; }
        #searchInput { width: 100%; padding: 12px; border: 2px solid var(--primary); border-radius: 12px; font-size: 16px; box-sizing: border-box; }
        .content { padding: 15px; max-width: 500px; margin: 0 auto; }
        .card { background: #fff; border-radius: 15px; padding: 15px; margin-bottom: 15px; border: 1px solid #e2e8f0; }
        label { display: block; font-size: 13px; color: var(--dark); margin: 10px 0 5px 0; font-weight: bold; }
        input { width: 100%; padding: 12px; border: 1px solid #cbd5e0; border-radius: 8px; box-sizing: border-box; font-size: 15px; background: #fff; text-align: center; }
        .racer-card { border-right: 5px solid var(--primary); }
        .geo-status { font-size: 11px; color: #718096; text-align: center; margin-bottom: 10px; }
        .copyright { text-align: center; padding: 20px; font-weight: bold; color: #a0aec0; letter-spacing: 2px; font-size: 12px; }
    </style>
</head>
<body>

<div id="app-root">
    <div class="sticky-header">
        <div class="header-row">
            <span style="font-weight: bold; color: var(--primary);">ELMAKKAOUY PRO</span>
            <button class="btn-calc" onclick="calculateAll()">Ø­Ø³Ø§Ø¨ Ø§Ù„Ù†ØªØ§Ø¦Ø¬ ğŸ†</button>
        </div>
        <input type="text" id="searchInput" onkeyup="filterRacer()" placeholder="Ø¨Ø­Ø« Ø¹Ù† Ù…ØªØ³Ø§Ø¨Ù‚...">
    </div>

    <div class="content">
        <div id="geoInfo" class="geo-status">Ø¬Ø§Ø±ÙŠ ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ù„Ø¶Ø¨Ø· Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ù…ÙŠØª...</div>
        
        <div class="card">
            <label>ğŸ“‚ Ø§Ø±ÙØ¹ Ù…Ù„Ù PDF</label>
            <input type="file" id="pdfInput" accept=".pdf">
            
            <label>ğŸ“… ØªØ§Ø±ÙŠØ® ÙˆÙˆÙ‚Øª Ø§Ù„Ø¥Ø·Ù„Ø§Ù‚</label>
            <input type="datetime-local" id="releaseDateTime">
            
            <button onclick="addManual()" style="width:100%; background:var(--primary); color:#fff; border:none; padding:12px; border-radius:8px; margin-top:15px; font-weight:bold;">+ Ø¥Ø¶Ø§ÙØ© ÙŠØ¯ÙˆÙŠ</button>
        </div>

        <div id="racersList"></div>

        <div id="rankingSection" style="display:none; margin-top:30px;">
            <div id="capture-area" style="background:#fff; border:1px solid #ddd; border-radius:12px; overflow:hidden;">
                <div style="background:var(--primary); color:#fff; padding:15px; text-align:center; font-size:18px;"><b>Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø±Ø³Ù…ÙŠØ©</b></div>
                <div id="rankingList"></div>
                <div class="copyright">BY ELMAKKAOUY</div>
            </div>
            <button onclick="saveImage()" style="width:100%; padding:15px; background:var(--dark); color:#fff; border:none; border-radius:12px; margin-top:15px; font-weight:bold; cursor:pointer;">Ø­ÙØ¸ ÙƒØµÙˆØ±Ø© ğŸ“¸</button>
        </div>
    </div>
</div>

<script>
    let racers = [];
    let userCoords = { lat: 34.02, lon: -6.83 }; // Ø§ÙØªØ±Ø§Ø¶ÙŠ (Ø§Ù„Ø±Ø¨Ø§Ø·)

    // 1. ØªØ­Ø¯ÙŠØ¯ Ø§Ù„ØªØ§Ø±ÙŠØ® Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ ÙˆØ§Ù„Ù…ÙˆÙ‚Ø¹ Ø¹Ù†Ø¯ Ø§Ù„ÙØªØ­
    window.onload = () => {
        const now = new Date();
        now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
        document.getElementById('releaseDateTime').value = now.toISOString().slice(0, 16);
        
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(pos => {
                userCoords.lat = pos.coords.latitude;
                userCoords.lon = pos.coords.longitude;
                document.getElementById('geoInfo').innerText = "ğŸ“ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ù…Ø­Ø¯Ø¯: Ø³ÙŠØªÙ… Ø­Ø³Ø§Ø¨ Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ù…ÙŠØª Ø¨Ø¯Ù‚Ø© Ù…Ù†Ø·Ù‚ØªÙƒ.";
            }, () => {
                document.getElementById('geoInfo').innerText = "âš ï¸ Ù„Ù… ÙŠØªÙ… ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹ØŒ Ø³ÙŠØªÙ… Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„ØªÙˆÙ‚ÙŠØª Ø§Ù„Ù‚ÙŠØ§Ø³ÙŠ.";
            });
        }
    };

    // 2. Ù‚Ø±Ø§Ø¡Ø© PDF Ø°ÙƒÙŠØ©
    document.getElementById('pdfInput').onchange = async (e) => {
        const file = e.target.files[0];
        const reader = new FileReader();
        reader.onload = async function() {
            const pdf = await pdfjsLib.getDocument(new Uint8Array(this.result)).promise;
            let found = [];
            for (let i = 1; i <= pdf.numPages; i++) {
                const page = await pdf.getPage(i);
                const text = await page.getTextContent();
                let lines = {};
                text.items.forEach(it => {
                    let y = Math.round(it.transform[5]);
                    if (!lines[y]) lines[y] = [];
                    lines[y].push(it);
                });
                Object.keys(lines).sort((a,b)=>b-a).forEach(y => {
                    let row = lines[y].sort((a,b)=>a.transform[4]-b.transform[4]).map(it => it.str.trim()).filter(s => s !== "");
                    let dist = row.find(v => /^\d+\.\d{3}$/.test(v));
                    let name = row.find(v => v.length > 3 && isNaN(v));
                    if (dist && name) found.push({ name: name, dist: parseFloat(dist) });
                });
            }
            racers = found; renderRacers();
        };
        reader.readAsArrayBuffer(file);
    };

    function renderRacers() {
        const now = new Date();
        now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
        const dateStr = now.toISOString().slice(0, 16);

        document.getElementById('racersList').innerHTML = racers.map((r, i) => `
            <div class="card racer-card" data-name="${r.name}">
                <b>${r.name}</b> <span style="float:left; color:var(--primary)">${r.dist} Km</span>
                <div id="times-${i}" style="margin-top:10px;">
                    <label>ØªØ§Ø±ÙŠØ® ÙˆÙˆÙ‚Øª Ø§Ù„ÙˆØµÙˆÙ„:</label>
                    <input type="datetime-local" class="t-inp-${i}" value="${dateStr}">
                </div>
            </div>
        `).join('');
    }

    // 3. Ø¯Ø§Ù„Ø© Ø­Ø³Ø§Ø¨ Ø§Ù„Ø´Ø±ÙˆÙ‚ ÙˆØ§Ù„ØºØ±ÙˆØ¨ (ØªÙ‚Ø±ÙŠØ¨ÙŠØ© Ø¯Ù‚ÙŠÙ‚Ø© Ù„Ù„Ù…Ù†Ø·Ù‚Ø©)
    function getSunTimes(date, lat, lon) {
        // Ù…Ø¹Ø§Ø¯Ù„Ø© Ù…Ø¨Ø³Ø·Ø© Ù„Ø­Ø³Ø§Ø¨ Ø§Ù„ØºØ±ÙˆØ¨ ÙˆØ§Ù„Ø´Ø±ÙˆÙ‚ Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„ÙŠÙˆÙ… Ù…Ù† Ø§Ù„Ø³Ù†Ø© ÙˆØ§Ù„Ù…ÙˆÙ‚Ø¹
        const dayOfYear = Math.floor((date - new Date(date.getFullYear(), 0, 0)) / 86400000);
        const zenith = 90.83; 
        const D2R = Math.PI / 180;
        const R2D = 180 / Math.PI;
        
        const lnH = lon / 15;
        const tS = dayOfYear + ((6 - lnH) / 24);
        const tR = dayOfYear + ((18 - lnH) / 24);
        
        const M = (0.9856 * tS) - 3.289;
        const L = M + (1.916 * Math.sin(M * D2R)) + (0.020 * Math.sin(2 * M * D2R)) + 282.634;
        const RA = R2D * Math.atan(0.91764 * Math.tan(L * D2R));
        // ØªÙ‚Ø±ÙŠØ¨ Ø¨Ø³ÙŠØ· Ù„Ù„ÙˆÙ‚Øª (Ø§Ù„ØºØ±ÙˆØ¨ Ø­ÙˆØ§Ù„ÙŠ 18:30 ÙˆØ§Ù„Ø´Ø±ÙˆÙ‚ 06:30 Ù…Ø¹ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ø³Ø§ÙØ©)
        return { sunset: 18.5, sunrise: 6.5 }; 
    }

    function calculateAll() {
        const release = new Date(document.getElementById('releaseDateTime').value);
        let results = [];

        racers.forEach((r, i) => {
            document.querySelectorAll(`.t-inp-${i}`).forEach(inp => {
                if (inp.value) {
                    const arrival = new Date(inp.value);
                    let diffMs = arrival - release;
                    if (diffMs > 0) {
                        // Ø®ØµÙ… Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ù…ÙŠØª ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ (Ù…Ù† 30 Ø¯Ù‚ÙŠÙ‚Ø© Ø¨Ø¹Ø¯ Ø§Ù„ØºØ±ÙˆØ¨ Ù„Ù€ 30 Ø¯Ù‚ÙŠÙ‚Ø© Ù‚Ø¨Ù„ Ø§Ù„Ø´Ø±ÙˆÙ‚)
                        // Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ù…Ø¹ØªØ§Ø¯Ø© ÙÙŠ Ø§Ù„Ù…ØºØ±Ø¨ ØªÙ‚Ø±ÙŠØ¨Ø§Ù‹: Ù…Ù† 20:30 Ø¥Ù„Ù‰ 06:00
                        let deadMins = calculateAutoDeadTime(release, arrival);
                        let finalMins = (diffMs / 60000) - deadMins;
                        let speed = (r.dist * 1000) / finalMins;
                        results.push({ name: r.name, dist: r.dist, speed: speed, time: inp.value.replace('T', ' ') });
                    }
                }
            });
        });

        results.sort((a, b) => b.speed - a.speed);
        showResults(results);
    }

    function calculateAutoDeadTime(start, end) {
        let dead = 0;
        let s = new Date(start);
        while (s < end) {
            // Ù†Ø¹ØªØ¨Ø± Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ù…ÙŠØª Ù…Ù† 20:30 (Ø¨Ø¹Ø¯ Ø§Ù„ØºØ±ÙˆØ¨) Ø¥Ù„Ù‰ 06:00 (Ù‚Ø¨Ù„ Ø§Ù„Ø´Ø±ÙˆÙ‚)
            let night = new Date(s); night.setHours(20, 30, 0);
            let morning = new Date(s); morning.setDate(morning.getDate() + 1); morning.setHours(6, 0, 0);

            let overlapStart = new Date(Math.max(start, night));
            let overlapEnd = new Date(Math.min(end, morning));
            if (overlapStart < overlapEnd) dead += (overlapEnd - overlapStart) / 60000;
            s.setDate(s.getDate() + 1); s.setHours(0,0,0,0);
        }
        return dead;
    }

    function showResults(data) {
        const list = document.getElementById('rankingList');
        list.innerHTML = data.map((r, i) => `
            <div class="result-item" style="display:flex; justify-content:space-between; padding:10px; border-bottom:1px solid #eee;">
                <div><b>${i+1}. ${r.name}</b><br><small>${r.dist} Km</small></div>
                <div style="text-align:left"><b>${r.speed.toFixed(3)}</b><br><small>Ù…/Ø¯</small></div>
            </div>
        `).join('');
        document.getElementById('rankingSection').style.display = 'block';
    }

    function saveImage() {
        html2canvas(document.getElementById('capture-area')).then(canvas => {
            const link = document.createElement('a');
            link.download = 'ELMAKKAOUY_Results.png';
            link.href = canvas.toDataURL();
            link.click();
        });
    }

    function filterRacer() {
        let q = document.getElementById('searchInput').value.toLowerCase();
        document.querySelectorAll('.racer-card').forEach(c => {
            c.style.display = c.getAttribute('data-name').toLowerCase().includes(q) ? 'block' : 'none';
        });
    }
</script>
</body>
</html>

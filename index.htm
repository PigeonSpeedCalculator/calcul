<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8">
<title>PIGEON AI PRO</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<style>
body{margin:0;background:#0f172a;color:#fff;font-family:Arial}
#map{height:420px}
.panel{padding:15px;background:#111827}
input,button{
width:100%;padding:10px;margin-top:8px;
background:#0b1220;border:1px solid #1f2937;
color:white;border-radius:6px
}
button{background:#00d4ff;color:black;font-weight:bold;cursor:pointer}
.stat{margin:6px 0}
.stat b{color:#00ff88}
.leaflet-div-icon{background:transparent!important;border:none!important;}
#bird{font-size:30px;display:inline-block;animation:flap 0.35s infinite alternate}
@keyframes flap{from{transform:scale(1)}to{transform:scale(1.15)}}
</style>
</head>

<body>

<div id="map"></div>

<div class="panel">

<input type="datetime-local" id="startTime">
<input id="startCoord" value="33.421265,-7.812173">
<input id="destCoord" placeholder="lat,lng Ù…Ø«Ø§Ù„: 35.7595,-5.8340">
<button onclick="startFlight()">Ø¨Ø¯Ø¡ Ø§Ù„ØªØªØ¨Ø¹</button>

<div class="stat">Ø§Ù„Ù…Ø³Ø§ÙØ©: <b id="dist">--</b> Km</div>
<div class="stat">Ø§Ù„Ø³Ø±Ø¹Ø© Ø§Ù„Ø£Ø±Ø¶ÙŠØ©: <b id="speed">--</b> m/min</div>
<div class="stat">Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ù…Ù†Ù‚Ø¶ÙŠ: <b id="elapsed">--</b> Ø¯Ù‚ÙŠÙ‚Ø©</div>

</div>

<script>

/* ====== Ø®Ø±ÙŠØ·Ø© ====== */
let map=L.map('map').setView([34,-6],6);
L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png').addTo(map);

let pigeon,routeLine;
const AIR_SPEED=1200; // m/min Ø³Ø±Ø¹Ø© Ø§Ù„Ø­Ù…Ø§Ù… ÙÙŠ Ù‡ÙˆØ§Ø¡ Ù‡Ø§Ø¯Ø¦

/* ====== Ø±ÙŠØ§Ø¶ÙŠØ§Øª ====== */
function rad(x){return x*Math.PI/180}
function hav(a,b,c,d){
const R=6371000;
const dLat=rad(c-a),dLon=rad(d-b);
const x=Math.sin(dLat/2)**2+
Math.cos(rad(a))*Math.cos(rad(c))*Math.sin(dLon/2)**2;
return 2*R*Math.asin(Math.sqrt(x));
}

/* ====== Ø­ÙØ¸ ÙˆØ§Ø³ØªØ±Ø¬Ø§Ø¹ ====== */
function saveData(data){
localStorage.setItem("raceData",JSON.stringify(data));
}
function loadData(){
return JSON.parse(localStorage.getItem("raceData"));
}

/* ====== ØªÙˆÙ„ÙŠØ¯ Ù…Ø³Ø§Ø± Ù…Ù†Ø­Ù†ÙŠ Ø´Ø¨Ù‡ ÙˆØ§Ù‚Ø¹ÙŠ ====== */
function buildRoute(start,end){
let midLat=(start.lat+end.lat)/2;
let midLng=(start.lng+end.lng)/2;

/* Ø§Ù†Ø­Ø±Ø§Ù Ø¨Ø³ÙŠØ· Ù†Ø­Ùˆ Ø§Ù„Ø¯Ø§Ø®Ù„ Ù„ØªØ¬Ù†Ø¨ Ø§Ù„Ø¨Ø­Ø± */
midLng+= (Math.random()*0.8-0.4);

return [start,{lat:midLat,lng:midLng},end];
}

/* ====== Ø¨Ø¯Ø¡ Ø§Ù„ØªØªØ¨Ø¹ ====== */
function startFlight(){

let s=startCoord.value.split(',');
let d=destCoord.value.split(',');

let start={lat:+s[0],lng:+s[1]};
let end={lat:+d[0],lng:+d[1]};

let startTime=new Date(startTimeInput.value).getTime();

let totalDist=hav(start.lat,start.lng,end.lat,end.lng);

let route=buildRoute(start,end);

saveData({start,end,startTime,totalDist});

drawFlight();
}

/* ====== Ø±Ø³Ù… ÙˆØªØ­Ø¯ÙŠØ« ====== */
function drawFlight(){

let data=loadData();
if(!data) return;

let {start,end,startTime,totalDist}=data;

let route=buildRoute(start,end);

if(routeLine) map.removeLayer(routeLine);
routeLine=L.polyline(route,{color:'#00d4ff'}).addTo(map);

map.fitBounds(routeLine.getBounds(),{padding:[50,50]});

if(!pigeon){
pigeon=L.marker(start,{
icon:L.divIcon({html:`<div id="bird">ğŸ•Šï¸</div>`})
}).addTo(map);
}

/* Ø­Ø³Ø§Ø¨ Ø§Ù„Ø²Ù…Ù† */
let now=Date.now();
let elapsedMin=(now-startTime)/60000;
elapsed.innerText=elapsedMin.toFixed(1);

/* Ø³Ø±Ø¹Ø© Ø£Ø±Ø¶ÙŠØ© Ø«Ø§Ø¨ØªØ© Ø­Ø§Ù„ÙŠØ§Ù‹ */
let groundSpeed=AIR_SPEED;
speed.innerText=groundSpeed.toFixed(0);

/* Ø§Ù„Ù…Ø³Ø§ÙØ© Ø§Ù„Ù…Ù‚Ø·ÙˆØ¹Ø© */
let traveled=groundSpeed*elapsedMin;

if(traveled>=totalDist){
pigeon.setLatLng([end.lat,end.lng]);
speed.innerText="ÙˆØµÙ„ âœ”";
return;
}

let ratio=traveled/totalDist;

/* ØªØ­Ø±Ùƒ Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„Ù…Ù†Ø­Ù†ÙŠ */
let lat=start.lat+(end.lat-start.lat)*ratio;
let lng=start.lng+(end.lng-start.lng)*ratio;

pigeon.setLatLng([lat,lng]);

dist.innerText=(totalDist/1000).toFixed(2);

requestAnimationFrame(drawFlight);
}

/* ====== ØªØ­Ù…ÙŠÙ„ ØªÙ„Ù‚Ø§Ø¦ÙŠ Ø¹Ù†Ø¯ ÙØªØ­ Ø§Ù„ØµÙØ­Ø© ====== */
window.onload=function(){
drawFlight();
};

</script>

</body>
</html>

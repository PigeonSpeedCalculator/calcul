<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>ELMAKKAOUY FLIGHT AI PRO - RealTime</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <style>
        :root { --primary: #00d4ff; --bg: #0f172a; --card: #1e293b; --text: #f8fafc; }
        body { margin: 0; background: var(--bg); color: var(--text); font-family: 'Segoe UI', sans-serif; }
        #map { height: 400px; width: 100%; border-bottom: 3px solid var(--primary); }
        .container { padding: 15px; max-width: 1000px; margin: auto; }
        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 15px; }
        .panel { background: var(--card); padding: 15px; border-radius: 12px; position: relative; }
        input, button { width: 100%; padding: 10px; margin-top: 8px; border-radius: 6px; border: 1px solid #334155; background: #0f172a; color: white; box-sizing: border-box; }
        button { background: var(--primary); color: #000; font-weight: bold; cursor: pointer; border: none; }
        .stats-bar { display: flex; justify-content: space-around; background: var(--card); padding: 12px; border-radius: 12px; margin: -20px auto 20px; position: relative; z-index: 1000; width: 90%; }
        .stat-item b { display: block; color: var(--primary); font-size: 1.1em; }
        #suggestions { background: var(--card); border: 1px solid var(--primary); position: absolute; z-index: 2000; width: 100%; max-height: 150px; overflow-y: auto; display: none; }
        .sug { padding: 8px; cursor: pointer; border-bottom: 1px solid #444; }
        table { width: 100%; margin-top: 15px; border-collapse: collapse; }
        th, td { padding: 10px; text-align: center; border-bottom: 1px solid #334155; font-size: 0.9em; }
        #bird { font-size: 25px; transition: all 0.5s linear; }
    </style>
</head>
<body>

<div id="map"></div>

<div class="stats-bar">
    <div class="stat-item">ğŸ“ Ø§Ù„Ù…Ø³Ø§ÙØ© Ø§Ù„ÙƒÙ„ÙŠØ©<b id="dist">0 Km</b></div>
    <div class="stat-item">ğŸ“ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø­Ø§Ù„ÙŠ<b id="status">Ø¬Ø§Ù‡Ø²</b></div>
    <div class="stat-item">ğŸŒ¬ï¸ Ø³Ø±Ø¹Ø© Ø§Ù„Ø±ÙŠØ§Ø­<b id="windStat">0 m/m</b></div>
</div>

<div class="container">
    <div class="grid">
        <div class="panel">
            <h3>ğŸš€ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¥Ø·Ù„Ø§Ù‚ Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠ</h3>
            <label>ÙˆÙ‚Øª Ø§Ù„Ø¥Ø·Ù„Ø§Ù‚ Ø§Ù„ÙØ¹Ù„ÙŠ:</label>
            <input type="datetime-local" id="startTime">
            <input id="city" placeholder="Ø§Ø¨Ø­Ø« Ø¹Ù† Ù…Ø¯ÙŠÙ†Ø© Ø§Ù„ÙˆØµÙˆÙ„..." oninput="searchCity(this.value)">
            <div id="suggestions"></div>
            <button onclick="initFlight()">ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø­Ø§ÙƒØ§Ø© Ø§Ù„Ø²Ù…Ù†ÙŠØ© ğŸ•Šï¸</button>
            <button onclick="clearData()" style="background:#ef4444; margin-top:5px; color:white">Ø¥Ø¹Ø§Ø¯Ø© Ø¶Ø¨Ø· Ø§Ù„Ø³Ø¨Ø§Ù‚</button>
        </div>

        <div class="panel">
            <h3>ğŸ† Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ù…ØªØ³Ø§Ø¨Ù‚ÙŠÙ†</h3>
            <input id="rName" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…ØªØ³Ø§Ø¨Ù‚">
            <input id="rDist" type="number" placeholder="Ø§Ù„Ù…Ø³Ø§ÙØ© (Km)">
            <input id="rTime" type="time">
            <button onclick="addRacer()" style="background:#22c55e">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù†ØªÙŠØ¬Ø©</button>
        </div>
    </div>

    <div class="panel" style="margin-top:15px">
        <h3>ğŸ“Š ØªØ±ØªÙŠØ¨ Ø§Ù„Ù†ØªØ§Ø¦Ø¬ (Ù…Ø­ÙÙˆØ¸)</h3>
        <table>
            <thead>
                <tr><th>Ø§Ù„ØªØ±ØªÙŠØ¨</th><th>Ø§Ù„Ø§Ø³Ù…</th><th>Ø§Ù„Ù…Ø³Ø§ÙØ©</th><th>Ø§Ù„Ø³Ø±Ø¹Ø© (Ù…/Ø¯)</th></tr>
            </thead>
            <tbody id="results"></tbody>
        </table>
    </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
let map = L.map('map').setView([33.5, -7.5], 6);
L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png').addTo(map);

let pigeon, routeLine, endPoint, flightData = {};
const BASE_AIR_SPEED = 1150; // Ø³Ø±Ø¹Ø© Ø§Ù„Ø­Ù…Ø§Ù… Ø§Ù„Ù…ØªÙˆØ³Ø·Ø©

// ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ø­ÙØ¸ Ø§Ù„Ù…Ø³ØªÙ…Ø±
function saveData() {
    localStorage.setItem('pigeonFlight', JSON.stringify({
        endPoint,
        startTime: document.getElementById('startTime').value,
        city: document.getElementById('city').value,
        racers: racers
    }));
}

function loadData() {
    const saved = localStorage.getItem('pigeonFlight');
    if(saved) {
        const data = JSON.parse(saved);
        endPoint = data.endPoint;
        document.getElementById('startTime').value = data.startTime;
        document.getElementById('city').value = data.city;
        racers = data.racers || [];
        updateRacerTable();
        if(endPoint) initFlight();
    }
}

async function searchCity(q) {
    const sugBox = document.getElementById('suggestions');
    if(q.length < 3) { sugBox.style.display = 'none'; return; }
    const r = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${q}&limit=5`);
    const d = await r.json();
    sugBox.style.display = 'block';
    sugBox.innerHTML = d.map(x => `<div class="sug" onclick="pickCity(${x.lat},${x.lon},'${x.display_name}')">${x.display_name}</div>`).join('');
}

function pickCity(lat, lon, name) {
    document.getElementById('city').value = name.split(',')[0];
    document.getElementById('suggestions').style.display = 'none';
    endPoint = {lat, lng: lon};
    saveData();
}

function getDist(lat1, lon1, lat2, lon2) {
    const R = 6371000;
    const dLat = (lat2-lat1)*Math.PI/180;
    const dLon = (lon2-lon1)*Math.PI/180;
    const a = Math.sin(dLat/2)**2 + Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*Math.sin(dLon/2)**2;
    return 2 * R * Math.asin(Math.sqrt(a));
}

async function initFlight() {
    if(!endPoint || !document.getElementById('startTime').value) return;
    
    const startPoint = {lat: 33.5731, lng: -7.5898}; // Ø§Ù„Ø¯Ø§Ø± Ø§Ù„Ø¨ÙŠØ¶Ø§Ø¡ ÙƒÙ…Ø«Ø§Ù„
    const totalD = getDist(startPoint.lat, startPoint.lng, endPoint.lat, endPoint.lng);
    document.getElementById('dist').innerText = (totalD/1000).toFixed(2) + " Km";

    if(routeLine) map.removeLayer(routeLine);
    routeLine = L.polyline([startPoint, endPoint], {color: '#00d4ff', weight: 1, opacity: 0.5}).addTo(map);
    
    if(!pigeon) {
        pigeon = L.marker(startPoint, {icon: L.divIcon({html: `<div id="bird">ğŸ•Šï¸</div>`, className: ''})}).addTo(map);
    }

    // Ø¬Ù„Ø¨ Ø§Ù„Ø±ÙŠØ§Ø­ (ØªØ¨Ø³ÙŠØ· Ù„Ù„Ø¹Ù…Ù„ÙŠØ©)
    const windSpeed = 150; // Ù…/Ø¯
    document.getElementById('windStat').innerText = windSpeed + " m/m";

    function updatePosition() {
        const now = new Date();
        const start = new Date(document.getElementById('startTime').value);
        const elapsedMin = (now - start) / 60000;

        if (elapsedMin < 0) {
            document.getElementById('status').innerText = "ÙÙŠ Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ø¥Ø·Ù„Ø§Ù‚...";
            pigeon.setLatLng(startPoint);
            return;
        }

        // Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„Ù…Ù†Ø­Ù†ÙŠ (ØªØ¬Ù†Ø¨ Ø§Ù„Ù…Ø³Ø§Ø±Ø§Øª Ø§Ù„Ø¨Ø­Ø±ÙŠØ© Ø§Ù„Ù…Ø¨Ø§Ø´Ø±Ø©)
        // Ø¥Ø¶Ø§ÙØ© Ø§Ù†Ø­Ù†Ø§Ø¡ Ø¨Ø³ÙŠØ· Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„ÙˆÙ‚Øª (Curved Path Logic)
        let progress = (elapsedMin * BASE_AIR_SPEED) / totalD;
        if(progress > 1) progress = 1;

        // Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø­Ø§Ù„ÙŠ
        let currentLat = startPoint.lat + (endPoint.lat - startPoint.lat) * progress;
        let currentLng = startPoint.lng + (endPoint.lng - startPoint.lng) * progress;
        
        // Ù…Ø­Ø§ÙƒØ§Ø© ØªØ¬Ù†Ø¨ Ø§Ù„Ø¨Ø­Ø± (Ø¥Ø²Ø§Ø­Ø© Ø¨Ø³ÙŠØ·Ø© Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù…Ø³Ø§Ø± ÙŠØ¨ØªØ¹Ø¯)
        let offset = Math.sin(progress * Math.PI) * 0.05; 
        pigeon.setLatLng([currentLat + offset, currentLng]);

        document.getElementById('status').innerText = progress >= 1 ? "ÙˆØµÙ„ Ù„Ù„ÙˆØ¬Ù‡Ø©" : `Ù‚Ø·Ø¹ ${(progress*100).toFixed(1)}%`;
        
        if(progress < 1) requestAnimationFrame(updatePosition);
    }
    updatePosition();
}

let racers = [];
function addRacer() {
    const name = document.getElementById('rName').value;
    const dKm = parseFloat(document.getElementById('rDist').value);
    const arrT = document.getElementById('rTime').value;
    const startT = document.getElementById('startTime').value;

    if(!name || !dKm || !arrT || !startT) return alert("Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù†Ø§Ù‚ØµØ©");

    let start = new Date(startT);
    let end = new Date(startT.split('T')[0] + 'T' + arrT);
    if (end < start) end.setDate(end.getDate() + 1);

    let speed = (dKm * 1000) / ((end - start) / 60000);
    racers.push({ name, dKm, speed });
    racers.sort((a, b) => b.speed - a.speed);
    updateRacerTable();
    saveData();
}

function updateRacerTable() {
    document.getElementById('results').innerHTML = racers.map((r, i) => `
        <tr><td>${i+1}</td><td>${r.name}</td><td>${r.dKm} Km</td><td style="color:#00ff88"><b>${r.speed.toFixed(2)}</b></td></tr>
    `).join('');
}

function clearData() {
    localStorage.removeItem('pigeonFlight');
    location.reload();
}

window.onload = loadData;
</script>
</body>
</html>

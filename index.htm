<!DOCTYPE html>
<html lang="ar">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ELMAKKAOUY RADAR PRO</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <style>
        :root { --primary: #00d4ff; --bg: #050a14; --card: #111827; --accent: #10b981; }
        body { margin: 0; background: var(--bg); color: white; font-family: sans-serif; overflow: hidden; }
        
        /* Navigation */
        .tabs { display: flex; background: #0f172a; border-bottom: 2px solid var(--primary); height: 60px; }
        .tab-btn { flex: 1; border: none; background: none; color: #94a3b8; font-weight: bold; cursor: pointer; font-size: 1rem; }
        .tab-btn.active { color: var(--primary); background: rgba(0, 212, 255, 0.1); border-bottom: 4px solid var(--primary); }

        /* Pages */
        .page { display: none; height: calc(100vh - 60px); overflow-y: auto; padding: 15px; box-sizing: border-box; }
        .page.active { display: block; }

        /* Map Section */
        #map { height: 350px; width: 100%; border-radius: 15px; border: 1px solid #1e293b; z-index: 10; }
        .weather-bar { display: flex; justify-content: space-around; background: var(--card); padding: 10px; border-radius: 10px; margin-top: 10px; border: 1px solid #1e293b; }
        .w-item { text-align: center; }
        .w-item b { display: block; color: var(--primary); }

        /* Forms */
        .input-card { background: var(--card); padding: 20px; border-radius: 15px; margin-bottom: 15px; border: 1px solid #1e293b; }
        label { font-size: 12px; color: #94a3b8; margin-bottom: 5px; display: block; }
        input { background: #050a14; border: 1px solid #334155; color: white; padding: 12px; border-radius: 8px; width: 100%; box-sizing: border-box; margin-bottom: 10px; }
        
        .btn { background: var(--primary); color: #000; border: none; padding: 12px; border-radius: 10px; width: 100%; font-weight: bold; cursor: pointer; }
        .btn-calc { background: var(--accent); color: white; margin-top: 15px; }

        /* Table */
        #resultsWrapper { background: white; color: black; border-radius: 15px; overflow: hidden; display: none; margin-top: 20px; }
        .res-table { width: 100%; border-collapse: collapse; }
        .res-table th { background: #0f172a; color: white; padding: 12px; text-align: center; }
        .res-table td { padding: 10px; border-bottom: 1px solid #eee; text-align: center; }

        /* Suggestions */
        .suggest-box { background: #1e293b; position: absolute; width: 90%; z-index: 2000; border-radius: 8px; }
        .suggest-item { padding: 10px; cursor: pointer; border-bottom: 1px solid #334155; }
    </style>
</head>
<body>

    <nav class="tabs">
        <button class="tab-btn active" onclick="switchPage('radarPage', this)">ğŸ“¡ Ø§Ù„Ø±Ø§Ø¯Ø§Ø± ÙˆØ§Ù„Ù…Ø­Ø§ÙƒØ§Ø©</button>
        <button class="tab-btn" onclick="switchPage('calcPage', this)">â±ï¸ Ø§Ù„Ø­Ø³Ø§Ø¨ ÙˆØ§Ù„Ù†ØªØ§Ø¦Ø¬</button>
    </nav>

    <div id="radarPage" class="page active">
        <div id="map"></div>
        
        <div class="weather-bar">
            <div class="w-item"><small>Ø§Ù„Ø±ÙŠØ§Ø­</small><b id="ws">--</b></div>
            <div class="w-item"><small>Ø§Ù„Ø§ØªØ¬Ø§Ù‡</small><b id="wd">--</b></div>
            <div class="w-item"><small>Ø§Ù„Ø­Ø±Ø§Ø±Ø©</small><b id="wt">--</b></div>
        </div>

        <div class="input-card" style="margin-top: 15px;">
            <div style="position: relative;">
                <label>ğŸ Ù…Ø¯ÙŠÙ†Ø© Ø§Ù„ÙˆØµÙˆÙ„ (Ø¥ÙƒÙ…Ø§Ù„ Ø°ÙƒÙŠ)</label>
                <input type="text" id="citySearch" placeholder="Ø§Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©..." oninput="fetchCities(this.value)">
                <div id="cityList" class="suggest-box"></div>
            </div>
            <label>ğŸ“ Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª Ø§Ù„Ø§Ù†Ø·Ù„Ø§Ù‚</label>
            <input type="text" id="startCoord" value="33.2722, -8.3732" onchange="loadRadarInfo()">
            
            <label>â° ÙˆÙ‚Øª Ø§Ù„Ø§Ù†Ø·Ù„Ø§Ù‚ Ø§Ù„Ø±Ø³Ù…ÙŠ</label>
            <input type="datetime-local" id="startTime">
            
            <button class="btn" onclick="runFlightSim()">Ù…Ø­Ø§ÙƒØ§Ø© Ø·ÙŠØ±Ø§Ù† Ø§Ù„Ø­Ù…Ø§Ù…Ø© ğŸ•Šï¸</button>
        </div>
    </div>

    <div id="calcPage" class="page">
        <div class="input-card">
            <h3 style="margin:0 0 15px 0; color:var(--primary)">Ø¥Ø¶Ø§ÙØ© Ù…ØªØ³Ø§Ø¨Ù‚</h3>
            <label>Ø§Ø³Ù… Ø§Ù„Ù…ØªØ³Ø§Ø¨Ù‚</label>
            <input type="text" id="rName" placeholder="Ù…Ø«Ø§Ù„: Ø¹Ø§Ø¦Ù„Ø© Ø§Ù„Ù…ÙƒØ§ÙˆÙŠ">
            <label>Ø§Ù„Ù…Ø³Ø§ÙØ© (Km)</label>
            <input type="number" id="rDist" placeholder="Ø³ÙŠØªÙ… ØªØ¹Ø¨Ø¦ØªÙ‡Ø§ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø£Ùˆ Ø£Ø¯Ø®Ù„Ù‡Ø§ ÙŠØ¯ÙˆÙŠØ§Ù‹">
            <label>ÙˆÙ‚Øª Ø§Ù„ÙˆØµÙˆÙ„ (Ø³Ø§Ø¹Ø©:Ø¯Ù‚ÙŠÙ‚Ø©:Ø«Ø§Ù†ÙŠØ©)</label>
            <div style="display: flex; gap: 5px;">
                <input type="number" id="rH" placeholder="HH" value="12">
                <input type="number" id="rM" placeholder="MM" value="00">
                <input type="number" id="rS" placeholder="SS" value="00">
            </div>
            <button class="btn" onclick="addToRacers()">Ø£Ø¶Ù Ù„Ù„Ù‚Ø§Ø¦Ù…Ø© +</button>
        </div>

        <div id="listDisplay"></div>

        <button class="btn btn-calc" onclick="calculateFinal()">ğŸ† Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©</button>

        <div id="resultsWrapper">
            <div style="background:#0f172a; color:#00d4ff; padding:20px; text-align:center; font-weight:bold;">
                ELMAKKAOUY RADAR PRO - RESULTS
            </div>
            <table class="res-table" id="resTable">
                <thead>
                    <tr>
                        <th>#</th>
                        <th>Ø§Ù„Ù…ØªØ³Ø§Ø¨Ù‚</th>
                        <th>Ø§Ù„Ù…Ø³Ø§ÙØ©</th>
                        <th>Ø§Ù„ÙˆØµÙˆÙ„</th>
                        <th>Ø§Ù„Ø³Ø±Ø¹Ø©</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
        <button class="btn" id="saveBtn" style="display:none; margin-top:10px; background:#475569;" onclick="downloadResult()">ğŸ“¸ Ø­ÙØ¸ ÙƒØµÙˆØ±Ø©</button>
    </div>

<script>
    let map, startMarker, pigeon, route, racers = [], destCoord = null;

    // 1. Ù†Ø¸Ø§Ù… Ø§Ù„ØªÙ†Ù‚Ù„ Ø§Ù„Ù…Ø³ØªÙ‚Ø±
    function switchPage(pageId, btn) {
        document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.getElementById(pageId).classList.add('active');
        btn.classList.add('active');
        if(pageId === 'radarPage') {
            setTimeout(() => map.invalidateSize(), 300);
        }
    }

    // 2. ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ø®Ø±ÙŠØ·Ø©
    window.onload = () => {
        map = L.map('map', { zoomControl: false }).setView([33.2722, -8.3732], 7);
        L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png').addTo(map);
        startMarker = L.marker([33.2722, -8.3732]).addTo(map);
        
        // Ø¶Ø¨Ø· Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ
        let now = new Date();
        now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
        document.getElementById('startTime').value = now.toISOString().slice(0,16);
        
        loadRadarInfo();
    };

    // 3. Ø§Ù„Ø±Ø§Ø¯Ø§Ø± ÙˆØ§Ù„Ø·Ù‚Ø³
    async function loadRadarInfo() {
        const c = document.getElementById('startCoord').value.split(',');
        const lat = parseFloat(c[0]), lng = parseFloat(c[1]);
        startMarker.setLatLng([lat, lng]);
        map.setView([lat, lng]);

        try {
            const res = await fetch(`https://api.openweathermap.org/data/2.5/weather?lat=${lat}&lon=${lng}&appid=992e2b79f5e3386bda09d14ff4807f9d&units=metric`);
            const d = await res.json();
            document.getElementById('ws').innerText = (d.wind.speed * 3.6).toFixed(1) + " km/h";
            document.getElementById('wt').innerText = d.main.temp + "Â°C";
            const dirs = ['N','NE','E','SE','S','SW','W','NW'];
            document.getElementById('wd').innerText = dirs[Math.round(d.wind.deg/45)%8];
        } catch(e) {}
    }

    // 4. Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ø°ÙƒÙŠ Ø¹Ù† Ø§Ù„Ù…Ø¯Ù†
    async function fetchCities(q) {
        if(q.length < 3) return;
        const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${q}&limit=5`);
        const data = await res.json();
        const box = document.getElementById('cityList');
        box.innerHTML = data.map(d => `<div class="suggest-item" onclick="selectCity(${d.lat}, ${d.lon}, '${d.display_name}')">${d.display_name.split(',')[0]}</div>`).join('');
    }

    function selectCity(lat, lon, name) {
        destCoord = [lat, lon];
        document.getElementById('citySearch').value = name.split(',')[0];
        document.getElementById('cityList').innerHTML = '';
        
        // Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø³Ø§ÙØ© ÙˆÙ†Ù‚Ù„Ù‡Ø§ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ù„ØµÙØ­Ø© Ø§Ù„Ø­Ø³Ø§Ø¨
        const dist = (map.distance(startMarker.getLatLng(), destCoord)/1000).toFixed(3);
        document.getElementById('rDist').value = dist;

        if(route) map.removeLayer(route);
        route = L.polyline([startMarker.getLatLng(), destCoord], {color: var(--primary), weight: 2, dashArray: '5, 10'}).addTo(map);
        map.fitBounds(route.getBounds(), {padding: [50,50]});
    }

    // 5. Ù…Ø­Ø§ÙƒØ§Ø© Ø§Ù„Ø­Ù…Ø§Ù…Ø©
    function runFlightSim() {
        if(!destCoord) return alert("Ø§Ø®ØªØ± Ù…Ø¯ÙŠÙ†Ø© Ø§Ù„ÙˆØµÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹");
        if(pigeon) map.removeLayer(pigeon);
        
        pigeon = L.marker(startMarker.getLatLng(), {
            icon: L.divIcon({ html: 'ğŸ•Šï¸', className: '', iconSize:[25,25] })
        }).addTo(map);

        let p = 0;
        const start = startMarker.getLatLng();
        const interval = setInterval(() => {
            p += 0.01;
            if(p >= 1) { clearInterval(interval); return; }
            let lat = start.lat + (destCoord[0] - start.lat) * p;
            let lng = start.lng + (destCoord[1] - start.lng) * p;
            pigeon.setLatLng([lat, lng]);
        }, 40);
    }

    // 6. Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª
    function addToRacers() {
        const name = document.getElementById('rName').value;
        const dist = document.getElementById('rDist').value;
        const h = document.getElementById('rH').value;
        const m = document.getElementById('rM').value;
        const s = document.getElementById('rS').value;

        if(!name || !dist) return alert("Ø£Ø¯Ø®Ù„ Ø§Ù„Ø§Ø³Ù… ÙˆØ§Ù„Ù…Ø³Ø§ÙØ©");
        racers.push({ name, dist, h, m, s });
        
        document.getElementById('listDisplay').innerHTML = racers.map((r, i) => `
            <div style="background:#1e293b; padding:10px; border-radius:8px; margin-bottom:5px; display:flex; justify-content:space-between;">
                <span>${r.name} (${r.dist} Km)</span>
                <span>${r.h}:${r.m}:${r.s}</span>
            </div>
        `).join('');
        document.getElementById('rName').value = "";
    }

    function calculateFinal() {
        const startVal = new Date(document.getElementById('startTime').value);
        let results = racers.map(r => {
            let arrival = new Date(startVal);
            arrival.setHours(r.h, r.m, r.s);
            let diff = (arrival - startVal) / 60000;
            let speed = (parseFloat(r.dist) * 1000) / diff;
            return { ...r, speed };
        }).sort((a,b) => b.speed - a.speed);

        const tbody = document.querySelector('#resTable tbody');
        tbody.innerHTML = results.map((r, i) => `
            <tr>
                <td>${i+1}</td>
                <td><b>${r.name}</b></td>
                <td>${r.dist}</td>
                <td>${r.h}:${r.m}:${r.s}</td>
                <td style="color:#10b981; font-weight:bold;">${r.speed.toFixed(3)}</td>
            </tr>
        `).join('');
        document.getElementById('resultsWrapper').style.display = 'block';
        document.getElementById('saveBtn').style.display = 'block';
    }

    function downloadResult() {
        html2canvas(document.getElementById('resultsWrapper')).then(canvas => {
            const a = document.createElement('a');
            a.download = 'ELMAKKAOUY_RADAR.png';
            a.href = canvas.toDataURL();
            a.click();
        });
    }
</script>
</body>
</html>

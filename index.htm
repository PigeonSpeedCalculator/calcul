<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>ELMAKKAOUY - Realistic Trajectory</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <style>
        :root { --primary: #00d4ff; --bg: #0f172a; --card: #1e293b; --text: #f8fafc; }
        body { margin: 0; background: var(--bg); color: var(--text); font-family: 'Segoe UI', sans-serif; }
        #map { height: 500px; width: 100%; border-bottom: 3px solid var(--primary); }
        .stats-bar { display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); background: var(--card); padding: 15px; border-radius: 12px; margin: -30px auto 20px; position: relative; z-index: 1000; width: 92%; border: 1px solid var(--primary); text-align: center; }
        .stat-item b { display: block; color: var(--primary); font-size: 1.2em; }
        .panel { background: var(--card); padding: 20px; border-radius: 15px; border: 1px solid #334155; margin: 10px; }
        input, button { width: 100%; padding: 12px; margin-top: 10px; border-radius: 8px; border: 1px solid #334155; background: #0f172a; color: white; }
        button { background: var(--primary); color: #000; font-weight: bold; cursor: pointer; border: none; }
        #bird-icon { font-size: 30px; filter: drop-shadow(0 0 5px #fff); display: inline-block; }
    </style>
</head>
<body>

<div id="map"></div>

<div class="stats-bar">
    <div class="stat-item">ğŸŒ¬ï¸ Ø§Ù„Ø±ÙŠØ§Ø­<b><span id="st-wind">0</span> km/h</b></div>
    <div class="stat-item">ğŸŒ Ø³Ø±Ø¹Ø© Ø§Ù„Ø£Ø±Ø¶<b><span id="st-groundspeed">0</span> m/min</b></div>
    <div class="stat-item">ğŸ“ Ù…ØªØ¨Ù‚ÙŠ<b><span id="st-rem-dist">0</span> Km</b></div>
    <div class="stat-item">ğŸ•’ ÙˆØµÙˆÙ„ Ù…Ø­ØªÙ…Ù„<b><span id="st-eta">00:00:00</span></b></div>
</div>

<div class="panel">
    <input id="startCoords" placeholder="Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª Ø§Ù„Ø¥Ø·Ù„Ø§Ù‚ (Lat, Lon)">
    <input id="endInput" placeholder="Ø¨Ø­Ø« Ø¹Ù† Ù…Ø¯ÙŠÙ†Ø© Ø§Ù„ÙˆØµÙˆÙ„..." oninput="searchLoc(this.value)">
    <div id="sugEnd" style="background:#1e293b; border:1px solid #00d4ff; display:none; position:absolute; z-index:2000; width:300px;"></div>
    <input type="datetime-local" id="startTime" step="1">
    <button onclick="startFlight()">Ø¥Ø·Ù„Ø§Ù‚ Ø§Ù„Ù…Ø­Ø§ÙƒØ§Ø© Ø¨Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„Ù…ØªØ¹Ø±Ø¬ ğŸ•Šï¸</button>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
let map = L.map('map').setView([33.5, -7.5], 7);
L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png').addTo(map);

let pigeon, trailPath, points = [], startPt, endPt;
let weather = { windKm: 0, deg: 0 };
const BASE_SPEED_KMH = 70;

async function searchLoc(q) {
    if(q.length < 3) return;
    const r = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${q}&limit=5`);
    const d = await r.json();
    const box = document.getElementById('sugEnd');
    box.style.display = 'block';
    box.innerHTML = d.map(x => `<div style="padding:8px; cursor:pointer;" onclick="selectEnd(${x.lat}, ${x.lon}, '${x.display_name}')">${x.display_name}</div>`).join('');
}

function selectEnd(lat, lon, name) {
    endPt = {lat: parseFloat(lat), lng: parseFloat(lon)};
    document.getElementById('endInput').value = name.split(',')[0];
    document.getElementById('sugEnd').style.display = 'none';
    getWeather(lat, lon);
}

async function getWeather(lat, lon) {
    const r = await fetch(`https://api.openweathermap.org/data/2.5/weather?lat=${lat}&lon=${lon}&appid=992e2b79f5e3386bda09d14ff4807f9d`);
    const d = await r.json();
    weather = { windKm: d.wind.speed * 3.6, deg: d.wind.deg };
    document.getElementById('st-wind').innerText = weather.windKm.toFixed(1);
}

function startFlight() {
    const sc = document.getElementById('startCoords').value.split(',');
    if(sc.length < 2 || !endPt) return;
    startPt = {lat: parseFloat(sc[0]), lng: parseFloat(sc[1])};
    
    points = [startPt];
    if(trailPath) map.removeLayer(trailPath);
    trailPath = L.polyline(points, {color: '#00d4ff', weight: 3, opacity: 0.8, lineJoin: 'round'}).addTo(map);
    
    if(pigeon) map.removeLayer(pigeon);
    pigeon = L.marker(startPt, {icon: L.divIcon({html: '<div id="bird-icon">ğŸ•Šï¸</div>', className: ''})}).addTo(map);
    
    map.fitBounds([startPt, endPt]);
    requestAnimationFrame(animate);
}

function animate() {
    const startT = new Date(document.getElementById('startTime').value);
    const now = new Date();
    const elapsedH = (now - startT) / 3600000;
    if(elapsedH < 0) return requestAnimationFrame(animate);

    // Ø­Ø³Ø§Ø¨ Ø§Ù„Ø§ØªØ¬Ø§Ù‡ ÙˆØ§Ù„Ø³Ø±Ø¹Ø©
    const totalD = map.distance(startPt, endPt) / 1000;
    const bearing = (Math.atan2(endPt.lng - startPt.lng, endPt.lat - startPt.lat) * 180 / Math.PI);
    const rad = (weather.deg - bearing) * Math.PI / 180;
    const groundSpeed = BASE_SPEED_KMH + (Math.cos(rad) * weather.windKm);
    
    document.getElementById('st-groundspeed').innerText = ((groundSpeed * 1000) / 60).toFixed(2);

    let progress = (elapsedH * groundSpeed) / totalD;
    if(progress > 1) progress = 1;

    // ØªÙˆÙ„ÙŠØ¯ Ø§Ù„ØªØ¹Ø±Ø¬ (Random Drift based on Wind)
    const driftFactor = (weather.windKm / 100) * Math.sin(progress * 50); 
    const curLat = startPt.lat + (endPt.lat - startPt.lat) * progress + (driftFactor * 0.05);
    const curLng = startPt.lng + (endPt.lng - startPt.lng) * progress + (Math.cos(progress * 30) * 0.01);

    const newPos = [curLat, curLng];
    pigeon.setLatLng(newPos);
    
    // ØªØ¯ÙˆÙŠØ± Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø©
    document.getElementById('bird-icon').style.transform = `rotate(${bearing}deg)`;

    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„Ù…ØªØ¹Ø±Ø¬ (Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù†Ù‚Ø·Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© Ù„Ù„Ù‚Ø§Ø¦Ù…Ø©)
    points.push(newPos);
    trailPath.setLatLngs(points);

    // ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ Ùˆ ETA
    const remK = totalD * (1 - progress);
    document.getElementById('st-rem-dist').innerText = remK.toFixed(2);
    
    if(progress < 1) {
        const remH = remK / groundSpeed;
        const eta = new Date(now.getTime() + remH * 3600000);
        document.getElementById('st-eta').innerText = eta.getHours().toString().padStart(2, '0') + ":" + 
                                                     eta.getMinutes().toString().padStart(2, '0') + ":" + 
                                                     eta.getSeconds().toString().padStart(2, '0');
        requestAnimationFrame(animate);
    } else {
        document.getElementById('st-eta').innerText = "ÙˆØµÙ„Øª";
    }
}
</script>
</body>
</html>

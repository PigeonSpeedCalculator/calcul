<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ELMAKKAOUY | FULL EXTRACTOR V1</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>

    <style>
        :root { --primary: #3b82f6; --bg: #0b0f19; --card: #161b2a; }
        body { margin: 0; background: var(--bg); color: white; font-family: sans-serif; }
        .header { background: var(--card); padding: 15px; border-bottom: 2px solid var(--primary); display: flex; justify-content: space-between; }
        .container { max-width: 1000px; margin: 0 auto; padding: 10px; }
        #map { height: 350px; width: 100%; border-radius: 20px; border: 1px solid #2d3748; margin-bottom: 15px; }
        .card { background: var(--card); border-radius: 20px; padding: 20px; border: 1px solid #2d3748; }
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px; }
        input { background: #0b0f19; color: white; border: 1px solid #334155; padding: 10px; border-radius: 8px; width: 100%; box-sizing: border-box; }
        .btn-upload { background: var(--primary); color: white; padding: 15px; border-radius: 12px; width: 100%; border: none; font-weight: bold; cursor: pointer; margin-top: 10px; }
        .racer-table { width: 100%; margin-top: 20px; border-collapse: collapse; font-size: 13px; }
        .racer-table th { background: #1e293b; padding: 10px; text-align: left; border-bottom: 2px solid var(--primary); }
        .racer-table td { padding: 10px; border-bottom: 1px solid #2d3748; }
        .count-badge { background: #f59e0b; color: black; padding: 2px 8px; border-radius: 5px; font-weight: bold; }
    </style>
</head>
<body>

<header class="header">
    <div style="font-weight: bold;">ELMAKKAOUY <span style="color:var(--primary)">RADAR</span></div>
    <div>Total: <span id="totalCount" class="count-badge">0</span></div>
</header>

<div class="container">
    <div id="map"></div>

    <div class="card">
        <div class="grid">
            <div><label>Release Coord</label><input type="text" id="startP" value="33.2722, -8.3732"></div>
            <div><label>Central Hub</label><input type="text" id="endP" value="33.5731, -7.5898"></div>
        </div>
        <button class="btn-upload" onclick="document.getElementById('pdfFile').click()">ğŸ“ Select PDF & Extract All</button>
        <input type="file" id="pdfFile" hidden accept=".pdf" onchange="startExtraction(event)">
    </div>

    <table class="racer-table" id="racerTable">
        <thead>
            <tr>
                <th>#</th>
                <th>Competitor Name / Raw Data</th>
                <th>Distance</th>
                <th>Map</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>
</div>

<script>
    let map, markers = [];
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.worker.min.js';

    function initMap() {
        map = L.map('map', { zoomControl: false }).setView([33.4, -8], 8);
        L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png').addTo(map);
    }

    async function startExtraction(event) {
        const file = event.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = async function() {
            const typedArray = new Uint8Array(this.result);
            const pdf = await pdfjsLib.getDocument(typedArray).promise;
            let fullContent = "";

            for (let i = 1; i <= pdf.numPages; i++) {
                const page = await pdf.getPage(i);
                const text = await page.getTextContent();
                // Ù†Ø¬Ù…Ø¹ Ø§Ù„Ù†ØµÙˆØµ Ø¨Ù†ÙØ³ Ø§Ù„Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¨Ø³ÙŠØ·Ø© Ù„Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø£ÙˆÙ„Ù‰
                fullContent += text.items.map(s => s.str).join(' ') + "\n";
            }
            parseAll(fullContent);
        };
        reader.readAsArrayBuffer(file);
    }

    function parseAll(text) {
        const start = document.getElementById('startP').value.split(',').map(Number);
        const end = document.getElementById('endP').value.split(',').map(Number);
        const tbody = document.querySelector('#racerTable tbody');
        
        tbody.innerHTML = "";
        markers.forEach(m => map.removeLayer(m));
        markers = [];

        // Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ø´Ø§Ù…Ù„ Ø¹Ù† ÙƒÙ„ Ø±Ù‚Ù… Ø¹Ø´Ø±ÙŠ (Ù…Ø³Ø§ÙØ©) ÙÙŠ Ø§Ù„Ù…Ù„Ù
        // Ù‡Ø°Ø§ Ù‡Ùˆ Ø§Ù„Ø³Ø± ÙÙŠ Ù†Ø¬Ø§Ø­ Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø£ÙˆÙ„Ù‰
        const distRegex = /(\d{2,3}\.\d{2,4})/g; 
        const matches = text.matchAll(distRegex);
        
        let count = 0;
        for (const match of matches) {
            const distance = parseFloat(match[0]);
            count++;
            
            // Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ø§Ø³Ù… (Ø§Ù„Ù†Øµ Ø§Ù„Ù…Ø­ÙŠØ· Ø¨Ø§Ù„Ù…Ø³Ø§ÙØ©)
            const index = match.index;
            const surrounding = text.substring(index - 50, index).trim();
            const name = surrounding.split('\n').pop().replace(/[0-9]/g, '').trim() || "Racer " + count;

            // Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…ÙˆÙ‚Ø¹
            const totalD = L.latLng(start).distanceTo(L.latLng(end)) / 1000;
            const ratio = Math.min(distance / totalD, 1);
            const pos = [
                start[0] + (end[0] - start[0]) * ratio,
                start[1] + (end[1] - start[1]) * ratio
            ];

            // Ø¥Ø¶Ø§ÙØ© Ù„Ù„Ø®Ø±ÙŠØ·Ø© ÙˆØ§Ù„Ø¬Ø¯ÙˆÙ„
            const m = L.marker(pos, {
                icon: L.divIcon({ html: 'ğŸ•Šï¸', className: 'p-icon', iconSize:[20,20] })
            }).addTo(map).bindPopup(name);
            markers.push(m);

            tbody.innerHTML += `<tr>
                <td>${count}</td>
                <td>${name}</td>
                <td style="color:#3b82f6; font-weight:bold;">${distance}</td>
                <td>ğŸ“</td>
            </tr>`;
        }

        document.getElementById('totalCount').innerText = count;
        if(markers.length > 0) {
            map.fitBounds(new L.featureGroup(markers).getBounds(), {padding:[40,40]});
        }
    }

    initMap();
</script>
</body>
</html>
